# å‰ç«¯æŠ€èƒ½ä½¿ç”¨æµç¨‹ç®€å›¾

## ğŸ¯ æ ¸å¿ƒæµç¨‹ï¼ˆ3æ­¥ï¼‰

```
1. åŠ è½½æŠ€èƒ½åˆ—è¡¨
   â””â”€> GET /user-skills/battle/{playerCharacterCode}/active
   
2. ç‚¹å‡»æŠ€èƒ½ â†’ éªŒè¯
   â””â”€> POST /user-skills/{skillId}/use
   â””â”€> è¿”å›ï¼š{ manaCost, effectPayload, target }
   
3. åº”ç”¨æ•ˆæœ
   â””â”€> è§£æ effectPayload
   â””â”€> æ ¹æ® type è°ƒç”¨å¯¹åº”çš„æ•ˆæœå‡½æ•°
   â””â”€> æ›´æ–°æˆ˜æ–—çŠ¶æ€ï¼ˆHPã€æ³•åŠ›å€¼ç­‰ï¼‰
```

---

## ğŸ“ æœ€å°å®ç°ä»£ç 

### 1. æ·»åŠ APIæ–¹æ³•ï¼ˆ`frontend/api/request.ts`ï¼‰

```typescript
export const skillApi = {
  // ... ç°æœ‰æ–¹æ³• ...
  
  // è·å–æˆ˜æ–—å¯ç”¨ä¸»åŠ¨æŠ€èƒ½
  async getActiveSkillsForBattle(playerCharacterCode: string) {
    return await apiClient.get(`/user-skills/battle/${playerCharacterCode}/active`)
  },
  
  // ä½¿ç”¨æŠ€èƒ½
  async useSkill(skillId: number, currentMana: number) {
    return await apiClient.post(`/user-skills/${skillId}/use`, { currentMana })
  }
}
```

### 2. åœ¨Game Storeä¸­æ·»åŠ ï¼ˆ`frontend/stores/game.ts`ï¼‰

```typescript
// çŠ¶æ€
const availableSkills = ref<Array<{
  id: number
  name: string
  effectPayload: string
  manaCost: number
}>>([])

// åŠ è½½æŠ€èƒ½
async function loadBattleSkills(playerCharacterCode: string) {
  const res = await skillApi.getActiveSkillsForBattle(playerCharacterCode)
  if (res.data.code === 200) {
    availableSkills.value = res.data.data.map((s: any) => {
      const effect = JSON.parse(s.effectPayload || '{}')
      return {
        id: s.id,
        name: s.name,
        effectPayload: s.effectPayload,
        manaCost: effect.mana_cost ?? effect.action_cost ?? 1
      }
    })
  }
}

// ä½¿ç”¨æŠ€èƒ½
async function useSkill(skillId: number) {
  if (mana.value < availableSkills.value.find(s => s.id === skillId)?.manaCost || 1) {
    log('æ³•åŠ›å€¼ä¸è¶³')
    return false
  }
  
  const res = await skillApi.useSkill(skillId, mana.value)
  if (res.data.code === 200) {
    const data = res.data.data
    mana.value -= data.manaCost
    
    // è§£æå¹¶åº”ç”¨æ•ˆæœ
    const effect = JSON.parse(data.effectPayload)
    if (effect.type === 'heal') {
      heroHP.value += effect.heal_amount || 0
    } else if (effect.type === 'attack') {
      enemyHP.value -= effect.damage || 0
    }
    // ... å…¶ä»–æ•ˆæœç±»å‹
    
    log(`ä½¿ç”¨æŠ€èƒ½ï¼š${data.skillName}`)
    return true
  }
  return false
}
```

### 3. åœ¨æˆ˜æ–—ç•Œé¢æ˜¾ç¤ºï¼ˆ`frontend/pages/battle/battle.vue`ï¼‰

```vue
<template>
  <!-- æŠ€èƒ½æŒ‰é’®åŒºåŸŸ -->
  <view class="skills-bar">
    <view
      v-for="skill in game.availableSkills"
      :key="skill.id"
      class="skill-btn"
      :class="{ 'disabled': mana < skill.manaCost }"
      @click="game.useSkill(skill.id)"
    >
      <text class="skill-cost">{{ skill.manaCost }}</text>
      <text class="skill-name">{{ skill.name }}</text>
    </view>
  </view>
</template>

<script setup>
// æˆ˜æ–—å¼€å§‹æ—¶åŠ è½½æŠ€èƒ½
onLoad(async () => {
  const playerChar = useCampStore().playerCharacter
  if (playerChar?.playerCharacterCode) {
    await game.loadBattleSkills(playerChar.playerCharacterCode)
  }
})
</script>
```

---

## ğŸ”‘ å…³é”®ç‚¹

1. **æŠ€èƒ½åˆ—è¡¨**ï¼šæˆ˜æ–—å¼€å§‹æ—¶ä»APIåŠ è½½
2. **æŠ€èƒ½ä½¿ç”¨**ï¼šç‚¹å‡» â†’ APIéªŒè¯ â†’ æ¶ˆè€—æ³•åŠ›å€¼ â†’ åº”ç”¨æ•ˆæœ
3. **æ•ˆæœåº”ç”¨**ï¼šè§£æ`effectPayload`ï¼Œæ ¹æ®`type`è°ƒç”¨å¯¹åº”å‡½æ•°
4. **å¤ç”¨é€»è¾‘**ï¼šæŠ€èƒ½æ•ˆæœåº”ç”¨é€»è¾‘ä¸å¡ç‰Œæ•ˆæœç›¸åŒ

---

**è¯¦ç»†å®ç°è¯·å‚è€ƒï¼š** `å‰ç«¯æŠ€èƒ½ä½¿ç”¨å®Œæ•´å®ç°æŒ‡å—.md`

