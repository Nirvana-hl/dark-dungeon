# å¡ç‰Œè§’è‰²ç‰¹æ€§æ¥å£ä½¿ç”¨è¯´æ˜

> åˆ›å»ºæ—¥æœŸï¼š2025-12-04  
> æ¥å£è·¯å¾„ï¼š`GET /api/card-characters/{id}/traits`

---

## ğŸ“‹ æ¥å£è¯´æ˜

### åŠŸèƒ½
è·å–æŒ‡å®šå¡ç‰Œè§’è‰²çš„æ‰€æœ‰ç‰¹æ€§é…ç½®ï¼ŒåŒ…æ‹¬åŸºç¡€æ•ˆæœå‚æ•°ï¼ˆ`effectPayload`ï¼‰å’Œæ˜Ÿçº§ç¼©æ”¾é…ç½®ï¼ˆ`scalingPayload`ï¼‰ã€‚

### ç”¨é€”
- å‰ç«¯å¯ä»¥åŠ¨æ€è·å–å¡ç‰Œè§’è‰²çš„ç‰¹æ€§æ•°æ®
- æ ¹æ®è§’è‰²çš„å½“å‰æ˜Ÿçº§è®¡ç®—å®é™…æ•ˆæœå€¼
- åœ¨æˆ˜æ–—ç³»ç»Ÿä¸­æ‰§è¡Œç‰¹æ€§æ•ˆæœï¼ˆå¦‚æ²»ç–—ã€æŠ¤ç›¾ç­‰ï¼‰

---

## ğŸ”— æ¥å£è¯¦æƒ…

### è¯·æ±‚
```
GET /api/card-characters/{id}/traits
```

**è·¯å¾„å‚æ•°**ï¼š
- `id`ï¼šå¡ç‰Œè§’è‰²IDï¼ˆå¿…å¡«ï¼‰

**ç¤ºä¾‹**ï¼š
```
GET http://localhost:8080/api/card-characters/1/traits
```

### å“åº”

#### æˆåŠŸå“åº”ï¼ˆ200ï¼‰
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": [
    {
      "id": 1,
      "cardCharacterId": 1,
      "name": "æ˜Ÿè¾‰ç¥ç¦",
      "type": "positive",
      "effectPayload": "{\"heal_allies\": 2}",
      "scalingPayload": "{\"2\": {\"heal_allies\": 3}, \"3\": {\"heal_allies\": 4}, \"4\": {\"heal_allies\": 5}}",
      "description": "æå‡å…¨é˜Ÿæ²»ç–—é‡"
    }
  ]
}
```

#### é”™è¯¯å“åº”ï¼ˆ404ï¼‰
```json
{
  "code": 404,
  "message": "å¡ç‰Œè§’è‰²ä¸å­˜åœ¨",
  "data": null
}
```

---

## ğŸ“Š å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | Long | ç‰¹æ€§ID |
| `cardCharacterId` | Long | å¡ç‰Œè§’è‰²æ¨¡æ¿ID |
| `name` | String | ç‰¹æ€§åç§°ï¼ˆå¦‚ï¼šæ˜Ÿè¾‰ç¥ç¦ã€é’¢é“æŠ¤ç›¾ï¼‰ |
| `type` | String | ç‰¹æ€§ç±»å‹ï¼š`positive`ï¼ˆæ­£é¢ï¼‰ã€`negative`ï¼ˆè´Ÿé¢ï¼‰ã€`neutral`ï¼ˆä¸­æ€§ï¼‰ |
| `effectPayload` | String | **åŸºç¡€æ•ˆæœå‚æ•°ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰**<br>ä¾‹å¦‚ï¼š`{"heal_allies": 2}` è¡¨ç¤ºåŸºç¡€æ²»ç–—å‹æ–¹2ç‚¹ç”Ÿå‘½ |
| `scalingPayload` | String | **æ˜Ÿçº§ç¼©æ”¾é…ç½®ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰**<br>ä¾‹å¦‚ï¼š`{"2": {"heal_allies": 3}}` è¡¨ç¤º2æ˜Ÿæ—¶æ²»ç–—é‡å˜ä¸º3 |
| `description` | String | ç‰¹æ€§æè¿° |

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šè·å–"æ˜Ÿè¾‰ç¥­å¸"çš„ç‰¹æ€§

**è¯·æ±‚**ï¼š
```
GET /api/card-characters/1/traits
```

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": [
    {
      "id": 1,
      "cardCharacterId": 1,
      "name": "æ˜Ÿè¾‰ç¥ç¦",
      "type": "positive",
      "effectPayload": "{\"heal_allies\": 2}",
      "scalingPayload": "{\"2\": {\"heal_allies\": 3}, \"3\": {\"heal_allies\": 4}, \"4\": {\"heal_allies\": 5}}",
      "description": "æå‡å…¨é˜Ÿæ²»ç–—é‡"
    }
  ]
}
```

**å‰ç«¯è§£æé€»è¾‘**ï¼ˆä¼ªä»£ç ï¼‰ï¼š
```javascript
// 1. è§£æ effectPayload
const baseEffect = JSON.parse(trait.effectPayload)
// baseEffect = { heal_allies: 2 }

// 2. è§£æ scalingPayload
const scaling = JSON.parse(trait.scalingPayload)
// scaling = { "2": { heal_allies: 3 }, "3": { heal_allies: 4 }, "4": { heal_allies: 5 } }

// 3. æ ¹æ®è§’è‰²å½“å‰æ˜Ÿçº§è®¡ç®—å®é™…æ•ˆæœå€¼
const starLevel = userCardCharacter.currentStarLevel // å‡è®¾ä¸º3æ˜Ÿ
let actualHealAmount = baseEffect.heal_allies // åŸºç¡€å€¼ï¼š2

if (scaling[starLevel.toString()] && scaling[starLevel.toString()].heal_allies) {
  actualHealAmount = scaling[starLevel.toString()].heal_allies
}
// 3æ˜Ÿæ—¶ï¼ŒactualHealAmount = 4

// 4. åœ¨æˆ˜æ–—ä¸­æ‰§è¡Œæ²»ç–—æ•ˆæœ
board.forEach(ally => {
  ally.health = Math.min(ally.health + actualHealAmount, ally.maxHealth)
})
```

### ç¤ºä¾‹2ï¼šè·å–"é‡ç”²ç›¾å«"çš„ç‰¹æ€§

**è¯·æ±‚**ï¼š
```
GET /api/card-characters/2/traits
```

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": [
    {
      "id": 2,
      "cardCharacterId": 2,
      "name": "é’¢é“æŠ¤ç›¾",
      "type": "positive",
      "effectPayload": "{\"armor_bonus\": 3}",
      "scalingPayload": "{\"2\": {\"armor_bonus\": 5}, \"3\": {\"armor_bonus\": 8}}",
      "description": "æä¾›é¢å¤–æŠ¤ç”²"
    }
  ]
}
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. ç¡®ä¿æ•°æ®åº“æœ‰æµ‹è¯•æ•°æ®

æ£€æŸ¥ `card_character_traits` è¡¨æ˜¯å¦æœ‰æ•°æ®ï¼š
```sql
SELECT * FROM card_character_traits;
```

å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œå¯ä»¥æ‰§è¡Œæµ‹è¯•æ•°æ®æ’å…¥è„šæœ¬ï¼š
```sql
INSERT INTO card_character_traits (card_character_id, name, type, effect_payload, scaling_payload, description) 
VALUES
(1, 'æ˜Ÿè¾‰ç¥ç¦', 'positive', '{"heal_allies": 2}', 
 '{"2": {"heal_allies": 3}, "3": {"heal_allies": 4}, "4": {"heal_allies": 5}}',
 'æå‡å…¨é˜Ÿæ²»ç–—é‡');
```

### 2. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd backend
mvn spring-boot:run
```

### 3. æµ‹è¯•æ¥å£

ä½¿ç”¨ Postmanã€Apifox æˆ– curlï¼š

```bash
# æµ‹è¯•è·å–IDä¸º1çš„å¡ç‰Œè§’è‰²ç‰¹æ€§
curl http://localhost:8080/api/card-characters/1/traits

# æµ‹è¯•ä¸å­˜åœ¨çš„å¡ç‰Œè§’è‰²ï¼ˆåº”è¯¥è¿”å›404ï¼‰
curl http://localhost:8080/api/card-characters/999/traits
```

### 4. éªŒè¯å“åº”

- âœ… æˆåŠŸæ—¶è¿”å›ç‰¹æ€§åˆ—è¡¨ï¼ŒåŒ…å« `effectPayload` å’Œ `scalingPayload`
- âœ… å¡ç‰Œè§’è‰²ä¸å­˜åœ¨æ—¶è¿”å› 404 é”™è¯¯
- âœ… JSON æ ¼å¼æ­£ç¡®ï¼Œå¯ä»¥æ­£å¸¸è§£æ

---

## ğŸ”§ åç»­å¼€å‘å»ºè®®

### å‰ç«¯é›†æˆï¼ˆå¾…å®ç°ï¼‰

1. **åŠ è½½ç‰¹æ€§æ•°æ®**ï¼š
   ```typescript
   async function loadCardCharacterTraits(cardCharacterId: number) {
     const response = await apiClient.get(`/card-characters/${cardCharacterId}/traits`)
     return response.data.data
   }
   ```

2. **è§£ææ•ˆæœå€¼**ï¼š
   ```typescript
   function calculateTraitEffect(trait: CardCharacterTraitDTO, starLevel: number): number {
     const baseEffect = JSON.parse(trait.effectPayload)
     const scaling = JSON.parse(trait.scalingPayload)
     
     // æ ¹æ®æ˜Ÿçº§è·å–ç¼©æ”¾å€¼
     if (scaling[starLevel.toString()]) {
       return scaling[starLevel.toString()].heal_allies || baseEffect.heal_allies
     }
     return baseEffect.heal_allies
   }
   ```

3. **æˆ˜æ–—ä¸­ä½¿ç”¨**ï¼š
   ```typescript
   function applyTraitsAtTurnStart() {
     board.value.forEach(character => {
       const traits = await loadCardCharacterTraits(character.cardCharacterId)
       traits.forEach(trait => {
         const effect = calculateTraitEffect(trait, character.stars)
         // æ‰§è¡Œæ•ˆæœ...
       })
     })
   }
   ```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **JSON å­—ç¬¦ä¸²è§£æ**ï¼š
   - `effectPayload` å’Œ `scalingPayload` éƒ½æ˜¯ JSON å­—ç¬¦ä¸²ï¼Œå‰ç«¯éœ€è¦å…ˆ `JSON.parse()` æ‰èƒ½ä½¿ç”¨

2. **æ˜Ÿçº§åŒ¹é…**ï¼š
   - `scalingPayload` ä¸­çš„é”®æ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼ˆå¦‚ `"2"`ã€`"3"`ï¼‰ï¼Œä¸æ˜¯æ•°å­—
   - å‰ç«¯éœ€è¦å°†æ˜Ÿçº§è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ¥åŒ¹é…

3. **é»˜è®¤å€¼å¤„ç†**ï¼š
   - å¦‚æœæŸä¸ªæ˜Ÿçº§æ²¡æœ‰åœ¨ `scalingPayload` ä¸­é…ç½®ï¼Œä½¿ç”¨ `effectPayload` ä¸­çš„åŸºç¡€å€¼

4. **ç©ºåˆ—è¡¨å¤„ç†**ï¼š
   - å¦‚æœå¡ç‰Œè§’è‰²æ²¡æœ‰ç‰¹æ€§ï¼Œæ¥å£è¿”å›ç©ºæ•°ç»„ `[]`ï¼Œè€Œä¸æ˜¯ `null`

---

**æœ€åæ›´æ–°**ï¼š2025-12-04

