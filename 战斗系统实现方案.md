# æš—é»‘åœ°ç‰¢ - æˆ˜æ–—ç³»ç»Ÿå®žçŽ°æ–¹æ¡ˆ

> **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
> **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-XX  
> **é€‚ç”¨èŒƒå›´**ï¼šå‰åŽç«¯å¼€å‘äººå‘˜

---

## ðŸ“‹ ç›®å½•

1. [æˆ˜æ–—ç³»ç»Ÿæ¦‚è¿°](#æˆ˜æ–—ç³»ç»Ÿæ¦‚è¿°)
2. [æˆ˜æ–—æµç¨‹è¯¦è§£](#æˆ˜æ–—æµç¨‹è¯¦è§£)
3. [å‰åŽç«¯äº¤äº’æµç¨‹](#å‰åŽç«¯äº¤äº’æµç¨‹)
4. [æ•°æ®åº“è¡¨æŸ¥è¯¢æ¸…å•](#æ•°æ®åº“è¡¨æŸ¥è¯¢æ¸…å•)
5. [æŽ¥å£è°ƒç”¨æ¸…å•](#æŽ¥å£è°ƒç”¨æ¸…å•)
6. [å…³é”®å®žçŽ°ç»†èŠ‚](#å…³é”®å®žçŽ°ç»†èŠ‚)

---

## æˆ˜æ–—ç³»ç»Ÿæ¦‚è¿°

### æ ¸å¿ƒæ¦‚å¿µ

æˆ˜æ–—ç³»ç»Ÿæ˜¯åœ°ç‰¢æŽ¢ç´¢çš„æ ¸å¿ƒçŽ©æ³•ï¼Œé‡‡ç”¨**å›žåˆåˆ¶è‡ªåŠ¨æˆ˜æ–—**æ¨¡å¼ï¼š
- **è§¦å‘æ–¹å¼**ï¼šåœ¨åœ°ç‰¢æŽ¢ç´¢è¿‡ç¨‹ä¸­éšæœºé­é‡æ•Œäºº
- **æˆ˜æ–—æ¨¡å¼**ï¼šåŽç«¯æ¨¡æ‹Ÿæˆ˜æ–—ï¼Œå‰ç«¯å±•ç¤ºç»“æžœ
- **ç­–ç•¥é€‰æ‹©**ï¼šçŽ©å®¶å¯é€‰æ‹©æˆ˜æ–—ç­–ç•¥ï¼ˆaggressive/defensiveï¼‰ï¼Œå½±å“æˆ˜æ–—ç»“æžœ
- **çŠ¶æ€æŒä¹…åŒ–**ï¼šæˆ˜æ–—ç»“æžœä¼šæ›´æ–°è§’è‰²çŠ¶æ€ï¼ˆè¡€é‡ã€åŽ‹åŠ›ï¼‰ï¼Œå¹¶ä¿å­˜åˆ°æ•°æ®åº“

### ç³»ç»Ÿæž¶æž„

```
å‰ç«¯ï¼ˆVue 3ï¼‰         åŽç«¯ï¼ˆSpring Bootï¼‰        æ•°æ®åº“
    â”‚                      â”‚                      â”‚
    â”‚â”€â”€æŽ¢ç´¢è¯·æ±‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
    â”‚                      â”‚â”€â”€æŸ¥è¯¢ runs â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                      â”‚â”€â”€æŸ¥è¯¢ stages â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                      â”‚â”€â”€æŸ¥è¯¢ enemies â”€â”€â”€â”€â”€>â”‚
    â”‚<â”€â”€è¿”å›žæŽ¢ç´¢ç»“æžœâ”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
    â”‚                      â”‚                      â”‚
    â”‚â”€â”€æˆ˜æ–—ç»“ç®—è¯·æ±‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
    â”‚                      â”‚â”€â”€æŸ¥è¯¢ user_player   â”‚
    â”‚                      â”‚     _characters â”€â”€â”€â”€>â”‚
    â”‚                      â”‚â”€â”€æŸ¥è¯¢ enemies â”€â”€â”€â”€â”€>â”‚
    â”‚                      â”‚â”€â”€æ¨¡æ‹Ÿæˆ˜æ–—è®¡ç®—       â”‚
    â”‚                      â”‚â”€â”€æ›´æ–° user_player   â”‚
    â”‚                      â”‚     _characters â”€â”€â”€â”€>â”‚
    â”‚                      â”‚â”€â”€æ›´æ–° runs â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚<â”€â”€è¿”å›žæˆ˜æ–—ç»“æžœâ”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
```

---

## æˆ˜æ–—æµç¨‹è¯¦è§£

### é˜¶æ®µ1ï¼šå¼€å§‹æŽ¢ç´¢ï¼ˆè¥åœ° â†’ åœ°ç‰¢ï¼‰

**å‰ç«¯æ“ä½œ**ï¼š
1. çŽ©å®¶åœ¨è¥åœ°ç•Œé¢é€‰æ‹©å…³å¡
2. é€‰æ‹©è¦ä½¿ç”¨çš„è§’è‰²ï¼ˆ`user_player_character_id`ï¼‰
3. é€‰æ‹©æºå¸¦çš„å¡ç‰Œè§’è‰²ï¼ˆ`card_character_ids`ï¼‰å’Œæ³•æœ¯/è£…å¤‡å¡ï¼ˆ`card_ids`ï¼‰
4. ç‚¹å‡»"å¼€å§‹æŽ¢ç´¢"æŒ‰é’®

**åŽç«¯å¤„ç†**ï¼š
1. éªŒè¯å…³å¡æ˜¯å¦è§£é”ï¼ˆæŸ¥è¯¢ `user_stage_progress`ï¼‰
2. éªŒè¯è§’è‰²å½’å±žï¼ˆæŸ¥è¯¢ `user_player_characters`ï¼‰
3. åˆ›å»ºæŽ¢ç´¢è®°å½•ï¼ˆæ’å…¥ `runs` è¡¨ï¼‰
4. åˆå§‹åŒ–æŽ¢ç´¢è¿›åº¦ï¼ˆ`current_stage_progress` JSONï¼‰

### é˜¶æ®µ2ï¼šåœ°ç‰¢æŽ¢ç´¢ï¼ˆæŽ¢ç´¢æ¨¡å¼ï¼‰

**å‰ç«¯æ“ä½œ**ï¼š
1. æ˜¾ç¤ºåœ°ç‰¢åœ°å›¾å’Œå½“å‰æˆ¿é—´
2. çŽ©å®¶ç‚¹å‡»"æŽ¢ç´¢"æŒ‰é’®

**åŽç«¯å¤„ç†**ï¼š
1. éšæœºå†³å®šè§¦å‘äº‹ä»¶æˆ–é­é‡æ•Œäºº
2. å¦‚æžœè§¦å‘äº‹ä»¶ï¼šæŸ¥è¯¢ `events` è¡¨ï¼Œæ‰§è¡Œäº‹ä»¶æ•ˆæžœ
3. å¦‚æžœé­é‡æ•Œäººï¼šä»Ž `stages.enemy_pool` æˆ– `enemies` è¡¨éšæœºé€‰æ‹©æ•Œäºº
4. æ›´æ–° `runs.current_stage_progress`ï¼Œè®¾ç½® `awaiting_battle = true`

### é˜¶æ®µ3ï¼šæˆ˜æ–—è§¦å‘ï¼ˆæŽ¢ç´¢ â†’ æˆ˜æ–—ï¼‰

**å‰ç«¯æ“ä½œ**ï¼š
1. æ£€æµ‹åˆ° `battlePending = true`
2. æ˜¾ç¤ºæ•Œäººä¿¡æ¯ï¼ˆåç§°ã€éš¾åº¦ï¼‰
3. æ˜¾ç¤ºæˆ˜æ–—ç­–ç•¥é€‰æ‹©ç•Œé¢ï¼ˆaggressive/defensive/é»˜è®¤ï¼‰

**åŽç«¯çŠ¶æ€**ï¼š
- `runs.current_stage_progress.status = "awaiting_battle"`
- `runs.current_stage_progress.pending_enemy_id` å·²è®¾ç½®

### é˜¶æ®µ4ï¼šæˆ˜æ–—ç»“ç®—ï¼ˆæˆ˜æ–—è®¡ç®—ï¼‰

**å‰ç«¯æ“ä½œ**ï¼š
1. çŽ©å®¶é€‰æ‹©æˆ˜æ–—ç­–ç•¥ï¼ˆå¯é€‰ï¼‰
2. ç‚¹å‡»"å¼€å§‹æˆ˜æ–—"æŒ‰é’®

**åŽç«¯å¤„ç†**ï¼š
1. æŸ¥è¯¢å½“å‰è§’è‰²çŠ¶æ€ï¼ˆ`user_player_characters`ï¼‰
2. æŸ¥è¯¢æ•Œäººæ•°æ®ï¼ˆ`enemies`ï¼‰
3. æ‰§è¡Œæˆ˜æ–—æ¨¡æ‹Ÿè®¡ç®—
4. æ›´æ–°è§’è‰²çŠ¶æ€ï¼ˆè¡€é‡ã€åŽ‹åŠ›ï¼‰
5. æ›´æ–°æŽ¢ç´¢è¿›åº¦ï¼ˆæˆ˜æ–—æ—¥å¿—ã€å‡»è´¥æ•Œäººæ•°ï¼‰
6. åˆ¤æ–­æˆ˜æ–—ç»“æžœï¼ˆvictory/defeatï¼‰

### é˜¶æ®µ5ï¼šæˆ˜æ–—åŽå¤„ç†

**èƒœåˆ©æƒ…å†µ**ï¼š
- è§’è‰²è¡€é‡æ›´æ–°ä¸ºæˆ˜æ–—åŽå‰©ä½™è¡€é‡
- åŽ‹åŠ›å€¼ +3ï¼ˆç´¯ç§¯ï¼‰
- å‡»è´¥æ•Œäººæ•° +1
- ç»§ç»­æŽ¢ç´¢æ¨¡å¼ï¼ˆ`status = "exploring"`ï¼‰

**å¤±è´¥æƒ…å†µ**ï¼š
- æŽ¢ç´¢ç»“æŸï¼ˆ`result = "defeat"`ï¼‰
- è®°å½•å°è¯•æ¬¡æ•°ï¼ˆ`user_stage_progress.attempt_count`ï¼‰
- è¿”å›žè¥åœ°ç•Œé¢

---

## å‰åŽç«¯äº¤äº’æµç¨‹

### 1. å¼€å§‹æŽ¢ç´¢

**å‰ç«¯è°ƒç”¨**ï¼š
```typescript
POST /dungeons/runs/start
Authorization: Bearer {token}
Content-Type: application/json

{
  "stageNumber": 1,
  "userPlayerCharacterId": 123,
  "cardCharacterIds": [1, 2, 3],
  "cardIds": [10, 11, 12],
  "consumableItemIds": [5, 6]
}
```

**åŽç«¯å¤„ç†**ï¼š
1. **æŸ¥è¯¢ `user_stage_progress`**ï¼šæ£€æŸ¥å…³å¡æ˜¯å¦è§£é”
   - WHERE `user_id = ?` AND `stage_number = ?` AND `is_unlocked = 1`
2. **æŸ¥è¯¢ `user_player_characters`**ï¼šéªŒè¯è§’è‰²å½’å±ž
   - WHERE `id = ?` AND `user_id = ?`
3. **æŸ¥è¯¢ `stages`**ï¼šèŽ·å–å…³å¡ä¿¡æ¯
   - WHERE `stage_number = ?`
4. **æ’å…¥ `runs`**ï¼šåˆ›å»ºæŽ¢ç´¢è®°å½•
   - è®¾ç½® `preparation_snapshot`ï¼ˆJSONæ ¼å¼ï¼‰
   - è®¾ç½® `current_stage_progress`ï¼ˆåˆå§‹çŠ¶æ€JSONï¼‰

**è¿”å›žæ•°æ®**ï¼š
```json
{
  "code": 200,
  "message": "æŽ¢ç´¢å·²å¼€å¯",
  "data": {
    "id": 456,
    "stageNumber": 1,
    "chapterNumber": 1,
    "status": "exploring",
    "progress": {
      "status": "exploring",
      "currentRoom": "Entrance",
      "exploredRooms": 0,
      "defeatedEnemies": 0
    }
  }
}
```

---

### 2. æŽ¢ç´¢æˆ¿é—´

**å‰ç«¯è°ƒç”¨**ï¼š
```typescript
POST /dungeons/runs/{runId}/explore
Authorization: Bearer {token}
Content-Type: application/json

{
  "action": "explore"  // å¯é€‰ï¼šexplore/event
}
```

**åŽç«¯å¤„ç†**ï¼š
1. **æŸ¥è¯¢ `runs`**ï¼šèŽ·å–å½“å‰æŽ¢ç´¢è®°å½•
   - WHERE `id = ?` AND `user_id = ?` AND `result IS NULL`
2. **æŸ¥è¯¢ `stages`**ï¼šèŽ·å–å…³å¡é…ç½®
   - WHERE `stage_number = ?`
3. **éšæœºå†³å®šäº‹ä»¶æˆ–æˆ˜æ–—**ï¼š
   - **å¦‚æžœè§¦å‘äº‹ä»¶**ï¼š
     - æŸ¥è¯¢ `events` è¡¨
     - WHERE `location_type = 'dungeon'` AND æ»¡è¶³ `trigger_condition`
     - æ ¹æ® `trigger_chance` åˆ¤æ–­æ˜¯å¦è§¦å‘
   - **å¦‚æžœé­é‡æ•Œäºº**ï¼š
     - ä»Ž `stages.enemy_pool`ï¼ˆJSONæ•°ç»„ï¼‰éšæœºé€‰æ‹© `enemy_id`
     - æˆ–æŸ¥è¯¢ `enemies` è¡¨ï¼šWHERE `difficulty = ?`
     - è°ƒç”¨ `pickEnemyForStage()` æ–¹æ³•
4. **æ›´æ–° `runs.current_stage_progress`**ï¼š
   - å¦‚æžœé­é‡æ•Œäººï¼šè®¾ç½® `awaiting_battle = true`ï¼Œ`pending_enemy_id = ?`
   - å¢žåŠ  `explored_rooms` è®¡æ•°

**è¿”å›žæ•°æ®**ï¼š
```json
{
  "code": 200,
  "message": "é­é‡æ•Œäººï¼šéª·é«…æˆ˜å£«",
  "data": {
    "run": { /* æ›´æ–°åŽçš„æŽ¢ç´¢è®°å½• */ },
    "message": "é­é‡æ•Œäººï¼šéª·é«…æˆ˜å£«",
    "battlePending": true,
    "eventSummary": null
  }
}
```

---

### 3. æˆ˜æ–—ç»“ç®—ï¼ˆæ ¸å¿ƒæŽ¥å£ï¼‰

**å‰ç«¯è°ƒç”¨**ï¼š
```typescript
POST //dungeons/runs/{runId}/battle
Authorization: Bearer {token}
Content-Type: application/json

{
  "strategy": "aggressive"  // å¯é€‰ï¼šaggressive/defensive/nullï¼ˆé»˜è®¤ï¼‰
}
```

**åŽç«¯å¤„ç†æµç¨‹**ï¼š

#### æ­¥éª¤1ï¼šéªŒè¯æˆ˜æ–—çŠ¶æ€
1. **æŸ¥è¯¢ `runs`**ï¼šèŽ·å–æŽ¢ç´¢è®°å½•
   - WHERE `id = ?` AND `user_id = ?` AND `result IS NULL`
2. **è§£æž `current_stage_progress` JSON**ï¼š
   - æ£€æŸ¥ `awaiting_battle = true`
   - èŽ·å– `pending_enemy_id`

#### æ­¥éª¤2ï¼šèŽ·å–æˆ˜æ–—æ•°æ®
1. **æŸ¥è¯¢ `enemies`**ï¼šèŽ·å–æ•Œäººä¿¡æ¯
   - WHERE `id = ?`
   - è¯»å– `base_stats`ï¼ˆJSONæ ¼å¼ï¼ŒåŒ…å« hpã€attack ç­‰ï¼‰
2. **æŸ¥è¯¢ `user_player_characters`**ï¼šèŽ·å–è§’è‰²çŠ¶æ€
   - WHERE `id = ?` AND `user_id = ?`
   - è¯»å– `current_hp`ã€`max_hp`ã€`max_action_points`ã€`current_stress`

#### æ­¥éª¤3ï¼šæ‰§è¡Œæˆ˜æ–—æ¨¡æ‹Ÿ
- è°ƒç”¨ `simulateBattle()` æ–¹æ³•
- æ ¹æ®ç­–ç•¥è°ƒæ•´å±žæ€§ï¼š
  - `aggressive`ï¼šæ”»å‡»åŠ› +5ï¼Œè¡€é‡ -5
  - `defensive`ï¼šæ•Œäººæ”»å‡»åŠ› -2
- æ¨¡æ‹Ÿå›žåˆåˆ¶æˆ˜æ–—ï¼ˆæœ€å¤š20å›žåˆï¼‰
- ç”Ÿæˆæˆ˜æ–—æ—¥å¿—

#### æ­¥éª¤4ï¼šæ›´æ–°è§’è‰²çŠ¶æ€
1. **æ›´æ–° `user_player_characters`**ï¼š
   - `current_hp = battleResult.heroRemainingHp`
   - `current_stress = min(hero.currentStress + 3, 100)`
   - WHERE `id = ?` AND `user_id = ?`

#### æ­¥éª¤5ï¼šæ›´æ–°æŽ¢ç´¢è¿›åº¦
1. **æ›´æ–° `runs.current_stage_progress`**ï¼š
   - æ·»åŠ æˆ˜æ–—æ—¥å¿—åˆ° `battle_log` æ•°ç»„
   - å¦‚æžœèƒœåˆ©ï¼š`defeated_enemies + 1`ï¼Œ`awaiting_battle = false`ï¼Œ`status = "exploring"`
   - å¦‚æžœå¤±è´¥ï¼š`status = "completed"`ï¼Œ`result = "defeat"`
2. **æ›´æ–° `runs`**ï¼š
   - å¦‚æžœå¤±è´¥ï¼šè®¾ç½® `result = "defeat"`ï¼Œ`ended_at = NOW()`
3. **æ›´æ–° `user_stage_progress`**ï¼ˆå¦‚æžœå¤±è´¥ï¼‰ï¼š
   - `attempt_count + 1`
   - WHERE `user_id = ?` AND `stage_number = ?`

**è¿”å›žæ•°æ®**ï¼š
```json
{
  "code": 200,
  "message": "æˆ˜æ–—å·²ç»“ç®—ï¼Œç»“æžœï¼švictory",
  "data": {
    "run": { /* æ›´æ–°åŽçš„æŽ¢ç´¢è®°å½• */ },
    "message": "æˆ˜æ–—å·²ç»“ç®—ï¼Œç»“æžœï¼švictory",
    "battleResult": {
      "outcome": "victory",
      "enemyName": "éª·é«…æˆ˜å£«",
      "heroRemainingHp": 65,
      "enemyRemainingHp": 0,
      "battleLog": [
        "ç¬¬1å›žåˆï¼šçŽ©å®¶é€ æˆ 12 ç‚¹ä¼¤å®³ã€‚æ•Œäººå‰©ä½™ 68 HPã€‚",
        "ç¬¬1å›žåˆï¼šæ•Œäººé€ æˆ 8 ç‚¹ä¼¤å®³ã€‚çŽ©å®¶å‰©ä½™ 92 HPã€‚",
        "..."
      ]
    },
    "battlePending": false
  }
}
```

---

### 4. ç»“æŸæŽ¢ç´¢

**å‰ç«¯è°ƒç”¨**ï¼š
```typescript
POST //dungeons/runs/{runId}/end
Authorization: Bearer {token}
Content-Type: application/json

{
  "result": "victory",  // victory/defeat/abandon
  "rewardChoice": {     // å¯é€‰
    "gold": 200,
    "experience": 100
  }
}
```

**åŽç«¯å¤„ç†**ï¼š
1. **æŸ¥è¯¢ `runs`**ï¼šèŽ·å–æŽ¢ç´¢è®°å½•
2. **æ›´æ–° `runs`**ï¼š
   - è®¾ç½® `result`ã€`ended_at`ã€`reward_snapshot`
3. **æ›´æ–° `user_stage_progress`**ï¼š
   - å¦‚æžœèƒœåˆ©ï¼š`is_passed = 1`ï¼Œ`passed_at = NOW()`ï¼Œè§£é”ä¸‹ä¸€å…³
   - å¢žåŠ  `attempt_count`

---

## æ•°æ®åº“è¡¨æŸ¥è¯¢æ¸…å•

### æˆ˜æ–—ç³»ç»Ÿæ¶‰åŠçš„æ ¸å¿ƒè¡¨

| è¡¨å | ç”¨é€” | æŸ¥è¯¢åœºæ™¯ |
|------|------|----------|
| **runs** | æŽ¢ç´¢è®°å½• | æŸ¥è¯¢å½“å‰æŽ¢ç´¢ã€æ›´æ–°æŽ¢ç´¢è¿›åº¦ |
| **stages** | å…³å¡æ¨¡æ¿ | èŽ·å–å…³å¡é…ç½®ã€æ•Œäººæ± ã€äº‹ä»¶æ±  |
| **enemies** | æ•Œäººæ¨¡æ¿ | èŽ·å–æ•Œäººå±žæ€§ã€æˆ˜æ–—è®¡ç®— |
| **user_player_characters** | çŽ©å®¶è§’è‰²å®žä¾‹ | èŽ·å–è§’è‰²çŠ¶æ€ã€æ›´æ–°æˆ˜æ–—åŽçŠ¶æ€ |
| **user_stage_progress** | å…³å¡è¿›åº¦ | æ£€æŸ¥è§£é”çŠ¶æ€ã€è®°å½•å°è¯•æ¬¡æ•° |
| **events** | éšæœºäº‹ä»¶ | è§¦å‘åœ°ç‰¢äº‹ä»¶ |

### è¯¦ç»†æŸ¥è¯¢è¯´æ˜Ž

#### 1. `runs` è¡¨æŸ¥è¯¢

**æŸ¥è¯¢å½“å‰æŽ¢ç´¢**ï¼š
- **æ–¹æ³•**ï¼š`RunMapper.selectCurrentRun(userId)`
- **SQLé€»è¾‘**ï¼š`WHERE user_id = ? AND result IS NULL`
- **ç”¨é€”**ï¼šèŽ·å–è¿›è¡Œä¸­çš„æŽ¢ç´¢è®°å½•

**æŸ¥è¯¢æŽ¢ç´¢è¯¦æƒ…**ï¼š
- **æ–¹æ³•**ï¼š`RunMapper.selectById(runId)`
- **SQLé€»è¾‘**ï¼š`WHERE id = ? AND user_id = ?`
- **ç”¨é€”**ï¼šèŽ·å–æŽ¢ç´¢è®°å½•è¯¦æƒ…

**æ›´æ–°æŽ¢ç´¢è¿›åº¦**ï¼š
- **æ–¹æ³•**ï¼š`RunMapper.updateById(run)`
- **æ›´æ–°å­—æ®µ**ï¼š`current_stage_progress`ï¼ˆJSONæ ¼å¼ï¼‰

#### 2. `enemies` è¡¨æŸ¥è¯¢

**æ ¹æ®IDæŸ¥è¯¢**ï¼š
- **æ–¹æ³•**ï¼š`EnemyMapper.selectById(enemyId)`
- **SQLé€»è¾‘**ï¼š`WHERE id = ?`
- **ç”¨é€”**ï¼šèŽ·å–æ•ŒäººåŸºç¡€å±žæ€§ï¼ˆ`base_stats` JSONï¼‰

**æ ¹æ®éš¾åº¦æŸ¥è¯¢**ï¼š
- **æ–¹æ³•**ï¼š`EnemyMapper.selectByDifficulty(difficulty)`
- **SQLé€»è¾‘**ï¼š`WHERE difficulty = ?`
- **ç”¨é€”**ï¼šä»Žæ•Œäººæ± éšæœºé€‰æ‹©æ•Œäºº

#### 3. `user_player_characters` è¡¨æŸ¥è¯¢

**æŸ¥è¯¢è§’è‰²çŠ¶æ€**ï¼š
- **æ–¹æ³•**ï¼š`UserPlayerCharacterService.getUserPlayerCharacterById(id, userId)`
- **SQLé€»è¾‘**ï¼š`WHERE id = ? AND user_id = ?`
- **ç”¨é€”**ï¼šèŽ·å–æˆ˜æ–—å‰çš„è§’è‰²çŠ¶æ€ï¼ˆè¡€é‡ã€è¡ŒåŠ¨ç‚¹ã€åŽ‹åŠ›ï¼‰

**æ›´æ–°è§’è‰²çŠ¶æ€**ï¼š
- **æ–¹æ³•**ï¼š`UserPlayerCharacterService.updateUserPlayerCharacter()`
- **æ›´æ–°å­—æ®µ**ï¼š`current_hp`ã€`current_stress`
- **ç”¨é€”**ï¼šæˆ˜æ–—åŽæ›´æ–°è§’è‰²çŠ¶æ€

#### 4. `stages` è¡¨æŸ¥è¯¢

**æ ¹æ®å…³å¡ç¼–å·æŸ¥è¯¢**ï¼š
- **æ–¹æ³•**ï¼š`StageService.getStageByNumber(stageNumber)`
- **SQLé€»è¾‘**ï¼š`WHERE stage_number = ?`
- **ç”¨é€”**ï¼šèŽ·å–å…³å¡é…ç½®ï¼ˆ`enemy_pool`ã€`event_pool` ç­‰ï¼‰

#### 5. `user_stage_progress` è¡¨æŸ¥è¯¢

**æ£€æŸ¥å…³å¡è§£é”**ï¼š
- **æ–¹æ³•**ï¼š`UserStageProgressMapper.selectByUserIdAndStageNumber(userId, stageNumber)`
- **SQLé€»è¾‘**ï¼š`WHERE user_id = ? AND stage_number = ?`
- **ç”¨é€”**ï¼šéªŒè¯å…³å¡æ˜¯å¦è§£é”ï¼ˆ`is_unlocked = 1`ï¼‰

**è®°å½•å°è¯•æ¬¡æ•°**ï¼š
- **æ–¹æ³•**ï¼š`UserStageProgressService.recordStageAttempt()`
- **æ›´æ–°å­—æ®µ**ï¼š`attempt_count + 1`

**é€šè¿‡å…³å¡**ï¼š
- **æ–¹æ³•**ï¼š`UserStageProgressService.passStage()`
- **æ›´æ–°å­—æ®µ**ï¼š`is_passed = 1`ï¼Œ`passed_at = NOW()`ï¼Œè§£é”ä¸‹ä¸€å…³

#### 6. `events` è¡¨æŸ¥è¯¢

**è§¦å‘éšæœºäº‹ä»¶**ï¼š
- **æ–¹æ³•**ï¼š`EventService.triggerRandomDungeonEvent(stageNumber, chapterNumber)`
- **SQLé€»è¾‘**ï¼š`WHERE location_type = 'dungeon' AND æ»¡è¶³ trigger_condition`
- **ç”¨é€”**ï¼šæ ¹æ®è§¦å‘æ¡ä»¶å’Œæ¦‚çŽ‡éšæœºé€‰æ‹©äº‹ä»¶

---

## æŽ¥å£è°ƒç”¨æ¸…å•

### å‰ç«¯éœ€è¦è°ƒç”¨çš„æŽ¥å£

| æŽ¥å£è·¯å¾„ | æ–¹æ³• | ç”¨é€” | è°ƒç”¨æ—¶æœº |
|---------|------|------|----------|
| `/dungeons/runs/start` | POST | å¼€å§‹æŽ¢ç´¢ | è¥åœ°é€‰æ‹©å…³å¡åŽ |
| `/dungeons/runs/current` | GET | èŽ·å–å½“å‰æŽ¢ç´¢ | è¿›å…¥åœ°ç‰¢ç•Œé¢æ—¶ |
| `/dungeons/runs/{runId}/explore` | POST | æŽ¢ç´¢æˆ¿é—´ | ç‚¹å‡»"æŽ¢ç´¢"æŒ‰é’® |
| `/dungeons/runs/{runId}/battle` | POST | æˆ˜æ–—ç»“ç®— | é­é‡æ•ŒäººåŽç‚¹å‡»"æˆ˜æ–—" |
| `/dungeons/runs/{runId}/end` | POST | ç»“æŸæŽ¢ç´¢ | å®Œæˆå…³å¡æˆ–æ”¾å¼ƒæŽ¢ç´¢ |

### åŽç«¯å†…éƒ¨è°ƒç”¨çš„Serviceæ–¹æ³•

| Serviceæ–¹æ³• | ç”¨é€” | æ¶‰åŠçš„æ•°æ®åº“è¡¨ |
|------------|------|--------------|
| `DungeonService.startRun()` | åˆ›å»ºæŽ¢ç´¢è®°å½• | `runs`ã€`stages`ã€`user_stage_progress`ã€`user_player_characters` |
| `DungeonService.explore()` | æŽ¢ç´¢æˆ¿é—´ | `runs`ã€`stages`ã€`enemies`ã€`events` |
| `DungeonService.resolveBattle()` | æˆ˜æ–—ç»“ç®— | `runs`ã€`enemies`ã€`user_player_characters`ã€`user_stage_progress` |
| `DungeonService.finishRun()` | ç»“æŸæŽ¢ç´¢ | `runs`ã€`user_stage_progress` |
| `DungeonService.simulateBattle()` | æˆ˜æ–—æ¨¡æ‹Ÿè®¡ç®— | æ— ï¼ˆçº¯è®¡ç®—é€»è¾‘ï¼‰ |

---

## å…³é”®å®žçŽ°ç»†èŠ‚

### 1. æˆ˜æ–—æ¨¡æ‹Ÿç®—æ³•

**ä½ç½®**ï¼š`DungeonService.simulateBattle()`

**é€»è¾‘**ï¼š
1. ä»Ž `enemies.base_stats` JSON è§£æžæ•Œäººå±žæ€§ï¼ˆhpã€attackï¼‰
2. ä»Ž `user_player_characters` èŽ·å–è§’è‰²å±žæ€§
3. æ ¹æ®ç­–ç•¥è°ƒæ•´å±žæ€§ï¼š
   - `aggressive`ï¼š`heroAttack += 5`ï¼Œ`heroHp -= 5`
   - `defensive`ï¼š`enemyAttack -= 2`
4. æ¨¡æ‹Ÿå›žåˆåˆ¶æˆ˜æ–—ï¼ˆæœ€å¤š20å›žåˆï¼‰ï¼š
   - æ¯å›žåˆï¼šçŽ©å®¶æ”»å‡» â†’ æ•Œäººæ”»å‡»
   - ä¼¤å®³è®¡ç®—ï¼šåŸºç¡€å€¼ + éšæœºæ³¢åŠ¨
5. ç”Ÿæˆæˆ˜æ–—æ—¥å¿—
6. è¿”å›žæˆ˜æ–—ç»“æžœï¼ˆvictory/defeatï¼‰

### 2. æŽ¢ç´¢è¿›åº¦JSONç»“æž„

**å­—æ®µ**ï¼š`runs.current_stage_progress`ï¼ˆJSONæ ¼å¼ï¼‰

**ç»“æž„**ï¼š
```json
{
  "status": "exploring" | "awaiting_battle" | "completed",
  "currentRoom": "Room-1",
  "exploredRooms": 3,
  "defeatedEnemies": 2,
  "eventLog": ["äº‹ä»¶1", "äº‹ä»¶2"],
  "battleLog": ["æˆ˜æ–—æ—¥å¿—1", "æˆ˜æ–—æ—¥å¿—2"],
  "awaitingBattle": false,
  "pendingEnemyId": 123,
  "pendingEnemyName": "éª·é«…æˆ˜å£«",
  "pendingEnemyDifficulty": "normal"
}
```

### 3. æ•Œäººé€‰æ‹©é€»è¾‘

**ä½ç½®**ï¼š`DungeonService.pickEnemyForStage()`

**ä¼˜å…ˆçº§**ï¼š
1. ä¼˜å…ˆä»Ž `stages.enemy_pool`ï¼ˆJSONæ•°ç»„ï¼‰éšæœºé€‰æ‹©
2. å¦‚æžœ `enemy_pool` ä¸ºç©ºï¼Œæ ¹æ®å…³å¡éš¾åº¦æŸ¥è¯¢ `enemies` è¡¨
3. å¦‚æžœä»æ— ç»“æžœï¼Œéšæœºé€‰æ‹©ä»»æ„æ•Œäºº

### 4. åŽ‹åŠ›ç³»ç»Ÿ

**å½“å‰å®žçŽ°**ï¼š
- æˆ˜æ–—åŽåŽ‹åŠ›å€¼ +3
- åŽ‹åŠ›å€¼ä¸Šé™ 100
- åŽ‹åŠ›å€¼è·¨å…³å¡æŒç»­ç´¯ç§¯ï¼ˆä¸é‡ç½®ï¼‰

**æœªæ¥æ‰©å±•**ï¼š
- æ ¹æ®åŽ‹åŠ›å±‚çº§ï¼ˆ1-4ï¼‰è§¦å‘debuff
- æŸ¥è¯¢ `stress_debuff_configs` è¡¨åº”ç”¨debuffæ•ˆæžœ

### 5. æˆ˜æ–—ç»“æžœå¤„ç†

**èƒœåˆ©**ï¼š
- è§’è‰²è¡€é‡æ›´æ–°ä¸ºæˆ˜æ–—åŽå‰©ä½™å€¼
- åŽ‹åŠ›å€¼ +3
- å‡»è´¥æ•Œäººæ•° +1
- ç»§ç»­æŽ¢ç´¢ï¼ˆ`status = "exploring"`ï¼‰

**å¤±è´¥**ï¼š
- æŽ¢ç´¢ç»“æŸï¼ˆ`result = "defeat"`ï¼‰
- è®°å½•å°è¯•æ¬¡æ•°
- è¿”å›žè¥åœ°ç•Œé¢

---

## æ³¨æ„äº‹é¡¹

### 1. äº‹åŠ¡ç®¡ç†
- `startRun()`ã€`explore()`ã€`resolveBattle()`ã€`finishRun()` éƒ½ä½¿ç”¨ `@Transactional`
- ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

### 2. æƒé™éªŒè¯
- æ‰€æœ‰æŽ¥å£éƒ½éœ€è¦éªŒè¯ `user_id`ï¼Œç¡®ä¿ç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„æ•°æ®
- ä½¿ç”¨ JWT Token ä»Žè¯·æ±‚å¤´èŽ·å– `userId`

### 3. çŠ¶æ€æ£€æŸ¥
- æˆ˜æ–—ç»“ç®—å‰å¿…é¡»æ£€æŸ¥ `awaiting_battle = true`
- æŽ¢ç´¢å‰å¿…é¡»æ£€æŸ¥ `result IS NULL`ï¼ˆæœªç»“æŸï¼‰

### 4. JSONå­—æ®µå¤„ç†
- `current_stage_progress`ã€`preparation_snapshot`ã€`reward_snapshot` éƒ½æ˜¯JSONæ ¼å¼
- ä½¿ç”¨ FastJSON2 è¿›è¡Œåºåˆ—åŒ–/ååºåˆ—åŒ–

### 5. é”™è¯¯å¤„ç†
- å¦‚æžœæ•Œäººæ•°æ®ç¼ºå¤±ï¼Œè·³è¿‡æˆ˜æ–—å¹¶é‡ç½®çŠ¶æ€
- å¦‚æžœè§’è‰²ä¸å­˜åœ¨ï¼ŒæŠ›å‡ºå¼‚å¸¸

---

## æ€»ç»“

æˆ˜æ–—ç³»ç»Ÿçš„æ ¸å¿ƒæµç¨‹ï¼š
1. **å¼€å§‹æŽ¢ç´¢** â†’ åˆ›å»º `runs` è®°å½•
2. **æŽ¢ç´¢æˆ¿é—´** â†’ å¯èƒ½è§¦å‘äº‹ä»¶æˆ–é­é‡æ•Œäºº
3. **æˆ˜æ–—ç»“ç®—** â†’ æŸ¥è¯¢è§’è‰²å’Œæ•Œäººæ•°æ®ï¼Œæ¨¡æ‹Ÿæˆ˜æ–—ï¼Œæ›´æ–°çŠ¶æ€
4. **æˆ˜æ–—åŽå¤„ç†** â†’ æ›´æ–°è§’è‰²çŠ¶æ€å’ŒæŽ¢ç´¢è¿›åº¦
5. **ç»“æŸæŽ¢ç´¢** â†’ æ›´æ–°å…³å¡è¿›åº¦å’Œå¥–åŠ±

**å…³é”®æ•°æ®åº“æ“ä½œ**ï¼š
- æŸ¥è¯¢ï¼š`runs`ã€`enemies`ã€`user_player_characters`ã€`stages`ã€`user_stage_progress`
- æ›´æ–°ï¼š`runs.current_stage_progress`ã€`user_player_characters.current_hp`ã€`user_stage_progress`

**å…³é”®æŽ¥å£**ï¼š
- `POST /dungeons/runs/start` - å¼€å§‹æŽ¢ç´¢
- `POST /dungeons/runs/{runId}/explore` - æŽ¢ç´¢æˆ¿é—´
- `POST /dungeons/runs/{runId}/battle` - æˆ˜æ–—ç»“ç®—ï¼ˆæ ¸å¿ƒï¼‰
- `POST /dungeons/runs/{runId}/end` - ç»“æŸæŽ¢ç´¢

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šæœ¬æ–‡æ¡£ä¼šéšç€æˆ˜æ–—ç³»ç»Ÿçš„å®Œå–„æŒç»­æ›´æ–°ã€‚

