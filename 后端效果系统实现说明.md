# 后端效果系统实现说明

> 实现日期：2025-01-XX  
> 实现目标：在后端实现法术和装备的效果逻辑，包括治疗、伤害、护盾等效果

---

## ✅ 已实现功能

### 1. 卡牌效果执行服务（CardEffectService）

创建了 `CardEffectService` 服务类，用于统一执行卡牌效果。

#### 核心功能：

1. **战斗上下文（BattleContext）**
   - 存储战斗状态：英雄和敌人的HP、攻击力、护盾值
   - 记录战斗日志
   - 支持Buff状态管理

2. **治疗效果执行**
   - 支持单体治疗（`heal`, `heal_amount`, `heal_single`）
   - 支持群体治疗（`aoe: true` 或 `target: "all_allies"`）
   - 自动处理生命值上限

3. **伤害效果执行**
   - 支持单体伤害（`damage`, `damage_single`）
   - 支持AOE伤害（`aoe: true` 或 `target: "all_enemies"`）
   - 自动处理护盾吸收伤害

4. **护盾效果执行**
   - 支持护盾值增加（`armor`, `shield`）
   - 支持单体/群体护盾

5. **Buff效果执行**
   - 支持攻击力加成（`attack_bonus`）
   - 支持防御力加成（`defense_bonus`, `defense`）

6. **特殊效果执行**
   - 吸血效果（`lifesteal`）
   - 燃烧效果（`burn`, `burn_chance`）
   - 眩晕效果（`stun`, `stun_chance`）
   - 冰冻效果（`freeze_chance`）

7. **角色特性效果执行**
   - 支持从 `card_character_traits` 表读取特性效果
   - 支持星级缩放（`scaling_payload`）
   - 支持治疗效果（`heal_allies`）
   - 支持护甲加成（`armor_bonus`）
   - 支持攻击加成（`attack_bonus`）

---

### 2. 战斗系统集成（DungeonService）

修改了 `DungeonService.simulateBattle()` 方法，集成了效果执行引擎。

#### 新增功能：

1. **卡牌效果支持**
   - 自动加载用户卡组（从 `user_cards` 表，`loadout_id = 1`）
   - 在战斗中可以随机使用卡牌
   - 根据卡牌的 `effectPayload` 执行效果

2. **角色特性支持**
   - 自动加载用户上阵的角色特性（从 `user_card_characters` 表，`is_deployed = true`）
   - 每回合开始时自动触发角色特性效果
   - 支持星级缩放计算

3. **战斗流程优化**
   - 每回合开始时触发角色特性
   - 玩家可以随机使用卡牌（如果有足够的法力值）
   - 战斗日志详细记录所有效果执行情况

---

## 📋 支持的效果格式

### 治疗效果

```json
// 格式1：旧格式
{"type": "heal_single", "heal_amount": 12}

// 格式2：新格式
{"heal": 30, "target": "all_allies"}

// 格式3：群体治疗
{"heal": 25, "target": "ally", "aoe": true}
```

### 伤害效果

```json
// 格式1：旧格式
{"type": "damage_single", "damage": 30}

// 格式2：新格式
{"damage": 60, "target": "enemy", "aoe": true}
```

### 护盾效果

```json
// 格式1
{"armor": 15, "target": "ally", "duration": 2}

// 格式2
{"shield": 25, "target": "all_allies"}
```

### 角色特性效果

```json
// 基础效果
{"heal_allies": 2}

// 星级缩放配置
{
  "2": {"heal_allies": 3},
  "3": {"heal_allies": 4},
  "4": {"heal_allies": 5}
}
```

---

## 🔧 技术实现细节

### 1. 效果执行流程

```
战斗开始
  ↓
加载用户卡组和角色特性
  ↓
每回合循环：
  ├─ 触发角色特性效果
  ├─ 玩家使用卡牌（随机）
  ├─ 执行卡牌效果
  ├─ 玩家攻击
  └─ 敌人攻击
  ↓
战斗结束
```

### 2. 效果解析逻辑

- 使用 FastJSON2 解析 `effectPayload` JSON字符串
- 兼容多种格式（旧格式和新格式）
- 自动识别目标类型（`hero`, `enemy`, `all_allies`, `all_enemies`）
- 自动处理护盾吸收伤害

### 3. 数据加载

- **用户卡组**：从 `user_cards` 表查询 `loadout_id = 1` 的卡牌
- **卡牌模板**：根据 `card_id` 从 `cards` 表获取完整信息（包括 `effectPayload`）
- **角色特性**：从 `user_card_characters` 表查询 `is_deployed = true` 的角色
- **特性配置**：根据 `card_character_id` 从 `card_character_traits` 表获取特性

---

## 📊 数据库表关系

```
user_cards (用户卡牌实例)
  └─ card_id → cards (卡牌模板)
      └─ effect_payload (效果配置)

user_card_characters (用户角色卡实例)
  └─ card_character_id → card_characters (角色模板)
      └─ card_character_traits (角色特性)
          └─ effect_payload (特性效果配置)
          └─ scaling_payload (星级缩放配置)
```

---

## 🎯 使用示例

### 示例1：治疗法术效果

数据库中的卡牌配置：
```sql
INSERT INTO cards VALUES (1, 'holy_light', '圣光术', 'spell', 'rare', 'none', 1, '{}', 
  '{"type": "heal_single", "heal_amount": 12}', ...);
```

战斗中的执行：
- 玩家使用"圣光术"
- 系统解析 `effectPayload`：`{"type": "heal_single", "heal_amount": 12}`
- 执行治疗效果：英雄恢复12点生命
- 记录战斗日志："法术：圣光术，英雄恢复 12 点生命（当前HP：85/100）"

### 示例2：角色特性治疗效果

数据库中的特性配置：
```sql
INSERT INTO card_character_traits VALUES (1, 1, '星辉祝福', 'positive', 
  '{"heal_allies": 2}', 
  '{"2": {"heal_allies": 3}, "3": {"heal_allies": 4}}', 
  '提升全队治疗量');
```

战斗中的执行：
- 每回合开始时触发特性
- 系统解析 `effectPayload`：`{"heal_allies": 2}`
- 根据角色星级计算实际效果值（1星=2，2星=3，3星=4）
- 执行治疗效果：英雄恢复对应点数的生命
- 记录战斗日志："特性：星辉祝福，英雄恢复 2 点生命"

---

## ⚠️ 注意事项

1. **兼容性**：系统同时支持旧格式和新格式的效果配置，确保向后兼容

2. **错误处理**：如果效果解析失败，会记录错误日志但不影响战斗进行

3. **数据加载**：如果用户没有卡组或角色特性，战斗会正常进行，只是不会触发额外效果

4. **性能优化**：卡牌和特性数据在战斗开始时一次性加载，避免重复查询数据库

---

## 🔮 后续优化建议

1. **Buff系统**：当前Buff效果只是记录日志，后续可以实现持续效果（如燃烧、眩晕等）

2. **AI策略**：当前卡牌使用是随机的，后续可以实现更智能的AI策略

3. **效果组合**：支持多个效果同时触发（如"治疗+护盾"）

4. **效果优先级**：定义效果执行的优先级顺序

5. **效果验证**：添加效果配置的验证逻辑，确保数据正确性

---

**实现完成时间**：2025-01-XX  
**实现者**：AI助手

