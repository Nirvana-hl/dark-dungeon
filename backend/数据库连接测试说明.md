# 数据库连接测试说明

## 📋 前置条件

1. **MySQL数据库已安装并运行**
   - 版本要求：MySQL 8.0+
   - 默认端口：3306

2. **创建数据库**
   ```sql
   CREATE DATABASE dark_dungeon CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```

3. **执行数据库初始化脚本**
   ```bash
   # 在MySQL客户端或Navicat中执行
   mysql -u root -p dark_dungeon < ../database/schema_v1_1_mysql.sql
   ```

## 🔧 配置检查

### 1. 检查 application.yml 配置

确保以下配置正确：

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/dark_dungeon?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: root
    password: 123456  # 请修改为你的MySQL密码
```

**重要提示**：
- 如果MySQL端口不是3306，请修改URL中的端口号
- 如果MySQL密码不是123456，请修改`password`字段
- 建议添加`serverTimezone`参数避免时区问题

### 2. 检查MyBatis Plus配置

已配置为使用UUID作为主键：

```yaml
mybatis-plus:
  global-config:
    db-config:
      id-type: assign_id  # 使用UUID作为主键生成策略
```

## 🧪 测试数据库连接

### 方法1：使用现有的测试接口

启动应用后，访问：
```
GET http://localhost:8080/api/test/db
```

如果返回数据库信息，说明连接成功。

### 方法2：使用数据库测试类

运行 `DatabaseConnectionTest.java`：
```bash
cd backend
mvn test -Dtest=DatabaseConnectionTest
```

### 方法3：直接测试MySQL连接

在MySQL客户端中执行：
```sql
-- 检查数据库是否存在
SHOW DATABASES LIKE 'dark_dungeon';

-- 检查表是否创建成功
USE dark_dungeon;
SHOW TABLES;

-- 应该看到以下表：
-- users
-- user_wallets
-- player_characters
-- user_player_characters
-- card_characters
-- user_card_characters
-- cards
-- user_cards
-- items
-- inventory
-- shop_offers
-- skills
-- user_player_character_skills
-- dungeons
-- runs
-- enemies
-- enemy_cards
-- events
-- player_actions
-- achievements
-- game_metrics
-- stress_debuff_configs
-- card_character_traits
```

## ⚠️ 常见问题

### 问题1：连接被拒绝
**错误信息**：`Communications link failure`

**解决方案**：
1. 检查MySQL服务是否启动
2. 检查端口号是否正确（默认3306）
3. 检查防火墙设置

### 问题2：认证失败
**错误信息**：`Access denied for user`

**解决方案**：
1. 检查用户名和密码是否正确
2. 确认用户有访问`dark_dungeon`数据库的权限

### 问题3：数据库不存在
**错误信息**：`Unknown database 'dark_dungeon'`

**解决方案**：
1. 创建数据库：`CREATE DATABASE dark_dungeon;`
2. 执行初始化脚本：`source schema_v1_1_mysql.sql`

### 问题4：时区问题
**错误信息**：`The server time zone value 'xxx' is unrecognized`

**解决方案**：
在数据库URL中添加时区参数：
```yaml
url: jdbc:mysql://localhost:3306/dark_dungeon?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
```

### 问题5：字符编码问题
**错误信息**：中文乱码

**解决方案**：
1. 确保数据库字符集为`utf8mb4`
2. 确保连接URL包含`useUnicode=true&characterEncoding=utf8`

## ✅ 验证清单

完成以下检查项，确保数据库连接正常：

- [ ] MySQL服务已启动
- [ ] 数据库`dark_dungeon`已创建
- [ ] 已执行`schema_v1_1_mysql.sql`初始化脚本
- [ ] `application.yml`中的数据库配置正确
- [ ] 可以访问`/api/test/db`接口并返回数据库信息
- [ ] 所有23张表都已创建成功

## 📝 下一步

数据库连接测试通过后，可以：

1. 启动后端服务：`mvn spring-boot:run`
2. 测试API接口（使用Postman或curl）
3. 开始实现Service层和Controller层

---

**最后更新**: 2025-01-XX | **维护者**: 后端开发团队

