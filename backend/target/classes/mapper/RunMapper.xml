<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dungeon.mapper.RunMapper">
    
    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.dungeon.entity.Run">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="user_player_character_id" property="userPlayerCharacterId" jdbcType="BIGINT"/>
        <result column="dungeon_id" property="dungeonId" jdbcType="BIGINT"/>
        <result column="stage_number" property="stageNumber" jdbcType="INTEGER"/>
        <result column="chapter_number" property="chapterNumber" jdbcType="INTEGER"/>
        <result column="difficulty" property="difficulty" jdbcType="VARCHAR"/>
        <result column="preparation_snapshot" property="preparationSnapshot" jdbcType="VARCHAR"/>
        <result column="current_stage_progress" property="currentStageProgress" jdbcType="VARCHAR"/>
        <result column="result" property="result" jdbcType="VARCHAR"/>
        <result column="started_at" property="startedAt" jdbcType="TIMESTAMP"/>
        <result column="ended_at" property="endedAt" jdbcType="TIMESTAMP"/>
        <result column="reward_snapshot" property="rewardSnapshot" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- 基础列 -->
    <sql id="Base_Column_List">
        id, user_id, user_player_character_id, dungeon_id, stage_number, chapter_number,
        difficulty, preparation_snapshot, current_stage_progress, result, 
        started_at, ended_at, reward_snapshot
    </sql>

    <!-- 根据用户ID查询探索记录 -->
    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM runs
        WHERE user_id = #{userId}
        ORDER BY started_at DESC
    </select>

    <!-- 根据用户ID和关卡编号查询探索记录 -->
    <select id="selectByUserIdAndStageNumber" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM runs
        WHERE user_id = #{userId}
        AND stage_number = #{stageNumber}
        ORDER BY started_at DESC
    </select>

    <!-- 查询用户当前正在进行的探索记录（未完成的） -->
    <select id="selectCurrentRun" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM runs
        WHERE user_id = #{userId}
        AND result IS NULL
        ORDER BY started_at DESC
        LIMIT 1
    </select>

</mapper>

