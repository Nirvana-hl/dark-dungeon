# 地牢地图系统分析与实现方案

> **分析日期**：2025-01-XX  
> **分析目标**：评估现有功能是否支持"每个关卡都是地图，随机分配敌人和事件，用户移动探索时随机触发事件"的需求

---

## 📊 现有功能分析

### ✅ 数据库层面 - 完全支持

#### 1. 地图配置支持
- **`stages.exploration_map`** (JSON字段)
  - 用途：存储关卡地图配置（房间、路径、探索点）
  - 示例格式（来自测试数据）：
    ```json
    {
      "rooms": [
        {"id": 1, "type": "start"},
        {"id": 2, "type": "normal"},
        {"id": 3, "type": "event"},
        {"id": 4, "type": "end"}
      ],
      "paths": [[1, 2], [2, 3], [3, 4]]
    }
    ```
  - **状态**：✅ 字段已存在，但**后端和前端都未使用**

#### 2. 随机敌人分配支持
- **`stages.enemy_pool`** (JSON字段)
  - 用途：配置该关卡可能出现的敌人池
  - 示例格式：
    ```json
    {
      "enemies": [
        {"id": 1, "weight": 3},
        {"id": 2, "weight": 1}
      ]
    }
    ```
  - **状态**：✅ 字段已存在，✅ **后端已实现随机选择逻辑**（`DungeonService.pickEnemyForStage()`）

#### 3. 随机事件分配支持
- **`stages.event_pool`** (JSON字段)
  - 用途：配置该关卡可能触发的事件池
  - **状态**：✅ 字段已存在
- **`events` 表**
  - `trigger_condition` (JSON)：触发条件（关卡范围、章节等）
  - `trigger_chance` (DECIMAL)：触发概率（0.00-1.00）
  - **状态**：✅ 字段已存在，✅ **后端已实现随机触发逻辑**（`EventService.triggerRandomDungeonEvent()`）

---

### ⚠️ 后端层面 - 部分支持

#### ✅ 已实现功能

1. **随机敌人选择**
   - 位置：`DungeonService.pickEnemyForStage(Stage stage)`
   - 逻辑：
     - 优先从 `stage.enemy_pool` JSON 中读取敌人ID列表
     - 如果为空，则根据关卡难度从 `enemies` 表查询
     - 随机选择一个敌人返回
   - **状态**：✅ 已实现

2. **随机事件触发**
   - 位置：`EventService.triggerRandomDungeonEvent(Integer stageNumber, Integer chapterNumber)`
   - 逻辑：
     - 查询所有 `location_type = 'dungeon'` 的事件
     - 根据 `trigger_condition` 筛选（关卡范围、章节匹配）
     - 根据 `trigger_chance` 概率判断是否触发
     - 随机返回一个符合条件的事件
   - **状态**：✅ 已实现

3. **探索接口**
   - 位置：`DungeonController.explore()` → `DungeonService.explore()`
   - 功能：
     - 接收探索请求
     - 随机决定触发事件或遭遇敌人（50%概率）
     - 更新探索进度（`current_stage_progress`）
   - **状态**：✅ 已实现，但**是线性探索**（只计数房间，不基于地图）

#### ❌ 缺失功能

1. **地图数据读取**
   - 问题：`DungeonService` 没有读取 `stage.exploration_map` 字段
   - 影响：无法知道地图结构、房间位置、路径连接
   - **需要实现**：解析 `exploration_map` JSON，返回地图结构给前端

2. **基于地图的探索**
   - 问题：当前探索是线性的（`exploredRooms++`），不基于实际地图
   - 影响：无法实现"移动到某个房间"、"选择路径"等地图探索功能
   - **需要实现**：
     - 记录玩家当前位置（房间ID）
     - 验证移动路径是否合法
     - 根据房间类型决定触发内容（事件/敌人/空房间）

3. **房间类型处理**
   - 问题：地图中有 `start`、`normal`、`event`、`end`、`boss` 等房间类型，但后端未区分处理
   - **需要实现**：根据房间类型决定触发逻辑

---

### ❌ 前端层面 - 未实现

#### 当前状态

1. **`Explore.vue` 界面**
   - 功能：关卡选择、关卡信息展示、战斗日志
   - **问题**：没有地图可视化，没有移动探索功能
   - 代码位置：`frontend/src/views/Explore.vue`

2. **地图生成**
   - **问题**：前端没有地图渲染组件
   - **需要实现**：
     - 地图可视化组件（房间、路径、玩家位置）
     - 移动交互（点击房间移动、路径高亮）
     - 探索动画和反馈

---

## 🎯 需求实现评估

### 需求1：每个关卡都是一个地图
- **数据库支持**：✅ `stages.exploration_map` 字段已存在
- **后端支持**：❌ 未读取和使用地图数据
- **前端支持**：❌ 没有地图可视化
- **结论**：**需要开发**，但数据结构已准备好

### 需求2：随机分配敌人和事件
- **数据库支持**：✅ `enemy_pool`、`event_pool` 字段已存在
- **后端支持**：✅ 已实现随机选择逻辑
- **前端支持**：✅ 不需要前端处理
- **结论**：**已完全支持** ✅

### 需求3：用户移动探索地牢时随机触发事件
- **数据库支持**：✅ `events` 表支持触发条件和概率
- **后端支持**：✅ 已实现随机触发逻辑，但**不是基于地图移动**
- **前端支持**：❌ 没有地图移动界面
- **结论**：**部分支持**，需要改为基于地图的探索

### 需求4：地图能否由前端生成
- **答案**：✅ **可以，且推荐由前端生成**
- **理由**：
  1. 后端只存储地图配置（JSON），不负责渲染
  2. 前端可以根据 `exploration_map` JSON 数据动态生成地图
  3. 前端生成可以更好地控制视觉效果和交互体验
  4. 减少后端压力，提高响应速度

---

## 🚀 实现方案

### 方案概述

采用**前后端分离**的架构：
- **后端**：提供地图配置数据、处理探索逻辑、随机触发事件/敌人
- **前端**：根据配置生成地图、处理移动交互、展示探索结果

### 第一阶段：后端增强（必须）

#### 1.1 地图数据读取接口

**新增接口**：`GET /stages/{stageNumber}/map`

**功能**：返回关卡地图配置

**返回格式**：
```json
{
  "code": 200,
  "data": {
    "stageNumber": 1,
    "stageName": "初始地牢",
    "map": {
      "rooms": [
        {"id": 1, "type": "start", "x": 0, "y": 0, "name": "入口"},
        {"id": 2, "type": "normal", "x": 100, "y": 0, "name": "房间1"},
        {"id": 3, "type": "event", "x": 200, "y": 0, "name": "事件房间"},
        {"id": 4, "type": "end", "x": 300, "y": 0, "name": "出口"}
      ],
      "paths": [
        {"from": 1, "to": 2},
        {"from": 2, "to": 3},
        {"from": 3, "to": 4}
      ]
    }
  }
}
```

**实现位置**：`StageController` 新增方法

#### 1.2 基于地图的探索接口增强

**修改接口**：`POST /dungeons/runs/{runId}/explore`

**新增参数**：
```json
{
  "targetRoomId": 2,  // 目标房间ID（可选，不传则随机移动）
  "action": "move"    // 操作类型：move/explore/event
}
```

**逻辑改进**：
1. 读取 `stage.exploration_map`，解析地图结构
2. 验证 `targetRoomId` 是否可达（检查路径）
3. 根据目标房间类型决定触发内容：
   - `start`：入口，不触发
   - `normal`：随机触发事件或敌人
   - `event`：必定触发事件
   - `boss`：必定触发Boss战斗
   - `end`：到达出口，完成关卡
4. 更新 `current_stage_progress`，记录当前房间ID

**实现位置**：`DungeonService.explore()` 方法重构

#### 1.3 探索进度结构增强

**修改**：`RunProgressState` 内部类

**新增字段**：
```java
private Integer currentRoomId;        // 当前房间ID
private List<Integer> visitedRooms;   // 已访问的房间ID列表
private Map<Integer, String> roomStatus; // 房间状态（explored/cleared/locked）
```

---

### 第二阶段：前端地图系统（必须）

#### 2.1 地图组件开发

**新建组件**：`frontend/src/components/DungeonMap.vue`

**功能**：
- 接收地图配置（rooms、paths）
- 渲染房间节点（根据类型显示不同图标/颜色）
- 渲染路径连接线
- 显示玩家当前位置
- 处理房间点击（移动到目标房间）

**房间类型样式**：
- `start`：绿色，入口图标
- `normal`：灰色，普通房间图标
- `event`：蓝色，事件图标
- `boss`：红色，Boss图标
- `end`：金色，出口图标

#### 2.2 探索界面重构

**修改文件**：`frontend/src/views/Explore.vue`

**新增功能**：
1. 进入关卡时，调用 `GET /stages/{stageNumber}/map` 获取地图配置
2. 使用 `DungeonMap` 组件渲染地图
3. 玩家点击房间时，调用 `POST /dungeons/runs/{runId}/explore` 移动
4. 根据返回结果（事件/敌人）显示弹窗或跳转战斗

**界面布局**：
```
┌─────────────────────────────────────┐
│  关卡信息：第1关 - 初始地牢          │
├─────────────────────────────────────┤
│                                     │
│        [地图区域 - DungeonMap]      │
│                                     │
├─────────────────────────────────────┤
│  探索日志 | 当前房间 | 已击败敌人    │
└─────────────────────────────────────┘
```

#### 2.3 地图生成算法（前端）

**位置**：`frontend/src/utils/mapGenerator.ts`（新建工具文件）

**功能**：
- 如果后端返回的 `exploration_map` 没有坐标（x, y），前端自动计算布局
- 使用力导向算法或网格布局算法生成房间位置
- 确保路径不重叠、房间不重叠

**算法选择**：
- **简单关卡**（房间数 < 10）：网格布局（Grid Layout）
- **复杂关卡**（房间数 >= 10）：力导向布局（Force-Directed Layout）

---

### 第三阶段：优化与扩展（可选）

#### 3.1 地图编辑器（策划工具）

**功能**：允许策划在后端管理界面编辑 `exploration_map` JSON

**实现**：简单的JSON编辑器或可视化地图编辑器

#### 3.2 地图预览

**功能**：在关卡选择界面显示地图缩略图

**实现**：使用 `DungeonMap` 组件，设置为只读模式

#### 3.3 探索动画

**功能**：玩家移动时显示路径动画、房间探索动画

**实现**：使用 CSS 动画或 Canvas 动画

---

## 📝 数据库配置示例

### 完整的地图配置示例

```json
{
  "rooms": [
    {
      "id": 1,
      "type": "start",
      "name": "入口",
      "x": 0,
      "y": 0,
      "description": "地牢的入口，从这里开始探索"
    },
    {
      "id": 2,
      "type": "normal",
      "name": "走廊",
      "x": 100,
      "y": 0,
      "description": "一条阴暗的走廊"
    },
    {
      "id": 3,
      "type": "event",
      "name": "神秘房间",
      "x": 200,
      "y": 0,
      "description": "这里可能触发随机事件"
    },
    {
      "id": 4,
      "type": "normal",
      "name": "战斗房间",
      "x": 300,
      "y": 0,
      "description": "可能遭遇敌人"
    },
    {
      "id": 5,
      "type": "boss",
      "name": "Boss房间",
      "x": 400,
      "y": 0,
      "description": "Boss战"
    },
    {
      "id": 6,
      "type": "end",
      "name": "出口",
      "x": 500,
      "y": 0,
      "description": "完成关卡"
    }
  ],
  "paths": [
    {"from": 1, "to": 2},
    {"from": 2, "to": 3},
    {"from": 2, "to": 4},
    {"from": 3, "to": 5},
    {"from": 4, "to": 5},
    {"from": 5, "to": 6}
  ],
  "layout": "linear"  // 布局类型：linear/branching/grid
}
```

---

## ✅ 总结

### 现有功能支持情况

| 需求 | 数据库 | 后端 | 前端 | 总体 |
|------|--------|------|------|------|
| 每个关卡都是地图 | ✅ | ❌ | ❌ | ⚠️ 需要开发 |
| 随机分配敌人 | ✅ | ✅ | N/A | ✅ 已支持 |
| 随机分配事件 | ✅ | ✅ | N/A | ✅ 已支持 |
| 移动探索触发事件 | ✅ | ⚠️ 部分 | ❌ | ⚠️ 需要改进 |
| 前端生成地图 | N/A | N/A | ❌ | ⚠️ 需要开发 |

### 开发优先级

1. **P0（必须）**：后端地图数据读取接口
2. **P0（必须）**：后端基于地图的探索逻辑
3. **P0（必须）**：前端地图组件开发
4. **P0（必须）**：前端探索界面重构
5. **P1（重要）**：前端地图自动布局算法
6. **P2（可选）**：地图编辑器、预览、动画

### 预计工作量

- **后端开发**：2-3天
- **前端开发**：3-4天
- **测试与优化**：1-2天
- **总计**：6-9天

---

## 🔗 相关文件

- 数据库表结构：`database/add_stage_system.sql`
- 测试数据：`database/insert_stage_test_data.sql`
- 后端服务：`backend/src/main/java/com/dungeon/service/DungeonService.java`
- 事件服务：`backend/src/main/java/com/dungeon/service/EventService.java`
- 前端探索界面：`frontend/src/views/Explore.vue`

---

**最后更新**：2025-01-XX  
**维护者**：项目团队

