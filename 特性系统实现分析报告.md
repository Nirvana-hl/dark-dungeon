# ç‰¹æ€§ç³»ç»Ÿå®ç°åˆ†ææŠ¥å‘Š

> åˆ†ææ—¥æœŸï¼š2025-01-XX  
> åˆ†æç›®æ ‡ï¼šè£…å¤‡ã€æ³•æœ¯ã€è§’è‰²å¡ç‰Œçš„ç‰¹æ€§èƒ½å¦æˆåŠŸç”Ÿæ•ˆï¼Œç‰¹åˆ«æ˜¯æ²»ç–—æ•ˆæœç­‰

---

## ğŸ“‹ ä¸€ã€æ•°æ®åº“è¡¨ç»“æ„åˆ†æ

### 1.1 ç‰¹æ€§ç›¸å…³çš„æ•°æ®è¡¨

é¡¹ç›®ä¸­å­˜åœ¨**ä¸‰å¥—ç‰¹æ€§/æ•ˆæœç³»ç»Ÿ**ï¼Œåˆ†åˆ«ç”¨äºä¸åŒçš„å¡ç‰Œç±»å‹ï¼š

#### **è¡¨1ï¼š`card_character_traits`**ï¼ˆå¡ç‰Œè§’è‰²ç‰¹æ€§ï¼‰
- **ç”¨é€”**ï¼šå­˜å‚¨å¡ç‰Œè§’è‰²ï¼ˆCardCharacterï¼‰çš„è¯¦ç»†ç‰¹æ€§é…ç½®
- **å…³é”®å­—æ®µ**ï¼š
  - `card_character_id`ï¼šå…³è”åˆ° `card_characters` è¡¨
  - `name`ï¼šç‰¹æ€§åç§°ï¼ˆå¦‚"æ˜Ÿè¾‰ç¥ç¦"ï¼‰
  - `type`ï¼šç‰¹æ€§ç±»å‹ï¼ˆpositive/negative/neutralï¼‰
  - `effect_payload`ï¼šåŸºç¡€æ•ˆæœå‚æ•°ï¼ˆJSONæ ¼å¼ï¼Œå¦‚ `{"heal_allies": 2}`ï¼‰
  - `scaling_payload`ï¼šæ˜Ÿçº§ç¼©æ”¾é…ç½®ï¼ˆJSONæ ¼å¼ï¼Œå¦‚ `{"2": {"heal_allies": 3}, "3": {"heal_allies": 4}}`ï¼‰
- **ç¤ºä¾‹æ•°æ®**ï¼š
  ```sql
  INSERT INTO `card_character_traits` VALUES 
  (1, 1, 'æ˜Ÿè¾‰ç¥ç¦', 'positive', '{"heal_allies": 2}', '{"2": {"heal_allies": 3}, "3": {"heal_allies": 4}, "4": {"heal_allies": 5}}', 'æå‡å…¨é˜Ÿæ²»ç–—é‡');
  ```

#### **è¡¨2ï¼š`cards.effect_payload`**ï¼ˆæ³•æœ¯/è£…å¤‡æ•ˆæœï¼‰
- **ç”¨é€”**ï¼šå­˜å‚¨æ³•æœ¯å’Œè£…å¤‡çš„æ•ˆæœé…ç½®ï¼ˆJSONæ ¼å¼ï¼‰
- **å…³é”®å­—æ®µ**ï¼š
  - `card_type`ï¼šå¡ç‰Œç±»å‹ï¼ˆspell-æ³•æœ¯, equipment-è£…å¤‡ï¼‰
  - `effect_payload`ï¼šæ•ˆæœé…ç½®ï¼ˆJSONæ ¼å¼ï¼‰
- **ç¤ºä¾‹æ•°æ®**ï¼š
  ```sql
  -- æ²»ç–—æ³•æœ¯
  INSERT INTO `cards` VALUES (1, 'holy_light', 'åœ£å…‰æœ¯', 'spell', 'rare', 'none', 1, '{}', '{"type": "heal_single", "heal_amount": 12}', ...);
  
  -- ç¾¤ä½“æ²»ç–—æ³•æœ¯
  INSERT INTO `cards` VALUES (36, 'mass_heal', 'ç¾¤ä½“æ²»ç–—', 'spell', 'rare', 'none', 3, '{}', '{"heal": 30, "target": "all_allies"}', ...);
  
  -- è£…å¤‡æ•ˆæœ
  INSERT INTO `cards` VALUES (4, 'blood_sword', 'è¡€åˆƒ', 'equipment', 'epic', 'weapon', 0, '{"attack": 15, "lifesteal": 0.1}', '{"type": "buff_attack", "lifesteal": true}', ...);
  ```

#### **è¡¨3ï¼š`character_traits`**ï¼ˆç©å®¶è§’è‰²ç‰¹æ€§ï¼‰
- **ç”¨é€”**ï¼šå­˜å‚¨ç©å®¶ä¸»è§’ï¼ˆPlayerCharacterï¼‰çš„ç‰¹æ€§é…ç½®
- **å…³é”®å­—æ®µ**ï¼š
  - `trait_key`ï¼šç‰¹æ€§é”®ï¼ˆå¦‚ `priest_bless`ã€`shield_guard`ï¼‰
  - `base_power`ï¼šåŸºç¡€å¨åŠ›å€¼
  - `power_per_star`ï¼šæ¯æ˜Ÿçº§å¢åŠ çš„å¨åŠ›
- **æ³¨æ„**ï¼šæ­¤è¡¨ç”¨äºç©å®¶ä¸»è§’ï¼Œä¸æ˜¯å¡ç‰Œè§’è‰²

---

## ğŸ” äºŒã€åç«¯å®ç°åˆ†æ

### 2.1 å·²å®ç°çš„æ¥å£

#### âœ… **å¡ç‰Œè§’è‰²ç‰¹æ€§æ¥å£**ï¼ˆå·²å®ç°ï¼‰
- **æ¥å£**ï¼š`GET /card-characters/{id}/traits`
- **å®ç°ç±»**ï¼š`CardCharacterController.getCardCharacterTraits()`
- **æœåŠ¡æ–¹æ³•**ï¼š`CardCharacterService.getTraitsByCardCharacterId()`
- **è¿”å›æ•°æ®**ï¼š`List<CardCharacterTraitDTO>`ï¼ŒåŒ…å« `effectPayload` å’Œ `scalingPayload`
- **æ•°æ®æ¥æº**ï¼š`card_character_traits` è¡¨
- **çŠ¶æ€**ï¼šâœ… **æ¥å£å·²å®ç°ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨**

#### âœ… **é“å…·æ•ˆæœæ¥å£**ï¼ˆå·²å®ç°ï¼‰
- **å®ç°ç±»**ï¼š`ItemService.applyItemEffect()`
- **æ”¯æŒæ•ˆæœ**ï¼š
  - âœ… æ²»ç–—æ•ˆæœï¼ˆ`heal`ï¼‰
  - âœ… å‹åŠ›å‡å°‘æ•ˆæœï¼ˆ`stress_reduce`ï¼‰
- **çŠ¶æ€**ï¼šâœ… **é“å…·æ•ˆæœå¯ä»¥æ­£å¸¸ç”Ÿæ•ˆ**

#### âš ï¸ **æ³•æœ¯/è£…å¤‡æ•ˆæœæ¥å£**ï¼ˆéƒ¨åˆ†å®ç°ï¼‰
- **é—®é¢˜**ï¼šåç«¯æ²¡æœ‰ç»Ÿä¸€çš„æ³•æœ¯/è£…å¤‡æ•ˆæœæ‰§è¡Œæ¥å£
- **å½“å‰çŠ¶æ€**ï¼š
  - æ•°æ®åº“ä¸­æœ‰ `cards.effect_payload` å­—æ®µå­˜å‚¨æ•ˆæœé…ç½®
  - ä½†æˆ˜æ–—ç³»ç»Ÿï¼ˆ`DungeonService.simulateBattle()`ï¼‰æ²¡æœ‰ä½¿ç”¨è¿™äº›æ•ˆæœ
  - å‰ç«¯æœ‰éƒ¨åˆ†ç¡¬ç¼–ç çš„æ³•æœ¯æ•ˆæœå¤„ç†

---

## ğŸ® ä¸‰ã€å‰ç«¯å®ç°åˆ†æ

### 3.1 ç‰¹æ€§æ•°æ®åŠ è½½

#### **å½“å‰å®ç°**ï¼š
```typescript
// frontend/src/stores/game.ts
async function loadCharacterTraits() {
  const response = await gameApi.getCharacterTraits()  // è°ƒç”¨ /character/traits
  // åŠ è½½çš„æ˜¯ character_traits è¡¨çš„æ•°æ®ï¼ˆç©å®¶è§’è‰²ç‰¹æ€§ï¼‰
  // è€Œä¸æ˜¯ card_character_traits è¡¨çš„æ•°æ®ï¼ˆå¡ç‰Œè§’è‰²ç‰¹æ€§ï¼‰
}
```

#### **é—®é¢˜**ï¼š
- âŒ å‰ç«¯åŠ è½½çš„æ˜¯**ç©å®¶è§’è‰²ç‰¹æ€§**ï¼ˆ`character_traits` è¡¨ï¼‰
- âŒ ä½†æˆ˜æ–—ä¸­ä½¿ç”¨çš„æ˜¯**å¡ç‰Œè§’è‰²**ï¼ˆ`card_characters` è¡¨ï¼‰
- âŒ **æ•°æ®ä¸åŒ¹é…**ï¼šå‰ç«¯æ— æ³•è·å–å¡ç‰Œè§’è‰²çš„ç‰¹æ€§é…ç½®
- âŒ **APIç¼ºå¤±**ï¼š`api.ts` ä¸­æ²¡æœ‰å®šä¹‰è°ƒç”¨ `/card-characters/{id}/traits` çš„æ–¹æ³•

### 3.2 æˆ˜æ–—ç‰¹æ€§è§¦å‘é€»è¾‘

#### **å½“å‰å®ç°**ï¼ˆç¡¬ç¼–ç ï¼‰ï¼š
```typescript
// frontend/src/stores/game.ts (206-235è¡Œ)
function applyTraitsAtTurnStart() {
  board.value.forEach(m => {
    const t = charTraits.value[m.name]  // ä» character_traits è¡¨è·å–
    switch (t.trait_key) {
      case 'priest_bless':
        // ç¡¬ç¼–ç ï¼šä¸ºå‹æ–¹å…¨ä½“æ¢å¤ç”Ÿå‘½
        board.value = board.value.map(x => ({ ...x, health: x.health + power }))
        break
      case 'shield_guard':
        // ç¡¬ç¼–ç ï¼šä¸ºä¸€ä¸ªé˜Ÿå‹æä¾›æŠ¤ç›¾
        break
    }
  })
}
```

#### **é—®é¢˜**ï¼š
1. âŒ **ç¡¬ç¼–ç ç‰¹æ€§é€»è¾‘**ï¼šæ²»ç–—ã€æŠ¤ç›¾ç­‰æ•ˆæœéƒ½æ˜¯å‰ç«¯ç¡¬ç¼–ç çš„ï¼Œæ— æ³•ä»æ•°æ®åº“åŠ¨æ€é…ç½®
2. âŒ **ç‰¹æ€§é”®ä¸åŒ¹é…**ï¼š
   - å‰ç«¯ä½¿ç”¨ `trait_key`ï¼ˆå¦‚ `priest_bless`ï¼‰æ¥åŒ¹é…ç‰¹æ€§
   - ä½†å¡ç‰Œè§’è‰²çš„ç‰¹æ€§å­˜å‚¨åœ¨ `card_character_traits` è¡¨ä¸­ï¼Œä½¿ç”¨ `effect_payload` JSON å­—æ®µ
   - **ä¸¤è€…æ— æ³•å¯¹åº”**
3. âŒ **æ— æ³•ä½¿ç”¨æ•°æ®åº“é…ç½®**ï¼š
   - æ•°æ®åº“ä¸­æœ‰ `card_character_traits` è¡¨çš„æ²»ç–—ç‰¹æ€§æ•°æ®ï¼ˆ`{"heal_allies": 2}`ï¼‰
   - ä½†å‰ç«¯æ— æ³•è·å–è¿™äº›æ•°æ®ï¼Œåªèƒ½ä½¿ç”¨ç¡¬ç¼–ç é€»è¾‘

### 3.3 æ³•æœ¯æ•ˆæœæ‰§è¡Œé€»è¾‘

#### **å½“å‰å®ç°**ï¼ˆéƒ¨åˆ†ç¡¬ç¼–ç ï¼‰ï¼š
```typescript
// frontend/src/stores/game.ts (654-675è¡Œ)
if (card.type === 'spell') {
  if (card.effect === 'fireball3') {
    // ç¡¬ç¼–ç ï¼šç«çƒæœ¯æ•ˆæœ
    // å¯¹æ•Œæ–¹è§’è‰²é€ æˆ3ç‚¹ä¼¤å®³
  }
}
```

#### **é—®é¢˜**ï¼š
1. âŒ **åªæ”¯æŒéƒ¨åˆ†æ³•æœ¯**ï¼šåªæœ‰ `fireball3` æ•ˆæœè¢«ç¡¬ç¼–ç å®ç°
2. âŒ **æ— æ³•åŠ¨æ€è¯»å–**ï¼šæ— æ³•ä» `cards.effect_payload` è¯»å–æ•ˆæœé…ç½®
3. âŒ **æ²»ç–—æ•ˆæœæœªå®ç°**ï¼šæ•°æ®åº“ä¸­æœ‰æ²»ç–—æ³•æœ¯ï¼ˆå¦‚ `holy_light`ã€`mass_heal`ï¼‰ï¼Œä½†å‰ç«¯æ²¡æœ‰å®ç°

### 3.4 è£…å¤‡æ•ˆæœæ‰§è¡Œé€»è¾‘

#### **å½“å‰å®ç°**ï¼ˆéƒ¨åˆ†ç¡¬ç¼–ç ï¼‰ï¼š
```typescript
// frontend/src/stores/game.ts (676-684è¡Œ)
if (card.type === 'equipment') {
  if (card.effect === 'teamBuffAtk1') {
    // ç¡¬ç¼–ç ï¼šæˆ˜æ——æ•ˆæœ
    board.value = board.value.map(m => ({ ...m, attack: m.attack + 1 }))
  }
}
```

#### **é—®é¢˜**ï¼š
1. âŒ **åªæ”¯æŒéƒ¨åˆ†è£…å¤‡**ï¼šåªæœ‰ `teamBuffAtk1` æ•ˆæœè¢«ç¡¬ç¼–ç å®ç°
2. âŒ **æ— æ³•åŠ¨æ€è¯»å–**ï¼šæ— æ³•ä» `cards.effect_payload` è¯»å–æ•ˆæœé…ç½®
3. âŒ **è£…å¤‡æ•ˆæœä¸å®Œæ•´**ï¼šæ•°æ®åº“ä¸­æœ‰å¤šç§è£…å¤‡æ•ˆæœï¼ˆå¦‚ `lifesteal`ã€`damage_reduction`ï¼‰ï¼Œä½†å‰ç«¯æ²¡æœ‰å®ç°

---

## âš ï¸ å››ã€æ ¸å¿ƒé—®é¢˜æ€»ç»“

### 4.1 å¡ç‰Œè§’è‰²ç‰¹æ€§æ— æ³•æ­£ç¡®å®ç°çš„åŸå› 

#### **é—®é¢˜1ï¼šå‰ç«¯APIç¼ºå¤±**
- âŒ `api.ts` ä¸­æ²¡æœ‰å®šä¹‰è°ƒç”¨ `/card-characters/{id}/traits` çš„æ–¹æ³•
- âŒ å‰ç«¯æ— æ³•è·å–å¡ç‰Œè§’è‰²çš„ç‰¹æ€§é…ç½®ï¼ˆ`effectPayload`ã€`scalingPayload`ï¼‰

#### **é—®é¢˜2ï¼šæ•°æ®æ¨¡å‹ä¸åŒ¹é…**
- âŒ å‰ç«¯ä½¿ç”¨çš„æ˜¯ `character_traits` è¡¨çš„æ•°æ®ï¼ˆç©å®¶è§’è‰²ç‰¹æ€§ï¼‰
- âŒ ä½†æˆ˜æ–—ä¸­ä½¿ç”¨çš„æ˜¯ `card_characters` è¡¨çš„æ•°æ®ï¼ˆå¡ç‰Œè§’è‰²ï¼‰
- âŒ ä¸¤å¥—ç‰¹æ€§ç³»ç»Ÿæ²¡æœ‰å…³è”

#### **é—®é¢˜3ï¼šç¡¬ç¼–ç é€»è¾‘**
- âŒ æ²»ç–—ã€æŠ¤ç›¾ç­‰ç‰¹æ€§æ•ˆæœéƒ½æ˜¯å‰ç«¯ç¡¬ç¼–ç çš„
- âŒ æ— æ³•æ ¹æ®æ•°æ®åº“é…ç½®åŠ¨æ€æ‰§è¡Œç‰¹æ€§æ•ˆæœ
- âŒ æ— æ³•æ”¯æŒæ–°çš„ç‰¹æ€§ç±»å‹ï¼ˆéœ€è¦ä¿®æ”¹å‰ç«¯ä»£ç ï¼‰

### 4.2 æ³•æœ¯æ•ˆæœæ— æ³•æ­£ç¡®å®ç°çš„åŸå› 

#### **é—®é¢˜1ï¼šæ•ˆæœæ‰§è¡Œé€»è¾‘ç¼ºå¤±**
- âŒ å‰ç«¯åªæœ‰éƒ¨åˆ†ç¡¬ç¼–ç çš„æ³•æœ¯æ•ˆæœï¼ˆå¦‚ `fireball3`ï¼‰
- âŒ æ— æ³•ä» `cards.effect_payload` åŠ¨æ€è¯»å–æ•ˆæœé…ç½®
- âŒ æ²»ç–—æ•ˆæœï¼ˆå¦‚ `holy_light`ã€`mass_heal`ï¼‰å®Œå…¨æ²¡æœ‰å®ç°

#### **é—®é¢˜2ï¼šæ•ˆæœç±»å‹ä¸ç»Ÿä¸€**
- âŒ æ•°æ®åº“ä¸­çš„æ•ˆæœæ ¼å¼å¤šæ ·ï¼š
  - `{"type": "heal_single", "heal_amount": 12}`ï¼ˆæ—§æ ¼å¼ï¼‰
  - `{"heal": 30, "target": "all_allies"}`ï¼ˆæ–°æ ¼å¼ï¼‰
- âŒ å‰ç«¯æ— æ³•ç»Ÿä¸€è§£æè¿™äº›æ ¼å¼

### 4.3 è£…å¤‡æ•ˆæœæ— æ³•æ­£ç¡®å®ç°çš„åŸå› 

#### **é—®é¢˜1ï¼šæ•ˆæœæ‰§è¡Œé€»è¾‘ç¼ºå¤±**
- âŒ å‰ç«¯åªæœ‰éƒ¨åˆ†ç¡¬ç¼–ç çš„è£…å¤‡æ•ˆæœï¼ˆå¦‚ `teamBuffAtk1`ï¼‰
- âŒ æ— æ³•ä» `cards.effect_payload` åŠ¨æ€è¯»å–æ•ˆæœé…ç½®
- âŒ å¤æ‚æ•ˆæœï¼ˆå¦‚ `lifesteal`ã€`damage_reduction`ï¼‰å®Œå…¨æ²¡æœ‰å®ç°

#### **é—®é¢˜2ï¼šè£…å¤‡ç³»ç»Ÿä¸å®Œæ•´**
- âŒ è£…å¤‡åªèƒ½é€šè¿‡ `equipCardToMinion()` æ–¹æ³•è£…å¤‡åˆ°å•ä¸ªéšä»
- âŒ æ— æ³•å¤„ç†å…¨å±€è£…å¤‡æ•ˆæœï¼ˆå¦‚ `teamBuffAtk1`ï¼‰

---

## âœ… äº”ã€è§£å†³æ–¹æ¡ˆå»ºè®®

### 5.1 çŸ­æœŸæ–¹æ¡ˆï¼ˆå¿«é€Ÿä¿®å¤ï¼‰

#### **æ­¥éª¤1ï¼šå‰ç«¯æ·»åŠ APIæ–¹æ³•**
åœ¨ `frontend/src/lib/api.ts` ä¸­æ·»åŠ ï¼š

```typescript
// å¡ç‰Œè§’è‰²ç›¸å…³ API æ–¹æ³•
export const cardCharacterApi = {
  // è·å–å¡ç‰Œè§’è‰²çš„ç‰¹æ€§åˆ—è¡¨
  async getCardCharacterTraits(cardCharacterId: number | string) {
    return await apiClient.get(`/card-characters/${cardCharacterId}/traits`)
  }
}
```

#### **æ­¥éª¤2ï¼šå‰ç«¯åŠ è½½å¡ç‰Œç‰¹æ€§**
ä¿®æ”¹ `frontend/src/stores/game.ts`ï¼Œåœ¨åŠ è½½å¡ç‰Œè§’è‰²æ—¶åŒæ—¶åŠ è½½å…¶ç‰¹æ€§ï¼š

```typescript
// å­˜å‚¨å¡ç‰Œè§’è‰²ç‰¹æ€§æ•°æ®
const cardCharacterTraits = ref<Map<number, CardCharacterTrait[]>>(new Map())

// åŠ è½½å¡ç‰Œè§’è‰²ç‰¹æ€§
async function loadCardCharacterTraits(cardCharacterId: number) {
  try {
    const response = await cardCharacterApi.getCardCharacterTraits(cardCharacterId)
    if (response.data.code === 200) {
      cardCharacterTraits.value.set(cardCharacterId, response.data.data)
    }
  } catch (error) {
    console.error('åŠ è½½å¡ç‰Œè§’è‰²ç‰¹æ€§å¤±è´¥:', error)
  }
}
```

#### **æ­¥éª¤3ï¼šä¿®æ”¹æˆ˜æ–—ç‰¹æ€§é€»è¾‘**
å°†ç¡¬ç¼–ç çš„ç‰¹æ€§é€»è¾‘æ”¹ä¸ºä»æ•°æ®åº“è¯»å–ï¼š

```typescript
function applyTraitsAtTurnStart() {
  if (board.value.length === 0) return
  board.value.forEach(m => {
    // ä» card_character_traits è¡¨è·å–ç‰¹æ€§
    const traits = cardCharacterTraits.value.get(m.cardCharacterId)
    if (!traits || traits.length === 0) return
    
    traits.forEach(trait => {
      try {
        const effect = JSON.parse(trait.effectPayload)
        const scaling = JSON.parse(trait.scalingPayload || '{}')
        
        // æ ¹æ®æ˜Ÿçº§è®¡ç®—å®é™…æ•ˆæœå€¼
        const starLevel = m.stars ?? 1
        let effectValue = effect
        
        // å¦‚æœæœ‰æ˜Ÿçº§ç¼©æ”¾é…ç½®ï¼Œä½¿ç”¨ç¼©æ”¾å€¼
        if (scaling[starLevel.toString()]) {
          effectValue = { ...effect, ...scaling[starLevel.toString()] }
        }
        
        // æ ¹æ® effect_payload æ‰§è¡Œæ•ˆæœ
        if (effectValue.heal_allies) {
          // æ²»ç–—å‹æ–¹å…¨ä½“
          const healAmount = effectValue.heal_allies
          board.value = board.value.map(x => ({ 
            ...x, 
            health: Math.min(x.health + healAmount, x.maxHealth ?? x.health) 
          }))
          log(`ç‰¹æ€§ï¼š${trait.name}ï¼Œå‹æ–¹å…¨ä½“æ¢å¤ ${healAmount} ç‚¹ç”Ÿå‘½`)
        }
        
        if (effectValue.armor_bonus) {
          // æä¾›æŠ¤ç”²åŠ æˆ
          const armorAmount = effectValue.armor_bonus
          // é€‰æ‹©ç”Ÿå‘½æœ€ä½çš„å‹æ–¹
          let idx = 0
          for (let i = 1; i < board.value.length; i++) {
            if (board.value[i].health < board.value[idx].health) idx = i
          }
          const target = board.value[idx]
          target.shield = (target.shield ?? 0) + armorAmount
          log(`ç‰¹æ€§ï¼š${trait.name}ï¼Œä¸º ${target.name} æä¾› ${armorAmount} ç‚¹æŠ¤ç”²`)
        }
      } catch (error) {
        console.error('è§£æç‰¹æ€§æ•ˆæœå¤±è´¥:', error)
      }
    })
  })
}
```

#### **æ­¥éª¤4ï¼šå®ç°æ³•æœ¯æ•ˆæœåŠ¨æ€è§£æ**
ä¿®æ”¹ `playCard()` æ–¹æ³•ï¼Œæ”¯æŒä» `effectPayload` è¯»å–æ•ˆæœï¼š

```typescript
function playCard(id: string) {
  // ... ç°æœ‰ä»£ç  ...
  
  if (card.type === 'spell') {
    // å°è¯•ä» effectPayload è¯»å–æ•ˆæœ
    if (card.effectPayload) {
      try {
        const effect = JSON.parse(card.effectPayload)
        executeSpellEffect(effect, card)
      } catch (error) {
        console.error('è§£ææ³•æœ¯æ•ˆæœå¤±è´¥:', error)
        // å›é€€åˆ°ç¡¬ç¼–ç é€»è¾‘
        if (card.effect === 'fireball3') {
          // ... ç°æœ‰ç¡¬ç¼–ç é€»è¾‘ ...
        }
      }
    } else if (card.effect === 'fireball3') {
      // å…¼å®¹æ—§ä»£ç 
      // ... ç°æœ‰ç¡¬ç¼–ç é€»è¾‘ ...
    }
  }
}

function executeSpellEffect(effect: any, card: Card) {
  // æ²»ç–—æ•ˆæœ
  if (effect.heal || effect.heal_amount) {
    const healAmount = effect.heal || effect.heal_amount
    const target = effect.target || 'ally'
    
    if (target === 'all_allies' || target === 'allies') {
      // ç¾¤ä½“æ²»ç–—
      board.value = board.value.map(x => ({ 
        ...x, 
        health: Math.min(x.health + healAmount, x.maxHealth ?? x.health) 
      }))
      log(`æ³•æœ¯ï¼š${card.name}ï¼Œå‹æ–¹å…¨ä½“æ¢å¤ ${healAmount} ç‚¹ç”Ÿå‘½`)
    } else {
      // å•ä½“æ²»ç–—ï¼ˆé€‰æ‹©ç”Ÿå‘½æœ€ä½çš„å‹æ–¹ï¼‰
      let idx = 0
      for (let i = 1; i < board.value.length; i++) {
        if (board.value[i].health < board.value[idx].health) idx = i
      }
      const target = board.value[idx]
      target.health = Math.min(target.health + healAmount, target.maxHealth ?? target.health)
      log(`æ³•æœ¯ï¼š${card.name}ï¼Œä¸º ${target.name} æ¢å¤ ${healAmount} ç‚¹ç”Ÿå‘½`)
    }
  }
  
  // ä¼¤å®³æ•ˆæœ
  if (effect.damage) {
    const damage = effect.damage
    const isAOE = effect.aoe || effect.target === 'all_enemies'
    
    if (isAOE) {
      // AOEä¼¤å®³
      enemyBoard.value = enemyBoard.value.map(x => {
        const absorb = Math.min(x.shield ?? 0, damage)
        x.shield = Math.max(0, (x.shield ?? 0) - absorb)
        const dmg = damage - absorb
        x.health = Math.max(0, x.health - dmg)
        return x
      })
      log(`æ³•æœ¯ï¼š${card.name}ï¼Œå¯¹æ‰€æœ‰æ•Œäººé€ æˆ ${damage} ç‚¹ä¼¤å®³`)
    } else {
      // å•ä½“ä¼¤å®³
      const target = enemyBoard.value[0]
      if (target) {
        const absorb = Math.min(target.shield ?? 0, damage)
        target.shield = Math.max(0, (target.shield ?? 0) - absorb)
        const dmg = damage - absorb
        target.health = Math.max(0, target.health - dmg)
        log(`æ³•æœ¯ï¼š${card.name}ï¼Œå¯¹ ${target.name} é€ æˆ ${dmg} ç‚¹ä¼¤å®³ï¼ŒæŠ¤ç›¾å¸æ”¶ ${absorb}`)
      } else {
        enemyHP.value = Math.max(0, enemyHP.value - damage)
        log(`æ³•æœ¯ï¼š${card.name}ï¼Œå¯¹æ•Œæ–¹é€ æˆ ${damage} ç‚¹ä¼¤å®³`)
      }
    }
  }
  
  // æŠ¤ç›¾æ•ˆæœ
  if (effect.armor) {
    const armorAmount = effect.armor
    const target = effect.target || 'ally'
    
    if (target === 'all_allies') {
      // ç¾¤ä½“æŠ¤ç›¾
      board.value = board.value.map(x => ({ 
        ...x, 
        shield: (x.shield ?? 0) + armorAmount 
      }))
      log(`æ³•æœ¯ï¼š${card.name}ï¼Œå‹æ–¹å…¨ä½“è·å¾— ${armorAmount} ç‚¹æŠ¤ç”²`)
    } else {
      // å•ä½“æŠ¤ç›¾
      let idx = 0
      for (let i = 1; i < board.value.length; i++) {
        if (board.value[i].health < board.value[idx].health) idx = i
      }
      const target = board.value[idx]
      target.shield = (target.shield ?? 0) + armorAmount
      log(`æ³•æœ¯ï¼š${card.name}ï¼Œä¸º ${target.name} æä¾› ${armorAmount} ç‚¹æŠ¤ç”²`)
    }
  }
}
```

### 5.2 é•¿æœŸæ–¹æ¡ˆï¼ˆå®Œæ•´é‡æ„ï¼‰

#### **å»ºè®®1ï¼šç»Ÿä¸€ç‰¹æ€§ç³»ç»Ÿ**
- å°† `character_traits` å’Œ `card_character_traits` åˆå¹¶ä¸ºç»Ÿä¸€çš„ç‰¹æ€§ç³»ç»Ÿ
- ä½¿ç”¨ç»Ÿä¸€çš„ `effect_payload` æ ¼å¼
- å‰ç«¯ç»Ÿä¸€è§£æå’Œæ‰§è¡Œç‰¹æ€§æ•ˆæœ

#### **å»ºè®®2ï¼šç‰¹æ€§æ‰§è¡Œå¼•æ“**
- åœ¨åç«¯å®ç°ç‰¹æ€§æ‰§è¡Œå¼•æ“ï¼Œç»Ÿä¸€å¤„ç†æ‰€æœ‰ç‰¹æ€§æ•ˆæœ
- å‰ç«¯åªè´Ÿè´£å±•ç¤ºï¼Œæ•ˆæœè®¡ç®—ç”±åç«¯å®Œæˆ
- æ”¯æŒæ›´å¤æ‚çš„ç‰¹æ€§æ•ˆæœï¼ˆå¦‚æ¡ä»¶è§¦å‘ã€æŒç»­æ•ˆæœç­‰ï¼‰

#### **å»ºè®®3ï¼šæ³•æœ¯/è£…å¤‡æ•ˆæœç³»ç»Ÿ**
- å®Œå–„æ³•æœ¯å’Œè£…å¤‡çš„æ•ˆæœæ‰§è¡Œé€»è¾‘
- ç»Ÿä¸€ä½¿ç”¨ `effect_payload` JSON æ ¼å¼
- æ”¯æŒç»„åˆæ•ˆæœï¼ˆå¦‚"æ²»ç–—+æŠ¤ç›¾"ï¼‰

---

## ğŸ“Š å…­ã€å®ç°çŠ¶æ€æ€»ç»“

| åŠŸèƒ½æ¨¡å— | æ•°æ®åº“ | åç«¯æ¥å£ | å‰ç«¯å®ç° | æˆ˜æ–—ç³»ç»Ÿ | çŠ¶æ€ |
|---------|--------|---------|---------|---------|------|
| **å¡ç‰Œè§’è‰²ç‰¹æ€§** | âœ… | âœ… | âŒ | âŒ | ğŸ”´ **æ— æ³•ä½¿ç”¨** |
| **æ²»ç–—ç‰¹æ€§** | âœ… | âœ… | âŒ | âŒ | ğŸ”´ **æ— æ³•æ­£ç¡®å®ç°** |
| **æ³•æœ¯æ•ˆæœ** | âœ… | âš ï¸ éƒ¨åˆ† | âš ï¸ éƒ¨åˆ† | âŒ | ğŸŸ¡ **æ•°æ®æœ‰ä½†æœªå®Œæ•´å®ç°** |
| **è£…å¤‡æ•ˆæœ** | âœ… | âš ï¸ éƒ¨åˆ† | âš ï¸ éƒ¨åˆ† | âŒ | ğŸŸ¡ **æ•°æ®æœ‰ä½†æœªå®Œæ•´å®ç°** |
| **é“å…·æ•ˆæœ** | âœ… | âœ… | âœ… | âœ… | âœ… **å¯ä»¥æ­£å¸¸ä½¿ç”¨** |

---

## ğŸ¯ ä¸ƒã€ç»“è®º

### **å½“å‰çŠ¶æ€**ï¼š
âŒ **è£…å¤‡ã€æ³•æœ¯ã€è§’è‰²å¡ç‰Œçš„ç‰¹æ€§æ— æ³•æˆåŠŸç”Ÿæ•ˆ**

### **åŸå› **ï¼š
1. **å¡ç‰Œè§’è‰²ç‰¹æ€§**ï¼š
   - âœ… åç«¯æ¥å£å·²å®ç°
   - âŒ å‰ç«¯æ²¡æœ‰è°ƒç”¨æ¥å£
   - âŒ å‰ç«¯ä½¿ç”¨ç¡¬ç¼–ç é€»è¾‘ï¼Œæ— æ³•ä»æ•°æ®åº“è¯»å–

2. **æ³•æœ¯æ•ˆæœ**ï¼š
   - âœ… æ•°æ®åº“ä¸­æœ‰å®Œæ•´çš„æ³•æœ¯æ•ˆæœé…ç½®
   - âŒ å‰ç«¯åªæœ‰éƒ¨åˆ†ç¡¬ç¼–ç å®ç°ï¼ˆå¦‚ `fireball3`ï¼‰
   - âŒ æ²»ç–—æ•ˆæœå®Œå…¨æ²¡æœ‰å®ç°

3. **è£…å¤‡æ•ˆæœ**ï¼š
   - âœ… æ•°æ®åº“ä¸­æœ‰å®Œæ•´çš„è£…å¤‡æ•ˆæœé…ç½®
   - âŒ å‰ç«¯åªæœ‰éƒ¨åˆ†ç¡¬ç¼–ç å®ç°ï¼ˆå¦‚ `teamBuffAtk1`ï¼‰
   - âŒ å¤æ‚æ•ˆæœå®Œå…¨æ²¡æœ‰å®ç°

### **å»ºè®®**ï¼š
1. **ç«‹å³ä¿®å¤**ï¼š
   - å‰ç«¯æ·»åŠ è°ƒç”¨ `/card-characters/{id}/traits` çš„APIæ–¹æ³•
   - ä¿®æ”¹æˆ˜æ–—ç³»ç»Ÿï¼Œä»æ•°æ®åº“è¯»å–ç‰¹æ€§é…ç½®å¹¶åŠ¨æ€æ‰§è¡Œ
   - å®ç°æ³•æœ¯å’Œè£…å¤‡æ•ˆæœçš„åŠ¨æ€è§£æå’Œæ‰§è¡Œ

2. **åç»­ä¼˜åŒ–**ï¼š
   - ç»Ÿä¸€ç‰¹æ€§ç³»ç»Ÿï¼Œåˆå¹¶ `character_traits` å’Œ `card_character_traits`
   - åœ¨åç«¯å®ç°ç‰¹æ€§æ‰§è¡Œå¼•æ“ï¼Œç»Ÿä¸€å¤„ç†æ‰€æœ‰æ•ˆæœ
   - å®Œå–„æ•ˆæœç³»ç»Ÿï¼Œæ”¯æŒæ›´å¤æ‚çš„ç»„åˆæ•ˆæœ

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-01-XX  
**åˆ†æè€…**ï¼šAIåŠ©æ‰‹

