# 小程序迁移 - 改造指南

> **创建日期**：2025-01-XX  
> **用途**：指导如何将 Vue 3 Web 页面改造为 uni-app 小程序页面

---

## 📋 改造清单

### ✅ 已完成改造

1. ✅ `utils/soundManager.ts` - 存储API + 音效系统
2. ✅ `utils/performance.ts` - 存储API
3. ✅ `pages/home/home.vue` - 完整改造（路由+生命周期+组件标签+存储API+图片路径）
4. ✅ `pages/login/login.vue` - 已部分改造（生命周期+组件标签）
5. ✅ API 引用路径批量替换：`@/lib/api` → `@/api/request`

### ⏳ 待改造页面

- [ ] `pages/camp/camp.vue` - 需要改造路由、生命周期、组件标签
- [ ] `pages/battle/battle.vue` - 需要改造路由、生命周期、组件标签
- [ ] `pages/explore/explore.vue` - 需要改造路由、生命周期、组件标签
- [ ] `pages/skills/skills.vue` - 需要改造路由、生命周期、组件标签
- [ ] `pages/achievements/achievements.vue` - 需要改造路由、生命周期、组件标签
- [ ] `pages/shop/shop.vue` - 需要改造路由、生命周期、组件标签
- [ ] `pages/settings/settings.vue` - 需要改造路由、生命周期、组件标签
- [ ] `pages/summary/summary.vue` - 需要改造路由、生命周期、组件标签

---

## 🔧 改造步骤

### 步骤 1：移除 Vue Router 相关代码

**查找并删除**：
```typescript
// 删除这些导入
import { useRouter } from 'vue-router'
import { RouterLink } from 'vue-router'

// 删除这些使用
const router = useRouter()
```

**替换为**：
```typescript
// 添加 uni-app 类型声明
declare const uni: {
  navigateTo: (options: { url: string }) => void
  redirectTo: (options: { url: string }) => void
  navigateBack: (options?: { delta?: number }) => void
  reLaunch: (options: { url: string }) => void
  switchTab: (options: { url: string }) => void
}
```

### 步骤 2：改造路由跳转

**查找并替换**：

| 原代码 | 新代码 |
|--------|--------|
| `router.push('/camp')` | `uni.navigateTo({ url: '/pages/camp/camp' })` |
| `router.replace('/login')` | `uni.redirectTo({ url: '/pages/login/login' })` |
| `router.back()` | `uni.navigateBack()` |
| `<RouterLink to="/camp">` | `<view @click="goToCamp">` 或 `<navigator url="/pages/camp/camp">` |

**示例**：
```vue
<!-- 原代码 -->
<RouterLink to="/camp" class="nav-button">营地</RouterLink>
router.push('/camp')

<!-- 改造后 -->
<view class="nav-button" @click="goToCamp">营地</view>
// 在 script 中
function goToCamp() {
  uni.navigateTo({ url: '/pages/camp/camp' })
}
```

### 步骤 3：改造生命周期

**查找并替换**：

| 原代码 | 新代码 |
|--------|--------|
| `import { onMounted } from 'vue'` | `import { onLoad, onShow } from '@dcloudio/uni-app'` |
| `onMounted(() => { ... })` | `onLoad(() => { ... })` 或 `onLoad((options) => { ... })` |

**添加 onShow**（如果需要页面显示时刷新数据）：
```typescript
onShow(() => {
  // 页面显示时执行（每次进入页面都会触发）
  // 可以在这里刷新数据
})
```

### 步骤 4：改造组件标签

**批量替换**（可以使用查找替换功能）：

| 原标签 | 新标签 | 说明 |
|--------|--------|------|
| `<div>` | `<view>` | 容器标签 |
| `</div>` | `</view>` | 容器标签 |
| `<span>` | `<text>` | 文本标签 |
| `</span>` | `</text>` | 文本标签 |
| `<img src="...">` | `<image src="...">` | 图片标签 |
| `<a href="...">` | `<navigator url="...">` | 链接标签（如需要） |

**注意**：
- `<h1>`, `<h2>`, `<h3>`, `<p>` 等标签可以保留，但建议改为 `<text>` 或 `<view>`
- `<button>` 可以保留
- `<input>` 可以保留

### 步骤 5：改造存储 API

**查找并替换**：

| 原代码 | 新代码 |
|--------|--------|
| `localStorage.getItem('key')` | `uni.getStorageSync('key')` |
| `localStorage.setItem('key', value)` | `uni.setStorageSync('key', value)` |
| `localStorage.removeItem('key')` | `uni.removeStorageSync('key')` |
| `localStorage.clear()` | `uni.clearStorageSync()` |

**添加类型声明**（如果文件顶部没有）：
```typescript
declare const uni: {
  getStorageSync: (key: string) => any
  setStorageSync: (key: string, value: any) => void
  removeStorageSync: (key: string) => void
  clearStorageSync: () => void
}
```

### 步骤 6：改造图片路径

**查找并替换**：

| 原路径 | 新路径 |
|--------|--------|
| `url('/background.png')` | `url('/static/background.png')` |
| `src="/logo.png"` | `src="/static/logo.png"` |

**同时将标签改为**：
```vue
<!-- 原代码 -->
<img src="/logo.png" />

<!-- 改造后 -->
<image src="/static/logo.png" />
```

### 步骤 7：改造 API 引用路径

**查找并替换**：
```typescript
// 原代码
import { campApi } from '@/lib/api'

// 改造后
import { campApi } from '@/api/request'
```

---

## 📝 完整改造示例

### 示例：改造前的代码

```vue
<template>
  <div class="page">
    <RouterLink to="/camp">营地</RouterLink>
    <img src="/logo.png" />
    <span>文本</span>
  </div>
</template>

<script setup>
import { onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { campApi } from '@/lib/api'

const router = useRouter()

onMounted(() => {
  const token = localStorage.getItem('token')
  // 初始化逻辑
})

function goToCamp() {
  router.push('/camp')
}
</script>
```

### 示例：改造后的代码

```vue
<template>
  <view class="page">
    <view @click="goToCamp">营地</view>
    <image src="/static/logo.png" />
    <text>文本</text>
  </view>
</template>

<script setup>
import { onLoad, onShow } from '@dcloudio/uni-app'
import { campApi } from '@/api/request'

// uni-app 类型声明
declare const uni: {
  navigateTo: (options: { url: string }) => void
  getStorageSync: (key: string) => any
}

onLoad(() => {
  const token = uni.getStorageSync('token')
  // 初始化逻辑
})

onShow(() => {
  // 页面显示时刷新数据（可选）
})

function goToCamp() {
  uni.navigateTo({ url: '/pages/camp/camp' })
}
</script>
```

---

## 🔍 批量查找替换建议

### 使用 VS Code 批量替换

1. **打开查找替换**：`Ctrl+H` (Windows) 或 `Cmd+H` (Mac)
2. **启用正则表达式**：点击 `.*` 按钮
3. **逐个替换**：

#### 替换 div 标签
- **查找**：`<div`
- **替换**：`<view`
- **范围**：当前文件或整个文件夹

- **查找**：`</div>`
- **替换**：`</view>`

#### 替换 span 标签
- **查找**：`<span`
- **替换**：`<text`
- **查找**：`</span>`
- **替换**：`</text>`

#### 替换 img 标签
- **查找**：`<img`
- **替换**：`<image`
- **查找**：`</img>`
- **替换**：`</image>`（注意：image 是自闭合标签，通常不需要闭合标签）

#### 替换 localStorage
- **查找**：`localStorage\.getItem\(`
- **替换**：`uni.getStorageSync(`
- **查找**：`localStorage\.setItem\(`
- **替换**：`uni.setStorageSync(`
- **查找**：`localStorage\.removeItem\(`
- **替换**：`uni.removeStorageSync(`

#### 替换 router.push
- **查找**：`router\.push\(['"]([^'"]+)['"]\)`
- **替换**：`uni.navigateTo({ url: '/pages$1' })`
- **注意**：需要手动调整路径格式

---

## ⚠️ 注意事项

### 1. 路径映射

确保路由路径正确映射：

| 原路径 | 新路径 |
|--------|--------|
| `/` | `/pages/home/home` |
| `/login` | `/pages/login/login` |
| `/camp` | `/pages/camp/camp` |
| `/battle` | `/pages/battle/battle` |
| `/explore` | `/pages/explore/explore` |
| `/skills` | `/pages/skills/skills` |
| `/shop` | `/pages/shop/shop` |
| `/settings` | `/pages/settings/settings` |
| `/achievements` | `/pages/achievements/achievements` |
| `/summary` | `/pages/summary/summary` |

### 2. 页面参数传递

**原代码**：
```typescript
router.push({
  path: '/camp',
  query: { id: '123', name: 'test' }
})
```

**改造后**：
```typescript
uni.navigateTo({
  url: '/pages/camp/camp?id=123&name=test'
})

// 在目标页面接收参数
onLoad((options) => {
  const id = options.id
  const name = options.name
})
```

### 3. TabBar 页面跳转

如果页面在 TabBar 中，使用 `uni.switchTab`：
```typescript
uni.switchTab({ url: '/pages/home/home' })
```

### 4. 返回上一页

**原代码**：
```typescript
router.back()
```

**改造后**：
```typescript
uni.navigateBack()
// 或指定返回层数
uni.navigateBack({ delta: 2 }) // 返回上上页
```

### 5. 样式注意事项

- 移除所有 Tailwind CSS 类
- 检查小程序不支持的 CSS 属性
- 使用 `rpx` 单位而不是 `px`（可选，但推荐）

---

## 🎯 改造优先级

### 高优先级（必须完成）

1. **路由系统改造** - 影响所有页面功能
2. **生命周期改造** - 影响页面初始化
3. **组件标签改造** - 影响页面渲染
4. **存储 API 改造** - 影响数据持久化

### 中优先级

5. **样式改造** - 影响页面显示效果
6. **图片路径改造** - 影响资源加载

---

## 📊 改造进度跟踪

使用此表格跟踪每个文件的改造进度：

| 文件 | 路由 | 生命周期 | 组件标签 | 存储API | 图片路径 | 状态 |
|------|------|---------|---------|---------|---------|------|
| `home.vue` | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ 完成 |
| `login.vue` | ⏳ | ✅ | ✅ | ✅ | ⏳ | ⏳ 进行中 |
| `camp.vue` | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ 待改造 |
| `battle.vue` | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ 待改造 |
| `explore.vue` | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ 待改造 |
| `skills.vue` | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ 待改造 |
| `achievements.vue` | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ 待改造 |
| `shop.vue` | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ 待改造 |
| `settings.vue` | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ 待改造 |
| `summary.vue` | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ | ⏳ 待改造 |

---

## 🔗 相关文档

- [小程序迁移报告.md](../小程序迁移报告.md)
- [小程序迁移-项目结构说明.md](./小程序迁移-项目结构说明.md)
- [小程序迁移-快速参考.md](./小程序迁移-快速参考.md)
- [小程序迁移-待办清单.md](./小程序迁移-待办清单.md)




