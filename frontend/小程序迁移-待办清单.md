# 小程序迁移 - 待办清单

> **生成日期**：2025-01-XX  
> **基于文档**：小程序迁移报告.md  
> **当前进度**：阶段一、二完成，阶段三部分完成

---

## 📊 总体进度

| 阶段 | 状态 | 完成度 |
|------|------|--------|
| **阶段一：环境准备** | ✅ 完成 | 100% |
| **阶段二：核心功能迁移** | ✅ 完成 | 100% |
| **阶段三：UI 样式改造** | ⏳ 进行中 | 20% |
| **阶段四：功能适配** | ⏳ 未开始 | 0% |
| **阶段五：测试与优化** | ⏳ 未开始 | 0% |
| **阶段六：后端调整** | ⏳ 未开始 | 0% |

---

## 🔴 高优先级（必须完成）

### 1. 路由系统改造 ⚠️ 紧急

**影响范围**：所有页面文件（约 10 个核心页面）

**需要改动**：
- [ ] 移除所有 `vue-router` 相关导入
  - [ ] `import { useRouter } from 'vue-router'`
  - [ ] `import { RouterLink } from 'vue-router'`
- [ ] 将所有 `router.push()` 改为 `uni.navigateTo()`
- [ ] 将所有 `router.replace()` 改为 `uni.redirectTo()`
- [ ] 将所有 `router.back()` 改为 `uni.navigateBack()`
- [ ] 将所有 `<RouterLink>` 改为 `<navigator>` 或按钮 + `uni.navigateTo()`
- [ ] 处理页面参数传递（query → url 参数）

**涉及文件**（根据 grep 结果，约 1598 处需要改动）：
- `pages/home/home.vue` - 49 处
- `pages/battle/battle.vue` - 215 处
- `pages/skills/skills.vue` - 86 处
- `pages/camp/camp.vue` - 262 处
- `pages/achievements/achievements.vue` - 91 处
- `pages/explore/explore.vue` - 167 处
- `pages/login/login.vue` - 30 处
- `pages/settings/settings.vue` - 14 处
- `pages/shop/shop.vue` - 106 处
- `pages/summary/summary.vue` - 27 处
- 以及所有组件文件

**示例改造**：
```vue
<!-- 原代码 -->
<RouterLink to="/camp">营地</RouterLink>
const router = useRouter()
router.push('/camp')

<!-- 改造后 -->
<navigator url="/pages/camp/camp">营地</navigator>
uni.navigateTo({ url: '/pages/camp/camp' })
```

---

### 2. 生命周期改造 ⚠️ 紧急

**影响范围**：所有页面文件

**需要改动**：
- [ ] 将所有 `onMounted` 改为 `onLoad`
- [ ] 添加 `onShow` 处理页面显示逻辑
- [ ] 导入 `@dcloudio/uni-app` 的生命周期函数
- [ ] 处理页面参数（`onLoad` 的 `options` 参数）

**示例改造**：
```typescript
// 原代码
import { onMounted } from 'vue'
onMounted(() => {
  // 初始化逻辑
})

// 改造后
import { onLoad, onShow } from '@dcloudio/uni-app'
onLoad((options) => {
  // 页面加载时执行
  // options 包含页面参数
})
onShow(() => {
  // 页面显示时执行（每次进入页面都会触发）
})
```

---

### 3. 组件标签改造 ⚠️ 紧急

**影响范围**：所有页面和组件文件

**需要改动**：
- [ ] 将所有 `<div>` 改为 `<view>`
- [ ] 将所有 `<span>` 改为 `<text>`
- [ ] 将所有 `<img>` 改为 `<image>`
- [ ] 将所有 `<a>` 改为 `<navigator>`（如需要）

**涉及文件**：所有 `.vue` 文件

**示例改造**：
```vue
<!-- 原代码 -->
<div class="container">
  <span>文本</span>
  <img src="/logo.png" />
</div>

<!-- 改造后 -->
<view class="container">
  <text>文本</text>
  <image src="/static/logo.png" />
</view>
```

---

### 4. 存储 API 改造 ⚠️ 紧急

**影响范围**：所有使用 localStorage 的文件（stores、组件等）

**需要改动**：
- [ ] 将所有 `localStorage.getItem()` 改为 `uni.getStorageSync()`
- [ ] 将所有 `localStorage.setItem()` 改为 `uni.setStorageSync()`
- [ ] 将所有 `localStorage.removeItem()` 改为 `uni.removeStorageSync()`
- [ ] 将所有 `localStorage.clear()` 改为 `uni.clearStorageSync()`

**涉及文件**：
- `stores/auth.ts`
- `stores/battle.ts`
- `stores/camp.ts`
- `stores/game.ts`
- 以及其他使用 localStorage 的文件

**示例改造**：
```typescript
// 原代码
const token = localStorage.getItem('token')
localStorage.setItem('token', tokenValue)
localStorage.removeItem('token')

// 改造后
const token = uni.getStorageSync('token')
uni.setStorageSync('token', tokenValue)
uni.removeStorageSync('token')
```

---

### 5. 样式改造 ⚠️ 高优先级

**影响范围**：所有使用 Tailwind CSS 的文件

**需要改动**：
- [ ] 移除所有 Tailwind CSS 类（如 `class="min-h-screen flex flex-col"`）
- [ ] 重写为传统 CSS/SCSS
- [ ] 检查小程序不支持的 CSS 属性
- [ ] 适配小程序样式限制

**样式限制**：
- ❌ 不支持 `position: fixed`（需使用 `position: sticky`）
- ❌ 不支持部分 CSS3 动画
- ❌ 不支持 `::before` / `::after` 伪元素（部分场景）
- ⚠️ 使用 `rpx` 单位而不是 `px`

**涉及文件**：所有 `.vue` 文件

---

### 6. 图片资源路径改造 ⚠️ 高优先级

**影响范围**：所有使用图片的文件

**需要改动**：
- [ ] 将所有图片路径改为 `static/` 目录
- [ ] 将 `<img>` 改为 `<image>`
- [ ] 压缩图片资源（减小包体积）
- [ ] 使用 WebP 格式（可选）

**示例改造**：
```vue
<!-- 原代码 -->
<img src="/background.png" />

<!-- 改造后 -->
<image src="/static/background.png" />
```

---

## 🟡 中优先级（重要但可延后）

### 7. 音效系统改造

**影响范围**：`utils/soundManager.ts` 及相关使用文件

**需要改动**：
- [ ] 将 `Audio` 改为 `uni.createInnerAudioContext()`
- [ ] 处理音频播放限制（需要用户交互）
- [ ] 确保音频文件在 `static/sounds/` 目录（已完成）

**示例改造**：
```typescript
// 原代码
const audio = new Audio('/sounds/hit.mp3')
audio.play()

// 改造后
const audio = uni.createInnerAudioContext()
audio.src = '/static/sounds/hit.mp3'
audio.play()
```

---

### 8. 配置文件调整

**需要改动**：
- [ ] 配置 `manifest.json` 中的微信小程序 AppID
- [ ] 调整 `package.json` 依赖
  - [ ] 移除 `vue-router`
  - [ ] 移除 `axios`（如果不再使用）
  - [ ] 添加 `@dcloudio/uni-app`
  - [ ] 添加 `@dcloudio/uni-app-vite`（如果使用 Vite）
- [ ] 创建 `main.js`（替代 `main.ts`，移除路由相关代码）

**manifest.json 配置**：
```json
{
  "mp-weixin": {
    "appid": "你的小程序AppID",  // ⚠️ 需要填写
    "setting": {
      "urlCheck": false  // 开发时设为 false
    }
  }
}
```

---

### 9. API 引用路径调整

**影响范围**：所有使用 API 的文件

**需要改动**：
- [ ] 将所有 `@/lib/api` 改为 `@/api/request`
- [ ] 检查所有 API 调用是否正常工作

**示例改造**：
```typescript
// 原代码
import { campApi } from '@/lib/api'

// 改造后
import { campApi } from '@/api/request'
```

---

## 🟢 低优先级（优化项）

### 10. TabBar 图标准备

**需要**：
- [ ] 准备 8 张图标（4 个普通状态 + 4 个选中状态）
- [ ] 放置到 `static/tabbar/` 目录
- [ ] 命名规范：
  - `home.png` / `home-active.png`
  - `camp.png` / `camp-active.png`
  - `explore.png` / `explore-active.png`
  - `achievements.png` / `achievements-active.png`

---

### 11. 后端配置

**需要改动**：
- [ ] 配置服务器域名（在微信公众平台）
  - [ ] request 合法域名
  - [ ] uploadFile 合法域名（如有文件上传）
  - [ ] downloadFile 合法域名（如有文件下载）
- [ ] 配置 HTTPS（生产环境必须）
- [ ] （可选）集成微信登录接口

---

## 📋 详细任务清单

### 阶段三：代码改造（剩余工作）

#### 3.1 路由相关（约 1598 处需要改动）
- [ ] `pages/home/home.vue` - 49 处
- [ ] `pages/battle/battle.vue` - 215 处
- [ ] `pages/skills/skills.vue` - 86 处
- [ ] `pages/camp/camp.vue` - 262 处
- [ ] `pages/achievements/achievements.vue` - 91 处
- [ ] `pages/explore/explore.vue` - 167 处
- [ ] `pages/login/login.vue` - 30 处
- [ ] `pages/settings/settings.vue` - 14 处
- [ ] `pages/shop/shop.vue` - 106 处
- [ ] `pages/summary/summary.vue` - 27 处
- [ ] 所有组件文件（`components/` 目录）

#### 3.2 生命周期（所有页面）
- [ ] `pages/home/home.vue`
- [ ] `pages/login/login.vue`
- [ ] `pages/camp/camp.vue`
- [ ] `pages/battle/battle.vue`
- [ ] `pages/explore/explore.vue`
- [ ] `pages/summary/summary.vue`
- [ ] `pages/skills/skills.vue`
- [ ] `pages/shop/shop.vue`
- [ ] `pages/settings/settings.vue`
- [ ] `pages/achievements/achievements.vue`

#### 3.3 组件标签（所有文件）
- [ ] 所有页面文件（10 个）
- [ ] 所有组件文件（约 20+ 个）

#### 3.4 样式改造（所有使用 Tailwind 的文件）
- [ ] 移除 Tailwind CSS 类
- [ ] 重写为传统 CSS/SCSS
- [ ] 适配小程序样式限制

#### 3.5 API 调用 ✅ 已完成
- [x] 将 `axios` 改为 `uni.request` ✅
- [x] 重写请求拦截器 ✅
- [x] 重写响应拦截器 ✅
- [x] 处理网络错误 ✅
- [x] 处理登录过期跳转 ✅

#### 3.6 存储 API（所有 stores 和组件）
- [ ] `stores/auth.ts`
- [ ] `stores/battle.ts`
- [ ] `stores/camp.ts`
- [ ] `stores/game.ts`
- [ ] `stores/characters.ts`
- [ ] `stores/inventory.ts`
- [ ] `stores/run.ts`
- [ ] `stores/shop.ts`
- [ ] `stores/wallet.ts`
- [ ] 其他使用 localStorage 的文件

#### 3.7 音效系统
- [ ] `utils/soundManager.ts`
- [ ] 所有使用音效的组件

#### 3.8 图片资源
- [ ] 所有使用图片的文件
- [ ] 压缩图片资源
- [ ] 使用 WebP 格式（可选）

---

### 阶段四：配置文件

- [ ] 配置 `manifest.json` 中的微信小程序 AppID
- [ ] 调整 `package.json` 依赖
- [ ] 创建 `main.js`（替代 `main.ts`）

---

### 阶段五：测试

- [ ] 测试所有页面路由跳转
- [ ] 测试 API 接口调用
- [ ] 测试状态管理（Pinia）
- [ ] 测试登录/登出流程
- [ ] 测试核心功能（营地、战斗、探索等）
- [ ] 测试音效播放
- [ ] 测试图片加载
- [ ] 性能测试（包体积、加载速度）

---

### 阶段六：优化

- [ ] 代码分包（如需要）
- [ ] 图片优化
- [ ] 接口优化
- [ ] 代码压缩

---

## 🎯 建议执行顺序

### 第一步：核心功能改造（1-2周）

1. **路由系统改造**（3-4天）
   - 优先级最高，影响所有页面
   - 建议逐个页面改造并测试

2. **生命周期改造**（1天）
   - 相对简单，但影响所有页面
   - 可以配合路由改造一起进行

3. **组件标签改造**（2-3天）
   - 工作量较大，但相对机械
   - 可以使用查找替换批量处理

4. **存储 API 改造**（1天）
   - 主要涉及 stores 目录
   - 影响范围相对集中

### 第二步：样式和资源改造（1周）

5. **样式改造**（3-5天）
   - 工作量最大，需要重写所有样式
   - 建议使用 UI 组件库减少工作量

6. **图片资源改造**（1天）
   - 相对简单，主要是路径调整

### 第三步：功能适配和测试（1周）

7. **音效系统改造**（1天）
8. **配置文件调整**（0.5天）
9. **全面测试**（3-5天）

---

## 📊 工作量估算

| 任务 | 工作量 | 优先级 |
|------|--------|--------|
| 路由系统改造 | 3-4天 | 🔴 高 |
| 生命周期改造 | 1天 | 🔴 高 |
| 组件标签改造 | 2-3天 | 🔴 高 |
| 存储 API 改造 | 1天 | 🔴 高 |
| 样式改造 | 3-5天 | 🟡 中 |
| 图片资源改造 | 1天 | 🟡 中 |
| 音效系统改造 | 1天 | 🟡 中 |
| 配置文件调整 | 0.5天 | 🟡 中 |
| 全面测试 | 3-5天 | 🟡 中 |
| **总计** | **15-22天** | |

---

## ⚠️ 注意事项

1. **逐步改造**：不要一次性改造所有文件，建议逐个页面改造并测试
2. **保持功能**：改造过程中确保功能不丢失
3. **测试驱动**：每改造一个页面，立即测试功能是否正常
4. **备份代码**：改造前建议创建分支或备份

---

## 🔗 相关文档

- [小程序迁移报告.md](../小程序迁移报告.md)
- [小程序迁移-项目结构说明.md](./小程序迁移-项目结构说明.md)
- [小程序迁移-检查清单.md](./小程序迁移-检查清单.md)
- [小程序迁移-检查报告.md](./小程序迁移-检查报告.md)
- [小程序迁移-快速参考.md](./小程序迁移-快速参考.md)




