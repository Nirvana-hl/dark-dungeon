# 技能系统分析报告

## 一、现有代码结构分析

### 1.1 数据库结构
- **skills表**：存储技能模板
  - `effect_payload` (JSON)：技能效果配置
  - `required_level`：解锁所需等级
  - `position_in_tree` (JSON)：技能树位置
  - `unlock_path` (JSON)：前置技能依赖

### 1.2 技能类型支持情况

#### ✅ 已支持主动技能
从SQL示例可以看到，系统已经支持多种主动技能类型：
- **攻击类** (`type: "attack"`)：如 `warden_sacred_shield`、`occultist_shadow_bolt`
- **治疗类** (`type: "heal"`)：如 `warden_healing_light`
- **Buff类** (`type: "buff"`)：如 `warden_guardian_wall`
- **Debuff类** (`type: "debuff"`)：如 `occultist_weakness_curse`

#### ✅ 已支持被动技能
系统已经支持被动技能，示例：
```json
// 守望者 - 坚韧意志
{"type": "passive", "damage_reduction": 0.15, "debuff_resistance": 0.2}

// 秘术师 - 暗影护体
{"type": "passive", "magic_resistance": 0.3, "physical_damage_reduction": 0.15}

// 游侠 - 敏捷步伐
{"type": "passive", "dodge_chance": 0.25, "movement_speed_bonus": 0.3}

// 战士 - 坚韧体魄
{"type": "passive", "hp_bonus": 0.2, "physical_defense_bonus": 0.25}
```

### 1.3 属性提升支持情况

#### ✅ 已支持的属性提升
从现有被动技能示例可以看到：
- **生命值提升**：`hp_bonus` (百分比，如 0.2 = 20%)
- **物理防御提升**：`physical_defense_bonus` (百分比)
- **伤害减免**：`damage_reduction` (百分比)
- **魔法抗性**：`magic_resistance` (百分比)
- **闪避率**：`dodge_chance` (百分比)
- **移动速度**：`movement_speed_bonus` (百分比)
- **负面状态抗性**：`debuff_resistance` (百分比)

#### ⚠️ 需要添加的属性提升
根据您的需求，以下属性提升**目前没有示例，但可以通过effectPayload添加**：
- **攻击力提升**：`attack_bonus` (数值或百分比)
- **法力值提升**：`mana_bonus` 或 `max_mana_bonus` (数值或百分比)

## 二、代码扩展能力分析

### 2.1 能否添加多个技能？
**✅ 完全支持**
- 数据库设计支持无限数量的技能
- 技能树通过 `position_in_tree` 字段定位，支持任意布局
- 每个职业可以有多个技能（从SQL看，每个职业有9个技能）

### 2.2 能否区分主动/被动技能？
**✅ 已支持**
- `effectPayload` 中的 `type` 字段可以区分：
  - `"passive"`：被动技能
  - `"attack"`、`"heal"`、`"buff"` 等：主动技能

### 2.3 能否实现属性提升？
**✅ 已支持基础框架，需要完善应用逻辑**

#### 当前状态：
1. **数据结构支持**：`effectPayload` 是JSON格式，可以存储任意属性提升数据
2. **已有示例**：被动技能已经有 `hp_bonus`、`physical_defense_bonus` 等属性提升
3. **缺少应用逻辑**：需要在角色属性计算时应用被动技能效果

#### 需要添加的功能：
1. **被动技能效果应用**：在角色属性计算时，遍历已解锁的被动技能，应用属性提升
2. **攻击力/法力值提升**：添加 `attack_bonus` 和 `mana_bonus` 字段支持

## 三、实现建议

### 3.1 添加攻击力和法力值提升支持

#### 方式一：在effectPayload中添加字段（推荐）
```json
{
  "type": "passive",
  "attack_bonus": 10,        // 固定数值提升
  "attack_bonus_percent": 0.15,  // 百分比提升（15%）
  "max_mana_bonus": 20,      // 法力值上限提升
  "mana_bonus_percent": 0.1  // 法力值百分比提升（10%）
}
```

#### 方式二：统一使用百分比
```json
{
  "type": "passive",
  "attack_bonus": 0.15,      // 攻击力提升15%
  "max_mana_bonus": 0.2       // 法力值上限提升20%
}
```

### 3.2 实现被动技能效果应用

需要在以下位置添加逻辑：

1. **后端 - 角色属性计算**
   - 位置：`PlayerCharacterService` 或新建 `CharacterStatsService`
   - 功能：查询用户已解锁的被动技能，解析 `effectPayload`，计算属性加成

2. **前端 - 角色属性显示**
   - 位置：`camp.vue` 或角色信息组件
   - 功能：显示被动技能提供的属性加成

### 3.3 技能详情展示优化

在技能详情弹窗中，可以：
- 区分显示主动/被动技能
- 被动技能显示属性提升效果
- 主动技能显示技能效果和消耗

## 四、具体实现步骤

### 步骤1：扩展Skill类型定义
在 `frontend/types/index.ts` 中添加：
```typescript
export interface Skill {
  // ... 现有字段
  skillType?: 'active' | 'passive'  // 可选：显式标记技能类型
  effectPayload: {
    type?: string
    attack_bonus?: number
    attack_bonus_percent?: number
    max_mana_bonus?: number
    mana_bonus_percent?: number
    hp_bonus?: number
    // ... 其他属性
  }
}
```

### 步骤2：后端添加属性计算服务
创建 `CharacterStatsService`，实现：
- 查询用户已解锁的被动技能
- 解析 `effectPayload`，计算属性加成
- 返回最终角色属性（基础属性 + 技能加成）

### 步骤3：前端显示属性加成
在角色信息面板中：
- 显示基础属性
- 显示技能提供的属性加成（绿色文字）
- 显示最终属性

### 步骤4：技能详情优化
在技能详情弹窗中：
- 被动技能：显示"被动技能"标签和属性提升效果
- 主动技能：显示技能效果、消耗、目标等

## 五、总结

### ✅ 现有代码支持情况
1. **多技能支持**：✅ 完全支持
2. **主动/被动区分**：✅ 已支持（通过effectPayload.type）
3. **属性提升框架**：✅ 已支持（effectPayload可存储任意属性）
4. **生命值/防御提升**：✅ 已有示例
5. **攻击力/法力值提升**：⚠️ 数据结构支持，但缺少示例和应用逻辑

### 📝 需要完成的工作
1. 在effectPayload中添加 `attack_bonus` 和 `mana_bonus` 字段
2. 实现被动技能效果应用到角色属性的逻辑
3. 优化前端显示，区分主动/被动技能
4. 在角色信息中显示技能提供的属性加成

### 🎯 建议
现有代码架构**完全支持**您的需求，只需要：
1. 添加新的被动技能数据（包含攻击力/法力值提升）
2. 实现属性计算逻辑（应用被动技能效果）
3. 优化UI显示（区分主动/被动，显示属性加成）

代码具有良好的扩展性，可以轻松添加新的技能类型和属性提升效果。

