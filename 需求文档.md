## 暗黑地牢肉鸽 - 需求文档（v1.1）

> 最新更新：2025-11-13  
> 负责人：AI 产品助手

---

## 1. 营地界面（Camp）概览

### 1.1 场景目标
营地界面是玩家在每次探索前的准备枢纽，需满足以下目标：
- 让玩家一眼看到当前主力角色、小队状态与资源余量；
- 方便地调整手牌（角色卡、法术、装备）与携带道具；
- 提供技能树、特性、任务与AI建议等深度玩法入口；
- 支撑商城售卖与营地设施互动（锻造、治疗、训练等）。

### 1.2 功能模组拆解
- **主角面板**：关联 `user_characters`、`character_traits`、`skills`，展示等级、生命、压力、已装备卡牌。
- **卡组管理**：读取 `user_cards`、`cards`、`card_tags`，支持手牌筛选、排序、编组。
- **背包与道具**：读取 `inventory`、`items`，显示消耗品数量、用途说明。
- **营地设施**：读取 `camp_facilities`、`camp_upgrades`、`camp_tasks`，决定当前可用的营地服务。
- **商城&货币**：读取 `shop_offers`、`user_wallets`，售卖角色卡/法术卡/装备卡与营地道具。
- **任务与事件**：关联 `events`、`camp_tasks`，给出准备目标与奖励。
- **AI助手**：基于 `game_metrics`、`runs`、`player_actions` 聚合信息，推送策略建议。

### 1.3 数据展示清单
- **角色栏**：头像、职业、等级、血量/护甲/压力、特性列表、技能树解锁情况。
- **卡组栏**：手牌总览（类型、稀有度、法力消耗）、当前牌组上限、已装备状态。
- **道具栏**：消耗品库存、用途标签、剩余购买次数。
- **营地进度**：设施等级、可参与任务、即将刷新事件时间。
- **货币栏**：金币、魂晶等货币余额，未领取奖励提示。

---

## 2. 数据库重构目标

### 2.1 设计原则
- **一主多从**：区分模板类数据（全局可见）与用户实例数据（私人持有）。
- **类型抽象**：卡牌统一建模，通过类型枚举区分角色牌、法术牌、装备牌，避免重复表。
- **数据可扩展**：保留 JSON/配置字段，便于后续新增特效、数值、策划自定义。
- **营地优先**：所有营地界面数据可通过单次聚合查询获得，减少前端拼装。

### 2.2 表一览
1. `users`  
2. `user_wallets`  
3. `characters`（角色模板）  
4. `user_characters`（玩家持有角色实例）  
5. `character_traits`  
6. `skills`、`user_skills`  
7. `cards`（角色/法术/装备统一卡牌）  
8. `card_tags`、`card_relations`（可选，用于组合或克制关系）  
9. `user_cards`  
10. `items`（商城/道具总表）  
11. `inventory`（背包道具持有）  
12. `shop_offers`（商城上架配置）  
13. `dungeons`、`runs`  
14. `enemies`、`enemy_cards`  
15. `events`、`camp_tasks`  
16. `player_actions`  
17. `achievements`  
18. `game_metrics`

---

## 3. 详细表结构说明

### 3.1 用户与角色体系

**`users`**  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | UUID | 用户唯一标识 |
| `account_name` | VARCHAR | 显示名称/平台昵称 |
| `email` | VARCHAR | 邮箱，可为空 |
| `created_at` | TIMESTAMP | 注册时间 |
| `last_login_at` | TIMESTAMP | 最近登录 |
| `status` | ENUM(active, banned, dormant) | 账户状态 |

**`user_wallets`**  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | UUID | |
| `user_id` (FK→users.id) | UUID | |
| `currency_type` | ENUM(coin, soulstone, premium) | 货币种类 |
| `balance` | BIGINT | 当前余额 |
| `updated_at` | TIMESTAMP | 最新更新时间 |

**`characters`**（角色模板库）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | UUID | 角色模板ID |
| `code` | VARCHAR | 策划用短码 |
| `name` | VARCHAR | 角色名称 |
| `class` | ENUM(warrior, occultist, ranger, ... ) | 职业 |
| `rarity` | ENUM(common, rare, epic, legendary) | 稀有度 |
| `base_stats` | JSONB | {hp, mana, stress, armor} |
| `camp_role` | ENUM(tank, support, dps, utility) | 营地定位 |
| `unlock_condition` | JSONB | 解锁条件描述 |
| `lore` | TEXT | 背景故事 |

**`user_characters`**（玩家拥有的角色实例）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | UUID | |
| `user_id` (FK) | UUID | |
| `character_id` (FK→characters.id) | UUID | |
| `level` | INT | 角色等级 |
| `exp` | BIGINT | 经验值 |
| `current_hp` | INT | 当前血量 |
| `current_mana` | INT | 当前法力 |
| `stress` | INT | 当前压力值 |
| `loadout_id` | UUID | 当前预设牌组ID（可空） |
| `is_active` | BOOLEAN | 是否设为出战角色 |
| `created_at` | TIMESTAMP | 获得时间 |

**`character_traits`**  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | UUID | |
| `character_id` (FK→characters.id) | UUID | 固定特性 |
| `name` | VARCHAR | 特性名称 |
| `type` | ENUM(positive, negative, neutral) | 特性类型 |
| `effect_payload` | JSONB | 效果参数 |
| `description` | TEXT | 展示描述 |

### 3.2 技能树

**`skills`**（角色技能节点）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | UUID | |
| `character_id` (FK→characters.id) | UUID | 所属角色模板 |
| `tree_tier` | INT | 技能层级 |
| `name` | VARCHAR | 技能名称 |
| `mana_cost` | INT | 法力消耗（法术无冷却，仅消耗法力） |
| `effect_payload` | JSONB | 数值与状态效果 |
| `prerequisite_ids` | JSONB | 依赖技能ID数组 |
| `camp_unlock_type` | ENUM(training, quest, item) | 营地解锁方式 |

**`user_skills`**  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | UUID | |
| `user_character_id` (FK→user_characters.id) | UUID | |
| `skill_id` (FK→skills.id) | UUID | |
| `unlocked_at` | TIMESTAMP | 解锁时间 |
| `source` | ENUM(training, purchase, quest, auto) | 解锁来源 |

### 3.3 卡牌系统

**`cards`**（统一卡牌池：角色、法术、装备）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | UUID | |
| `code` | VARCHAR | 策划短码 |
| `name` | VARCHAR | 卡牌名称 |
| `card_type` | ENUM(character, spell, equipment) | 卡牌类型 |
| `rarity` | ENUM(common, rare, epic, legendary) | 稀有度 |
| `mana_cost` | INT | 法力消耗（装备/角色为初始部署消耗） |
| `slot_type` | ENUM(weapon, armor, trinket, none) | 装备适用槽位（法术/角色为 none） |
| `stat_modifiers` | JSONB | 属性变动 |
| `effect_payload` | JSONB | 生效脚本 |
| `camp_unlock_condition` | JSONB | 在营地的解锁条件 |
| `shop_price` | JSONB | {currency_type, amount} |
| `description` | TEXT | 展示描述 |

**`user_cards`**（用户持有手牌实例）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | UUID | |
| `user_id` (FK→users.id) | UUID | |
| `card_id` (FK→cards.id) | UUID | |
| `quantity` | INT | 持有数量（角色卡一般为1） |
| `level` | INT | 卡牌强化等级 |
| `is_equipped` | BOOLEAN | 是否在当前牌组中 |
| `equipped_to_user_character_id` | UUID | 装备所属角色（法术为空） |
| `acquired_at` | TIMESTAMP | 获得时间 |
| `acquired_source` | ENUM(shop, drop, quest, crafting, compensation) | 获取来源 |
| `last_used_at` | TIMESTAMP | 最近使用时间 |

> **解释**：角色、法术、装备都存放在同一张 `cards` 表，通过 `card_type` 区分；无需再拆三张子表，便于商城、构筑、掉落逻辑的统一处理。若后续需要扩展差异化字段，可在 `stat_modifiers` 或 `effect_payload` 中通过 JSON 配置。

### 3.4 道具、背包与商城

**`items`**（道具与商城货品）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | UUID | |
| `code` | VARCHAR | 策划短码 |
| `name` | VARCHAR | 名称 |
| `item_type` | ENUM(consumable, material, blueprint, currency_bundle, cosmetic) | 类型 |
| `rarity` | ENUM(common, rare, epic, legendary) | 稀有度 |
| `effect_payload` | JSONB | 使用效果（如治疗、增益、解锁） |
| `stack_limit` | INT | 单格堆叠上限 |
| `shop_price` | JSONB | {currency_type, amount} |
| `description` | TEXT | 说明 |

**`inventory`**（用户背包）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | UUID | |
| `user_id` (FK→users.id) | UUID | |
| `item_id` (FK→items.id) | UUID | |
| `quantity` | INT | 持有数量 |
| `bind_status` | ENUM(unbound, bound) | 是否绑定 |
| `last_updated_at` | TIMESTAMP | 更新时间 |

**`shop_offers`**（商城上架配置）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | UUID | |
| `offer_type` | ENUM(card, item, bundle) | 商品类型 |
| `target_id` | UUID | 指向 `cards.id` 或 `items.id` |
| `currency_type` | ENUM(coin, soulstone, premium) | 售卖货币 |
| `price` | BIGINT | 价格 |
| `limit_type` | ENUM(none, weekly, monthly, once) | 购买限制 |
| `limit_value` | INT | 限购数量 |
| `available_from` | TIMESTAMP | 上架时间 |
| `available_to` | TIMESTAMP | 下架时间 |
| `display_order` | INT | 前端排序 |

### 3.5 营地设施与任务

**`camp_facilities`**  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | UUID | |
| `code` | VARCHAR | 设施短码（forge, infirmary, library...） |
| `name` | VARCHAR | 设施名称 |
| `description` | TEXT | 功能描述 |
| `base_unlock_condition` | JSONB | 基础解锁条件 |

**`camp_upgrades`**  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | UUID | |
| `facility_id` (FK→camp_facilities.id) | UUID | |
| `tier` | INT | 等级 |
| `upgrade_effect` | JSONB | 数值或服务加成 |
| `cost` | JSONB | {currency_type, amount, material_ids} |

**`camp_tasks`**  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | UUID | |
| `facility_id` | UUID | 关联的营地设施，可空 |
| `name` | VARCHAR | 任务名称 |
| `task_type` | ENUM(training, scouting, crafting, contract) | 类型 |
| `requirements` | JSONB | 角色/卡牌/道具要求 |
| `rewards` | JSONB | 奖励（货币、卡牌、道具） |
| `duration_minutes` | INT | 完成耗时 |
| `refresh_rule` | JSONB | 刷新与限时配置 |

### 3.6 地牢探索与战斗

- **`dungeons`**：保持原设计，新增 `recommended_cards` JSON 字段用于营地推荐。
- **`runs`**：新增 `preparation_snapshot` JSON，记录进入地牢时的卡组、道具快照，方便复盘。
- **`enemies`**、**`enemy_cards`**：沿用现有结构。
- **`events`**：扩展 `location_type` 字段（camp / dungeon），营地事件与探索事件共用。
- **`player_actions`**：新增 `source_scene` 字段（camp / dungeon / battle），帮助分析营地交互数据。

### 3.7 成就与指标

- **`achievements`**：补充 `category`（progression, mastery, collection, social）。
- **`game_metrics`**：按日/周聚合营地使用率、商城转化率、任务完成率等指标。

---

## 4. 数据流与营地界面交互

1. **进入营地**  
   - 聚合查询 `user_characters`（当前角色）、`user_cards`（已装备卡）、`inventory`（可用道具）、`user_wallets`（资产）、`camp_facilities`+`camp_upgrades`（可用功能）、`camp_tasks`（任务列表）。
2. **调整牌组**  
   - 前端展示 `cards` + `user_cards`，过滤 `card_type`、`mana_cost`、`rarity`；更新时写入 `is_equipped`、`equipped_to_user_character_id`。
3. **购买商品**  
   - 读取 `shop_offers`，扣减 `user_wallets.balance`，增加 `user_cards` 或 `inventory`。
4. **道具消耗/生产**  
   - 使用消耗品更新 `inventory`；营地任务奖励也更新 `inventory` 或 `user_cards`。
5. **技能强化**  
   - 解锁技能写入 `user_skills`，同步更新 `user_characters` 的属性快照。
6. **出征准备**  
   - 进入地牢前生成 `runs.preparation_snapshot`，包含手牌、道具、货币余量。

---

## 5. 关键问题答疑

### 5.1 用户手牌需要存哪些字段？
- 最低字段：`user_id`、`card_id`、`quantity`、`level`、`is_equipped`、`equipped_to_user_character_id`、`acquired_at`、`acquired_source`。  
- 加值字段：`last_used_at` 用于推荐常用卡、`loadout_label`（可放在 JSON）用于多套牌组方案。

### 5.2 角色、法术、装备是否要拆成多张表？
- **结论**：不需要。统一 `cards` 表，通过 `card_type` 区分，再使用 `stat_modifiers` / `effect_payload` 承载差异化配置，能确保：
  - 商城、掉落、任务奖励逻辑共用同一套代码；
  - 营地展示、筛选与排序统一处理；
  - 后续新增“传说装备”或“阵营法术”时只需新增枚举和配置。
- 如需额外的装备位校验或法术动画，可在服务层或 JSON 配置中处理。

### 5.3 道具表如何支持商城？
- `items` 作为通用道具描述表；
- `shop_offers` 负责上架逻辑，可指向 `cards` 或 `items`；
- `inventory` 只存玩家实有数量；
- 若后续需要礼包或随机箱，可扩展 `offer_type=bundle` 并在 `effect_payload` 里列出掉落池。

### 5.4 法术不需要冷却、装备无耐久如何建模？
- 在 `cards` 表中省略冷却字段，只维护 `mana_cost`；
- 装备的持续效果放入 `stat_modifiers` 或 `effect_payload`，装备槽限制通过 `slot_type` 控制；
- 若想记录装备被拆解，可以在 `player_actions` 中记录相关事件，无需额外字段。

---

## 6. 后续待办

1. 根据本设计更新后端实体与 Mapper；
2. 调整前端 Pinia store，按表字段拉通营地数据；
3. 为 `runs` 与 `game_metrics` 增加营地维度统计；
4. 编写营地聚合 API（返回“营地仪表盘”数据块，减少接口调用次数）。

---

## 7. 版本历史

- **v1.1（2025-11-13）**：重构营地界面数据需求，统一卡牌模型，新增商城与营地设施表设计。
- **v1.0（2023-10-27）**：初版发布，围绕 L.I.G.H.T. 架构规划整体方向。