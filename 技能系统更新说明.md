# 技能系统更新说明

## 一、新增技能数据

### 1.1 SQL文件位置
- 文件：`database/add_more_skills.sql`
- 包含16个新技能（每个职业4个）

### 1.2 新增技能列表

#### 守望者 (warden) - 4个新技能
1. **神圣力量**（被动，Lv.3）- 提升攻击力15%，神圣伤害+10%
2. **法力源泉**（被动，Lv.3）- 提升法力值上限20%
3. **神圣审判**（主动，Lv.5）- 单体神圣攻击，对邪恶敌人双倍伤害
4. **守护者意志**（被动，Lv.5）- 提升生命值25%，物理防御30%

#### 秘术师 (occultist) - 4个新技能
1. **暗影之力**（被动，Lv.3）- 提升攻击力20%，魔法穿透15%
2. **暗影源泉**（被动，Lv.3）- 提升法力值上限25%
3. **暗影风暴**（主动，Lv.5）- 群体暗影攻击，持续伤害
4. **暗影体质**（被动，Lv.5）- 提升生命值15%，每回合恢复5点法力

#### 游侠 (ranger) - 4个新技能
1. **精准之力**（被动，Lv.3）- 提升攻击力18%，暴击率10%
2. **自然源泉**（被动，Lv.3）- 提升法力值上限20%
3. **箭雨风暴**（主动，Lv.5）- 群体物理攻击，3次连击
4. **猎手体魄**（被动，Lv.5）- 提升生命值20%，攻击速度15%

#### 战士 (warrior) - 4个新技能
1. **狂暴之力**（被动，Lv.3）- 提升攻击力25%，护甲穿透20%
2. **战斗意志**（被动，Lv.3）- 提升法力值上限15%
3. **大地震击**（主动，Lv.5）- 群体物理攻击，造成眩晕
4. **钢铁意志**（被动，Lv.5）- 提升生命值30%，攻击力15%

### 1.3 使用方法
执行SQL文件将新技能添加到数据库：
```sql
-- 在MySQL中执行
source database/add_more_skills.sql;
-- 或者直接复制SQL内容执行
```

## 二、技能树展示页面更新

### 2.1 主要改动

#### ✅ 分开展示主动和被动技能
- 主动技能区域：显示所有非被动技能（attack、heal、buff、debuff等）
- 被动技能区域：显示所有被动技能（passive、passive_trigger）
- 每个区域有独立的标题和技能树

#### ✅ 缩小技能图标
- 技能节点大小：从 `140rpx × 140rpx` 缩小到 `100rpx × 100rpx`
- 节点间距：从 `180rpx` 缩小到 `130rpx`
- 图标字体：从 `60rpx` 缩小到 `45rpx`
- 技能名称字体：从 `24rpx` 缩小到 `20rpx`
- 等级要求字体：从 `22rpx` 缩小到 `18rpx`

#### ✅ 删除已学习技能区域
- 完全移除了"已学习技能"展示区域
- 移除了相关的计算属性和样式代码

#### ✅ 技能树占满整个弹窗
- 弹窗高度：从 `80vh` 增加到 `85vh`
- 弹窗宽度：从 `85%` 增加到 `90%`
- 技能树容器使用 `flex: 1` 占满剩余空间
- 主动和被动技能区域垂直排列，占满整个弹窗

### 2.2 技能详情弹窗优化

#### 新增功能：
1. **技能类型标签**：
   - 主动技能：蓝色标签
   - 被动技能：紫色标签

2. **被动技能属性提升显示**：
   - 自动解析 `effectPayload` 中的属性提升
   - 显示攻击力、法力值、生命值、防御等提升效果
   - 支持百分比和固定数值两种格式

3. **效果值格式化**：
   - 小于1的值显示为百分比（如 0.15 → 15%）
   - 大于等于1的值显示为固定数值（如 20 → 20）

### 2.3 代码结构优化

#### 新增计算属性：
- `activeSkills`：主动技能列表
- `passiveSkills`：被动技能列表
- `sortedActiveSkills`：排序后的主动技能
- `sortedPassiveSkills`：排序后的被动技能
- `activeConnectionLines`：主动技能连接线
- `passiveConnectionLines`：被动技能连接线
- `activeSkillTreeMinHeight`：主动技能树最小高度
- `passiveSkillTreeMinHeight`：被动技能树最小高度

#### 新增函数：
- `isPassiveSkill(skill)`：判断技能是否为被动技能
- `getPassiveEffect(skill, effectKey)`：获取被动技能效果值
- `formatEffectValue(value)`：格式化效果值显示
- `calculateConnectionLines(skillList)`：计算连接线的通用函数
- `calculateSkillTreeMinHeight(skillList)`：计算技能树最小高度的通用函数

## 三、文件修改清单

### 3.1 新增文件
- `database/add_more_skills.sql` - 新增技能SQL脚本
- `技能系统更新说明.md` - 本文档

### 3.2 修改文件
- `frontend/components/SkillsTreePanel.vue` - 技能树组件
  - 分开展示主动和被动技能
  - 缩小图标和间距
  - 删除已学习技能区域
  - 优化技能详情弹窗
  - 添加被动技能属性提升显示

- `frontend/pages/camp/camp.vue` - 营地页面
  - 调整弹窗大小（90%宽度，85vh高度）

## 四、使用说明

### 4.1 执行SQL添加新技能
1. 打开数据库管理工具（如MySQL Workbench、Navicat等）
2. 连接到项目数据库
3. 执行 `database/add_more_skills.sql` 文件
4. 验证技能是否成功添加（每个职业应该有13个技能）

### 4.2 查看技能树
1. 在营地页面点击"技能"按钮
2. 技能树弹窗会显示：
   - 主动技能区域（上方）
   - 被动技能区域（下方）
3. 点击技能节点查看详情
4. 被动技能会显示属性提升效果

### 4.3 技能解锁
- 满足等级要求和前置技能后，可以解锁技能
- 被动技能解锁后会自动生效（需要在后端实现属性计算逻辑）

## 五、后续工作建议

### 5.1 后端实现
需要在后端添加被动技能效果应用到角色属性的逻辑：
- 位置：`PlayerCharacterService` 或新建 `CharacterStatsService`
- 功能：查询用户已解锁的被动技能，计算属性加成，应用到角色属性

### 5.2 前端显示优化
- 在角色信息面板显示技能提供的属性加成
- 区分基础属性和技能加成（用不同颜色显示）

### 5.3 战斗系统集成
- 在战斗中使用主动技能
- 在战斗开始时应用被动技能效果

## 六、注意事项

1. **SQL执行顺序**：确保先执行 `add_more_skills.sql`，新技能的ID从67开始
2. **技能位置**：新技能的位置在 `row: 2-3, column: 4-5`，确保不与现有技能重叠
3. **前置技能**：新技能的前置技能都是现有技能，确保依赖关系正确
4. **effectPayload格式**：所有新技能都使用JSON格式，确保格式正确

## 七、技能效果说明

### 被动技能效果字段：
- `attack_bonus`：攻击力提升（百分比，如 0.15 = 15%）
- `max_mana_bonus`：法力值上限提升（百分比）
- `hp_bonus`：生命值上限提升（百分比）
- `physical_defense_bonus`：物理防御提升（百分比）
- `damage_reduction`：伤害减免（百分比）
- `magic_resistance`：魔法抗性（百分比）
- `crit_chance_bonus`：暴击率提升（百分比）
- `attack_speed_bonus`：攻击速度提升（百分比）
- `mana_regen_per_turn`：每回合法力恢复（固定数值）

### 主动技能效果字段：
- `type`：技能类型（attack、heal、buff、debuff等）
- `damage`：伤害值
- `target`：目标（enemy、ally、all_enemies、all_allies、self）
- `action_cost`：行动点消耗
- `damage_type`：伤害类型（physical、shadow、holy等）

