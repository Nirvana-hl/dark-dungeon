# 商城道具系统接口说明

## 📋 接口概览

### 商城接口（ShopController）

#### 1. 获取商城商品列表
```
GET /api/shop/offers
```
**功能**：获取所有商城商品列表，按 `display_order` 排序  
**认证**：不需要  
**返回**：商品列表，包含商品信息和关联的道具/卡牌详情

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "id": 1,
      "offerType": "item",
      "targetId": 10,
      "price": 100,
      "displayOrder": 1,
      "item": {
        "id": 10,
        "name": "治疗药水",
        "itemType": "consumable",
        "rarity": "common"
      }
    }
  ]
}
```

#### 2. 购买商品
```
POST /api/shop/purchase
Authorization: Bearer {token}
Content-Type: application/json
```
**功能**：购买商城商品（道具或卡牌）  
**认证**：需要  
**请求体**：
```json
{
  "shopOfferId": 1,
  "quantity": 1
}
```

**响应示例**：
```json
{
  "code": 200,
  "message": "成功购买 1 个道具",
  "data": null
}
```

**业务逻辑**：
1. 验证商品是否存在
2. 检查用户余额（默认使用 gold 货币）
3. 扣款
4. 发放物品（道具添加到背包，卡牌添加到用户手牌）

---

### 道具接口（ItemController）

#### 1. 获取道具模板列表
```
GET /api/items?itemType=consumable
```
**功能**：获取道具模板列表  
**认证**：不需要  
**参数**：
- `itemType`（可选）：consumable-消耗品, material-材料, blueprint-蓝图, currency_bundle-货币包, cosmetic-装饰

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "id": 1,
      "code": "health_potion",
      "name": "治疗药水",
      "itemType": "consumable",
      "rarity": "common",
      "effectPayload": "{\"heal\": 20}",
      "stackLimit": 99,
      "shopPrice": 50,
      "description": "恢复20点生命值"
    }
  ]
}
```

#### 2. 获取用户背包
```
GET /api/inventory
Authorization: Bearer {token}
```
**功能**：获取当前用户的背包道具列表  
**认证**：需要

**响应示例**：
```json
{
  "code": 200,
  "message": "操作成功",
  "data": [
    {
      "id": 1,
      "userId": 1,
      "itemId": 10,
      "quantity": 5,
      "bindStatus": "unbound",
      "lastUpdatedAt": "2025-01-01T12:00:00"
    }
  ]
}
```

#### 3. 使用道具
```
POST /api/inventory/use
Authorization: Bearer {token}
Content-Type: application/json
```
**功能**：使用消耗品道具（恢复生命值、减少压力等）  
**认证**：需要  
**请求体**：
```json
{
  "itemId": 10,
  "quantity": 1
}
```

**响应示例**：
```json
{
  "code": 200,
  "message": "成功使用 1 个 治疗药水",
  "data": null
}
```

**业务逻辑**：
1. 验证道具是否存在且为消耗品类型
2. 检查用户背包中是否有足够数量
3. 应用道具效果（根据 `effectPayload` JSON配置）
4. 扣除道具数量（数量为0时删除记录）

**支持的效果类型**：
- `heal`：恢复生命值
- `stress_reduce`：减少压力值

---

## 🗂️ 文件结构

### DTO类
- `PurchaseRequest.java` - 购买请求DTO
- `UseItemRequest.java` - 使用道具请求DTO
- `ItemDTO.java` - 道具模板DTO
- `ShopOfferDetailDTO.java` - 商城商品详情DTO（包含关联信息）

### Service类
- `ShopService.java` - 商城服务
  - `getShopOffers()` - 获取商品列表
  - `purchaseItem()` - 购买商品
  
- `ItemService.java` - 道具服务
  - `getItems()` - 获取道具模板列表
  - `getUserInventory()` - 获取用户背包
  - `useItem()` - 使用道具

### Controller类
- `ShopController.java` - 商城控制器
- `ItemController.java` - 道具控制器

---

## 🔧 核心功能实现

### 1. 购买逻辑
- 支持购买道具和卡牌
- 自动创建钱包（如果不存在）
- 自动合并相同道具/卡牌的数量
- 事务保证：扣款和发放物品的原子性

### 2. 道具使用逻辑
- 只允许使用消耗品类型道具
- 根据 `effectPayload` JSON配置应用效果
- 自动更新角色状态（血量、压力等）
- 自动清理数量为0的道具记录

### 3. 背包管理
- 自动合并相同道具的数量
- 支持堆叠上限（`stackLimit`）
- 记录绑定状态和更新时间

---

## 📝 注意事项

1. **货币系统**：当前默认使用 `gold` 货币，如需支持其他货币，需要扩展 `purchaseItem()` 方法
2. **道具效果**：道具效果通过 JSON 配置，当前支持 `heal` 和 `stress_reduce`，可扩展其他效果
3. **事务处理**：购买和使用道具都使用 `@Transactional` 保证数据一致性
4. **错误处理**：所有接口都有完善的错误处理和参数验证

---

## ✅ 完成状态

- ✅ ShopController - 商城接口
- ✅ ItemController - 道具接口
- ✅ ShopService - 商城业务逻辑
- ✅ ItemService - 道具业务逻辑
- ✅ 相关DTO和Request类
- ✅ 购买逻辑（扣款、发放物品）
- ✅ 道具使用逻辑（应用效果、扣除数量）

所有代码已通过编译检查，可以直接使用！

