# 成就系统设计分析

## 📊 当前设计分析

### 现有表结构

**`achievements` 表（模板表）**
- 存储成就的定义信息
- 所有用户共用
- 字段：`id`, `name`, `category`, `description`, `requirements`

### ❌ 设计问题

1. **缺少用户成就关联表**
   - 当前只有模板表 `achievements`，无法记录用户成就完成状态
   - 无法区分不同用户的成就进度
   - 无法记录成就完成时间
   - 无法追踪成就完成进度

2. **不符合项目设计原则**
   - 项目采用"模板/实例分离"设计模式
   - 其他模块都有对应的实例表：
     - `skills` (模板) → `user_player_character_skills` (实例)
     - `cards` (模板) → `user_cards` (实例)
     - `stages` (模板) → `user_stage_progress` (实例)
   - 成就系统缺少对应的实例表

3. **功能限制**
   - 无法查询用户已完成的成就
   - 无法计算成就完成进度
   - 无法实现成就奖励发放
   - 无法统计用户成就完成率

## ✅ 解决方案

### 设计原则

遵循项目的"模板/实例分离"设计模式：

- **模板表**：`achievements` - 存储成就定义（所有用户共用）
- **实例表**：`user_achievements` - 存储用户成就完成状态（每个用户独立）

### 表结构设计

**`user_achievements` 表（实例表）**

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 实例ID（自增主键） |
| `user_id` (FK) | BIGINT | 用户ID（关联users.id） |
| `achievement_id` (FK) | BIGINT | 成就ID（关联achievements.id） |
| `is_completed` | TINYINT(1) | 是否已完成（0-未完成，1-已完成） |
| `progress` | INT | 完成进度（0-100） |
| `completed_at` | TIMESTAMP | 完成时间（NULL表示未完成） |
| `reward_claimed` | TINYINT(1) | 是否已领取奖励（0-未领取，1-已领取） |
| `created_at` | TIMESTAMP | 创建时间（首次触发该成就时） |
| `updated_at` | TIMESTAMP | 更新时间 |

**唯一约束**：
- `UNIQUE KEY uk_user_achievement (user_id, achievement_id)` - 确保每个用户每个成就只有一条记录

### 设计优势

1. **符合项目规范**
   - 遵循"模板/实例分离"设计原则
   - 与其他模块保持一致

2. **功能完整**
   - 支持查询用户成就列表
   - 支持计算成就完成进度
   - 支持成就奖励发放
   - 支持成就统计

3. **性能优化**
   - 通过唯一索引快速查询用户成就
   - 支持按用户、按成就分类查询
   - 支持按完成状态筛选

4. **扩展性强**
   - 可以记录完成时间，用于排序和统计
   - 可以记录奖励领取状态，防止重复领取
   - 可以记录进度，支持进度条显示

## 🔄 数据流设计

### 成就检查流程

1. **用户触发游戏行为**（如：完成关卡、获得卡牌等）
2. **系统检查成就条件**（根据 `achievements.requirements`）
3. **更新或创建 `user_achievements` 记录**
   - 如果记录不存在，创建新记录（`is_completed=0`, `progress=0`）
   - 如果记录存在，更新进度（`progress`）
   - 如果满足完成条件，设置 `is_completed=1`, `completed_at=当前时间`
4. **通知用户**（可选：弹窗提示、成就解锁动画等）

### 成就查询流程

1. **查询所有成就模板**（`achievements` 表）
2. **查询用户成就实例**（`user_achievements` 表，`user_id=当前用户`）
3. **关联查询**，返回：
   - 成就基本信息（来自 `achievements`）
   - 用户完成状态（来自 `user_achievements`）
   - 完成进度（来自 `user_achievements.progress`）

## 📝 实现建议

### 1. 数据库迁移

创建 `user_achievements` 表：

```sql
CREATE TABLE user_achievements (
    id              BIGINT      NOT NULL AUTO_INCREMENT PRIMARY KEY,
    user_id         BIGINT      NOT NULL,
    achievement_id  BIGINT      NOT NULL,
    is_completed    TINYINT(1)  NOT NULL DEFAULT 0,
    progress        INT         NOT NULL DEFAULT 0,
    completed_at    TIMESTAMP   NULL,
    reward_claimed  TINYINT(1)  NOT NULL DEFAULT 0,
    created_at      TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_achievement (user_id, achievement_id),
    KEY idx_user_achievements_user (user_id),
    KEY idx_user_achievements_achievement (achievement_id),
    KEY idx_user_achievements_completed (user_id, is_completed),
    CONSTRAINT fk_user_achievements_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_user_achievements_achievement FOREIGN KEY (achievement_id) REFERENCES achievements(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 AUTO_INCREMENT=1;
```

### 2. 实体类

创建 `UserAchievement.java` 实体类

### 3. Mapper

创建 `UserAchievementMapper.java` 和对应的 XML 映射文件

### 4. Service

创建 `UserAchievementService.java`，提供：
- 查询用户成就列表
- 更新成就进度
- 检查并完成成就
- 领取成就奖励

### 5. Controller

更新 `AchievementController.java`，添加：
- `GET /achievements/user` - 获取当前登录用户成就列表

## 🎯 总结

**当前设计问题**：
- ❌ 缺少 `user_achievements` 实例表
- ❌ 无法区分不同用户的成就进度
- ❌ 不符合项目"模板/实例分离"设计原则

**解决方案**：
- ✅ 创建 `user_achievements` 表
- ✅ 遵循项目设计规范
- ✅ 支持完整的成就功能

**建议优先级**：
- 🔴 **高优先级**：必须添加，否则无法实现成就系统的核心功能

