# 暗黑地牢 - 需求文档（v1.1）

> **最新更新**：2025-01-XX  
> **文档版本**：v1.1  
> **负责人**：AI 产品助手  
> **项目状态**：开发中

---

## 📖 项目概述

### 项目简介

**暗黑地牢**（Dark Dungeon Roguelike）是一款基于 **Vue 3 + Spring Boot** 技术栈开发的暗黑风格地牢探索类（Roguelike）游戏。玩家将扮演一名冒险者，在充满危险的地牢中探索、战斗、收集卡牌，通过策略搭配和角色养成，挑战更高难度的地牢。

### 项目定位

- **游戏类型**：回合制卡牌战斗 + 地牢探索 + 角色养成
- **目标平台**：Web 浏览器（PC端优先，移动端适配中）
- **开发模式**：前后端分离，双人团队协作开发
- **技术架构**：现代化全栈技术栈

### 核心玩法

1. **角色养成**：选择职业、升级技能树、提升角色属性
2. **卡牌收集**：收集角色卡、法术卡、装备卡，构建专属卡组
3. **地牢探索**：挑战不同难度的地牢，获得奖励和资源
4. **策略战斗**：回合制卡牌战斗，需要合理搭配卡组和策略
5. **压力系统**：独特的压力机制，影响角色战斗表现
6. **营地管理**：在营地中购买道具、调整卡组、恢复状态

### 项目特色

- 🎮 **深度策略**：卡牌组合、角色搭配、技能树选择，多种策略路径
- 🎨 **暗黑风格**：独特的暗黑地牢美术风格和氛围
- 📊 **数据驱动**：完整的游戏数据统计和成就系统
- 🤖 **AI助手**：智能推荐卡组和策略建议
- 🔄 **肉鸽元素**：随机事件、随机掉落，每次探索都有新体验

---

## 🏗️ 技术架构

### 前端技术栈

- **框架**：Vue 3 + TypeScript
- **构建工具**：Vite
- **状态管理**：Pinia
- **路由**：Vue Router
- **UI框架**：Tailwind CSS
- **图标**：Font Awesome

### 后端技术栈

- **框架**：Spring Boot 2.7.18
- **ORM**：MyBatis Plus 3.5.2
- **数据库**：MySQL 8.0+（开发环境支持H2）
- **认证**：Spring Security + JWT
- **API风格**：RESTful API

### 数据库设计

- **主键策略**：自增主键（BIGINT）
- **字符编码**：UTF8MB4
- **存储引擎**：InnoDB
- **设计原则**：模板/实例分离、JSON字段扩展、外键约束

### 项目结构

```
ai-full-stack---dark-dungeon/
├── frontend/              # Vue 3 前端项目
│   ├── src/
│   │   ├── components/    # 组件
│   │   ├── views/         # 页面
│   │   ├── stores/        # Pinia状态管理
│   │   └── lib/           # 工具库
│   └── package.json
├── backend/               # Spring Boot 后端项目
│   ├── src/main/java/com/dungeon/
│   │   ├── controller/    # REST控制器
│   │   ├── service/       # 业务逻辑层
│   │   ├── mapper/        # 数据访问层
│   │   ├── entity/        # 实体类
│   │   └── config/        # 配置类
│   └── pom.xml
├── database/              # 数据库脚本
│   ├── schema_v1_1_mysql.sql          # 表结构
│   ├── migrate_uuid_to_auto_increment.sql  # 迁移脚本
│   └── insert_test_data_auto_increment.sql # 测试数据
├── README.md              # 项目说明
├── 需求文档.md            # 本文档
├── 开发分工方案.md        # 团队分工
└── API接口文档.md         # API规范
```

---

## 🎯 项目目标

### 功能目标

1. **核心玩法实现**
   - ✅ 用户注册登录系统
   - ✅ 角色创建与养成系统
   - ✅ 卡牌收集与卡组管理
   - ✅ 地牢探索与战斗系统
   - ⏳ 技能树系统
   - ⏳ 压力系统与debuff机制
   - ⏳ 成就系统

2. **系统功能**
   - ✅ 钱包与货币系统
   - ✅ 背包与道具系统
   - ⏳ 商城系统
   - ⏳ 营地事件系统
   - ⏳ AI助手推荐系统

3. **数据统计**
   - ⏳ 游戏数据统计
   - ⏳ 玩家行为分析
   - ⏳ 运营数据报表

### 技术目标

1. **代码质量**
   - 遵循SOLID原则
   - 使用设计模式
   - 完善的代码注释
   - 统一的代码风格

2. **性能优化**
   - 数据库查询优化
   - 前端渲染优化
   - API响应时间优化

3. **可维护性**
   - 清晰的代码结构
   - 完善的文档
   - 易于扩展的架构

---

## 📚 文档说明

### 文档结构

本文档包含以下内容：

1. **项目概述**（本章节）：项目介绍、技术架构、项目目标
2. **营地界面概览**：营地功能模块和数据展示
3. **数据库设计**：表结构设计原则和详细说明
4. **数据流与交互**：系统数据流转和交互逻辑
5. **关键问题答疑**：常见问题解答
6. **优化总结**：设计优化和后续待办

### 阅读指南

- **产品经理**：重点关注第1、2、4章节，了解产品功能和交互流程
- **后端开发**：重点关注第3、4章节，了解数据库设计和数据流
- **前端开发**：重点关注第2、4章节，了解界面需求和数据交互
- **测试人员**：重点关注第4章节，了解业务流程和测试场景

---

## 1. 营地界面（Camp）概览

### 1.1 场景目标
营地界面是玩家在每次探索前的准备枢纽，需满足以下目标：
- 让玩家一眼看到当前主力角色、小队状态与资源余量；
- 方便地调整手牌（角色卡、法术、装备）与携带道具；
- 提供技能树、特性、任务与AI建议等深度玩法入口；
- 支撑商城售卖与营地设施互动（锻造、治疗、训练等）。

### 1.2 功能模组拆解
- **主角面板**：关联 `user_characters`、`character_traits`、`skills`，展示等级、生命、压力、已装备卡牌。
- **卡组管理**：读取 `user_cards`、`cards`、`card_tags`，支持手牌筛选、排序、编组。
- **背包与道具**：读取 `inventory`、`items`，显示消耗品数量、用途说明。
- **商城&货币**：读取 `shop_offers`、`user_wallets`，售卖角色卡/法术卡/装备卡与营地道具。
- **任务与事件**：关联 `events`，给出准备目标与奖励。
- **AI助手**：基于 `runs`、`player_actions` 等聚合信息，推送策略建议。

### 1.3 数据展示清单
- **角色栏**：头像、职业、等级、血量/护甲/压力、特性列表、技能树解锁情况。
- **卡组栏**：手牌总览（类型、稀有度、法力消耗）、当前牌组上限、已装备状态。
- **道具栏**：消耗品库存、用途标签、剩余购买次数。
- **货币栏**：金币、魂晶等货币余额，未领取奖励提示。

---

## 2. 数据库重构目标

### 2.1 设计原则
- **一主多从**：区分模板类数据（全局可见）与用户实例数据（私人持有）。
- **类型抽象**：卡牌统一建模，通过类型枚举区分角色牌、法术牌、装备牌，避免重复表。
- **数据可扩展**：保留 JSON/配置字段，便于后续新增特效、数值、策划自定义。
- **营地优先**：所有营地界面数据可通过单次聚合查询获得，减少前端拼装。

### 2.2 表一览

> **阅读指南**：按模块拆分，每行仅展示一张表，包含定位与关键字段，方便快速统计数量与查找。若无特别说明，JSON 字段用于承载易变配置。

| 模块 | 表名 | 类型 | 功能说明 / 关键字段 |
| --- | --- | --- | --- |
| 账号进度 | `users` | 模板 | 基础档案：`player_level`、`player_exp`、`status`(active/banned/dormant) |
| 账号进度 | `user_wallets` | 实例 | 余额：`currency_type`(gold/soulstone/...)、`balance`、`updated_at` |
| 角色与技能 | `player_characters` | 模板 | 主角模板：`code`、`base_hp`、`hp_per_level`、`lore` |
| 角色与技能 | `user_player_characters` | 实例 | 主角实例：`current_hp`、`current_action_points`、`current_stress`、`stress_level`(1-4) |
| 角色与技能 | `stress_debuff_configs` | 配置 | 压力惩罚：`debuff_type`(mental/combat/behavioral)、`trigger_chance`、`effect_payload` |
| 角色与技能 | `card_characters` | 模板 | 角色卡模板：`class`、`faction`、`rarity`、`action_point_cost`、`base_star_level` |
| 角色与技能 | `user_card_characters` | 实例 | 角色卡实例：`current_hp`、`current_armor`、`is_deployed`、`deployed_round` |
| 角色与技能 | `card_character_traits` | 配置 | 特性详情：`type`(positive/negative/neutral)、`effect_payload` |
| 角色与技能 | `skills` | 模板 | 技能树节点：`required_level`、`position_in_tree`({row,column})、`effect_payload` |
| 角色与技能 | `user_skills` | 实例 | 解锁记录：`user_id`、`skill_id`、`unlocked_at` |
| 卡牌与背包 | `cards` | 模板 | 法术/装备模板：`card_type`(spell/equipment)、`slot_type`、`stat_modifiers` |
| 卡牌与背包 | `user_cards` | 实例 | 玩家卡牌：`quantity`、`level`、`loadout_id`、`equipped_to_user_character_id` |
| 卡牌与背包 | `items` | 模板 | 道具模板：`item_type`(consumable/material/...)、`stack_limit`、`effect_payload` |
| 卡牌与背包 | `inventory` | 实例 | 用户道具：`quantity`、`bind_status`(unbound/bound)、`last_updated_at` |
| 营地与经济 | `shop_offers` | 配置 | 商城货架：`offer_type`(card/item/bundle)、`target_id`、`price`、`refresh_rule` |
| 探索与战斗 | `dungeons` | 模板 | 地牢模板：`difficulty`(easy/normal/hard/expert)、`recommended_cards` |
| 探索与战斗 | `runs` | 实例 | 探索记录：`preparation_snapshot`、`result`、`ended_at` |
| 探索与战斗 | `enemies` | 模板 | 敌人设定：`difficulty`、`base_stats`、`behavior_script` |
| 探索与战斗 | `enemy_cards` | 关联 | 敌人卡组：`enemy_id`、`card_id`、`weight` |
| 探索与战斗 | `events` | 配置 | 随机事件：`location_type`(camp/dungeon)、`effect_payload` |
| 统计与洞察 | `player_actions` | 日志 | 行为流水：`action_type`、`source_scene`、`metadata`、`timestamp` |
| 统计与洞察 | `achievements` | 模板 | 成就：`category`(progression/mastery/collection/social)、`requirements` |

> **表分类说明**  
> - 模板：静态策划数据，所有玩家共用  
> - 实例：玩家持有状态或记录  
> - 配置 / 日志：运行参数或数据追踪  
> - 关联：解决多对多关系或权重映射

---

## 3. 详细表结构说明

### 3.1 用户与角色体系

**`users`**  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 用户唯一标识（自增主键） |
| `account_name` | VARCHAR | 显示名称/平台昵称 |
| `email` | VARCHAR | 邮箱，可为空 |
| `player_level` | INT | 玩家等级（用于技能解锁） |
| `player_exp` | BIGINT | 玩家经验值 |
| `created_at` | TIMESTAMP | 注册时间 |
| `status` | ENUM(active, banned, dormant) | 账户状态 |

**`user_wallets`**  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 钱包ID（自增主键） |
| `user_id` (FK→users.id) | BIGINT | 用户ID |
| `balance` | BIGINT | 当前余额 |
| `updated_at` | TIMESTAMP | 最近更新时间 |

**`player_characters`**（玩家角色模板库）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 玩家角色模板ID（自增主键） |
| `code` | VARCHAR | 策划用短码 |
| `name` | VARCHAR | 角色名称 |
| **`base_hp`** | **INT** | **基础血量（用于计算最大血量）** |
| **`hp_per_level`** | **INT** | **每级增加的血量** |
| `lore` | TEXT | 背景故事 |

**`card_characters`**（卡牌角色模板库）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 卡牌角色模板ID（自增主键） |
| `code` | VARCHAR | 策划用短码 |
| `name` | VARCHAR | 角色名称 |
| `class` | ENUM(warrior, occultist, ranger, ... ) | 职业 |
| `faction` | ENUM(human, occult, machine, beast, undead, divine, other) | 阵营/族群标签 |
| `rarity` | ENUM(common, rare, epic, legendary) | 稀有度 |
| `base_hp` | INT | 基础血量 |
| `base_attack` | INT | 基础攻击力 |
| **`action_point_cost`** | **INT** | **上阵所需行动点** 
| `base_star_level` | TINYINT | 初始星级（1-3） |
| `max_star_level` | TINYINT | 星级上限（默认5） |
| `star_upgrade_payload` | JSONB | 星级提升带来的属性/特性增幅配置（例：`{"stats":{"hp":+10,"attack":+3},"traits":{"priest_heal":{"2":+1,"3":+2}}}`） |
| `traits` | JSONB | 特性属性列表 |
| `shop_price` | int | 商城售价 |
| `lore` | TEXT | 背景故事 |

**`user_player_characters`**（玩家职业实例）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 玩家职业实例ID（自增主键） |
| `user_id` (FK→users.id) | BIGINT | **玩家唯一标识** |
| `player_character_id` (FK→player_characters.id) | BIGINT | **玩家职业模板绑定** |
| **`max_hp`** | **INT** | **最大血量（随等级提升）** |
| **`current_hp`** | **INT** | **当前血量（跨关卡继承）** |
| **`max_action_points`** | **INT** | **最大行动点限制（随等级提升）** |
| **`current_action_points`** | **INT** | **当前剩余行动点（每轮重置）** |
| `current_stress` | INT | **当前压力值（跨关卡持续累积）** |
| `stress_level` | INT | **当前压力层级（1-4）** |
| `stress_debuffs` | JSONB | **当前激活的压力debuff列表** |

**`stress_debuff_configs`**（压力debuff配置库）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | debuff配置ID（自增主键） |
| `stress_level` | INT | **触发压力层级（1-4）** |
| `debuff_name` | VARCHAR | debuff名称 |
| `debuff_type` | ENUM(mental, combat, behavioral) | **debuff类型** |
| `effect_description` | TEXT | 效果描述 |
| `trigger_chance` | DECIMAL(3,2) | **触发概率（0.00-1.00）** |
| `effect_payload` | JSONB | **效果参数配置** |
| `is_persistent` | BOOLEAN | **是否为持续效果** |

**`user_card_characters`**（用户持有的卡牌角色）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 卡牌角色实例ID（自增主键） |
| `user_id` (FK→users.id) | BIGINT | 玩家标识 |
| `card_character_id` (FK→card_characters.id) | BIGINT | 卡牌角色模板绑定 |
| `current_hp` | INT | 当前血量（关卡结束重置） |
| `current_armor` | INT | 当前护甲（关卡结束重置） |
| **`is_deployed`** | **BOOLEAN** | **是否已上阵（消耗行动点）** |
| **`deployed_round`** | **INT** | **上阵轮次（用于轮次重置）** |
| `current_star_level` | TINYINT | 当前星级 |

> **星级推进规则**：每消耗 3 张同名角色卡（参考 `user_cards` 中的 `quantity`）即可为对应的 `user_card_characters` 星级 +1，并据 `star_upgrade_payload` 应用属性/技能增幅，直至达到 `max_star_level`。

**`card_character_traits`**（卡牌角色特性）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 特性ID（自增主键） |
| `card_character_id` (FK→card_characters.id) | BIGINT | 卡牌角色模板绑定 |
| `name` | VARCHAR | 特性名称 |
| `type` | ENUM(positive, negative, neutral) | 特性类型 |
| `effect_payload` | JSONB | 基础效果参数（例如：`{"heal_allies":2}`） |
| `scaling_payload` | JSONB | 星级缩放配置（例如：`{"2":{"heal_allies":+1},"3":{"heal_allies":+2}}`） |
| `description` | TEXT | 展示描述 |

> **特性与星级联动**：当 `user_card_characters.current_star_level` 提升时，系统会根据 `card_character_traits.scaling_payload`（或 `card_characters.star_upgrade_payload.traits`）叠加数值，如祭司在 1★ 时全体治疗 2 点，升至 2★ 自动读取配置追加 +1，治疗量变为 3 点。

### 3.2 技能系统（职业专属）

> **最新调整（2025-11-18）**
> - 不再设计“全局通用技能”。每个玩家主角职业（`player_characters` 模板）拥有一棵独立技能树。
> - 数据库层面仍保持逻辑关联，但**不再声明外键**，便于跨库迁移与性能调优。

**`skills`**（职业技能模板库）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 技能模板ID（自增主键） |
| `code` | VARCHAR | 策划短码 |
| `player_character_code` | VARCHAR | 对应的职业短码（与 `player_characters.code` 逻辑关联，**无外键**） |
| `name` | VARCHAR | 技能名称 |
| `description` | TEXT | 技能描述 |
| `effect_payload` | JSONB | 技能效果配置 |
| `required_level` | INT | 解锁所需职业等级 |
| `position_in_tree` | JSONB | {row: INT, column: INT} 技能树坐标 |
| `unlock_path` | JSONB | 前置技能依赖（如 `["battle_focus"]`） |

**`user_player_character_skills`**（职业技能实例表）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 实例ID（自增主键） |
| `user_player_character_id` | BIGINT | 指向玩家的职业实例（仅存ID，**无外键**） |
| `skill_id` | BIGINT | 指向技能模板（仅存ID，**无外键**） |
| `unlocked_at` | TIMESTAMP | 解锁时间 |

**解锁逻辑**：
1. 玩家选择职业后，仅能看到该职业在 `skills` 中定义的技能。
2. 检查 `required_level` 及 `unlock_path`，满足条件后在 `user_player_character_skills` 插入记录。
3. 若后续需要重置/洗点，只需删除对应实例记录即可。

### 3.3 卡牌系统

**`cards`**（统一卡牌池：角色、法术、装备）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 卡牌ID（自增主键） |
| `code` | VARCHAR | 策划短码 |
| `name` | VARCHAR | 卡牌名称 |
| `card_type` | ENUM(spell, equipment) | **卡牌类型（移除character类型）** |
| `rarity` | ENUM(common, rare, epic, legendary) | 稀有度 |
| `slot_type` | ENUM(weapon, armor, trinket, none) | 装备适用槽位（法术为 none） |
| `action_point_cost` | INT | 法术/装备触发所需行动点 |
| `stat_modifiers` | JSONB | 属性变动 |
| `effect_payload` | JSONB | 生效脚本 |
| `camp_unlock_condition` | JSONB | 在营地的解锁条件 |
| `shop_price` | JSONB | {currency_type, amount} |
| `description` | TEXT | 展示描述 |

**`user_cards`**（用户持有手牌实例）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 用户卡牌ID（自增主键） |
| `user_id` (FK→users.id) | BIGINT | 用户ID |
| `card_id` (FK→cards.id) | BIGINT | 卡牌模板ID |
| `quantity` | INT | 持有数量（角色卡一般为1） |
| `level` | INT | 卡牌强化等级（用于法术/装备强化） |
| `loadout_id` | BIGINT | 牌组方案标识（用于多套构筑） |
| `equipped_to_user_card_character_id` (FK→user_card_characters.id) | BIGINT | 装备归属的角色卡实例（法术为空） |
| `acquired_at` | TIMESTAMP | 获得时间 |
| `acquired_source` | VARCHAR | 掉落或购买来源 |
| `last_used_at` | TIMESTAMP | 最近使用时间（AI 推荐参考） |

> **优化说明**：`loadout_id` 仅存在于 `user_cards` 实例表，用于区分同一玩家的多套构筑方案，并配合获取来源、最近使用时间帮助运营与 AI 助手分析；装备类卡牌通过 `equipped_to_user_card_character_id` 直接挂载到某个卡牌角色，明确“装备只作用于卡牌角色”的约束。
> **解释**：卡牌角色（`card_characters`）已独立为单独表，只能在营地商店购买获得。
> 法术、装备存放在 `cards` 表，通过 `card_type` 区分；便于商城、构筑、掉落逻辑的统一处理。若后续需要扩展差异化字段，可在 `stat_modifiers` 或 `effect_payload` 中通过 JSON 配置。

### 3.4 道具、背包与商城

**`items`**（道具与商城货品）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 道具ID（自增主键） |
| `code` | VARCHAR | 策划短码 |
| `name` | VARCHAR | 名称 |
| `item_type` | ENUM(consumable, material, blueprint, currency_bundle, cosmetic) | 类型 |
| `rarity` | ENUM(common, rare, epic, legendary) | 稀有度 |
| `effect_payload` | JSONB | 使用效果（如治疗、增益） |
| `stack_limit` | INT | 单格堆叠上限 |
| `shop_price` | int | 商品价格 |
| `description` | TEXT | 说明 |

**`inventory`**（用户背包）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 背包记录ID（自增主键） |
| `user_id` (FK→users.id) | BIGINT | 用户ID |
| `item_id` (FK→items.id) | BIGINT | 道具模板ID |
| `quantity` | INT | 持有数量 |
| `bind_status` | ENUM(unbound, bound) | 是否绑定 |
| `last_updated_at` | TIMESTAMP | 更新时间 |

**`shop_offers`**（商城上架配置）  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 商城商品ID（自增主键） |
| `offer_type` | VARCHAR | 商品类型：card-卡牌, item-道具, bundle-礼包 |
| `target_id` | BIGINT | 指向 `cards.id` 或 `items.id` |
| `price` | BIGINT | 价格 |
| `display_order` | INT | 前端排序 |
| `refresh_rule` | JSONB | 刷新与限购规则（次数/时间/权重） |

### 3.5 地牢探索与战斗

**`dungeons`**  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 地牢ID（自增主键） |
| `name` | VARCHAR | 地牢名称 |
| `difficulty` | ENUM(easy, normal, hard, expert) | 难度等级 |
| `recommended_cards` | JSONB | 推荐卡牌 |
| `description` | TEXT | 地牢描述 |

**`enemies`**  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 敌人ID（自增主键） |
| `name` | VARCHAR | 敌人名称 |
| `difficulty` | ENUM(easy, normal, hard, boss) | 难度 |
| `base_stats` | JSONB | 基础属性 |

**`enemy_cards`**  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 关联ID（自增主键） |
| `enemy_id` (FK→enemies.id) | BIGINT | 敌人ID |
| `card_id` (FK→cards.id) | BIGINT | 卡牌ID |

**`events`**  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 事件ID（自增主键） |
| `name` | VARCHAR | 事件名称 |
| `location_type` | ENUM(camp, dungeon) | 事件类型 |
| `description` | TEXT | 事件描述 |

**`player_actions`**  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 操作记录ID（自增主键） |
| `user_id` (FK→users.id) | BIGINT | 用户ID |
| `action_type` | VARCHAR | 操作类型 |
| `source_scene` | ENUM(camp, dungeon, battle) | 场景来源 |
| `timestamp` | TIMESTAMP | 时间戳 |

> **优化说明**: 完善了地牢和战斗相关表的详细结构，明确外键约束和字段定义。

### 3.6 成就与指标

**`achievements`**  
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` (PK) | BIGINT | 成就ID（自增主键） |
| `name` | VARCHAR | 成就名称 |
| `category` | ENUM(progression, mastery, collection, social) | 分类 |
| `description` | TEXT | 成就描述 |
| `requirements` | JSONB | 完成条件 |

> **优化说明**: 完善了成就表的详细结构。

---

## 4. 数据流与营地界面交互

1. **进入营地**  
   - 聚合查询 `user_player_characters`（当前主角状态）、`user_card_characters` + `user_cards`（已装备卡与法术/装备）、`inventory`（可用道具）、`user_wallets`（资产）、`shop_offers`（可购买内容）、`events`（营地事件）。
2. **调整牌组**  
   - 前端展示 `cards` + `user_cards`，过滤 `card_type`、`mana_cost`、`rarity`；更新时写入 `is_equipped`、`equipped_to_user_character_id`。
3. **购买商品**  
   - 读取 `shop_offers`，扣减 `user_wallets.balance`，增加 `user_cards` 或 `inventory`。
4. **道具消耗/生产**  
   - 使用消耗品更新 `inventory`；探索奖励或商城购买同步更新 `inventory` / `user_cards`。
5. **技能解锁与强化**  
   - 检查玩家等级 (`users.player_level`) 是否满足技能解锁条件 (`skills.required_level`)
   - 解锁技能写入 `user_skills`，同步更新玩家属性快照
   - 技能树系统通过 `prerequisite_skill_ids` 和 `position_in_tree` 管理技能解锁路径
6. **出征准备**  
   - 进入地牢前生成 `runs.preparation_snapshot`，包含手牌、道具、货币余量。
7. **关卡结束状态重置**  
   - 玩家角色血量、护甲重置为基础值，**压力值跨关卡持续累积**
   - 技能解锁状态保留，玩家等级和经验值保持不变
   - 卡牌角色状态完全重置，不保留任何进度
7. **关卡结束状态重置**  
   - 玩家角色血量、护甲重置为基础值，**压力值跨关卡持续累积**
   - 技能解锁状态保留，玩家等级和经验值保持不变
   - 卡牌角色状态完全重置，不保留任何进度
7. **关卡结束状态重置**  
   - 玩家角色血量、护甲重置为基础值，**压力值跨关卡持续累积**
   - 技能解锁状态保留，玩家等级和经验值保持不变
   - 卡牌角色状态完全重置，不保留任何进度

---

## 5. 关键问题答疑

### 5.1 用户手牌需要存哪些字段？
- 最低字段：`user_id`、`card_id`、`quantity`、`level`、`is_equipped`、`equipped_to_user_character_id`、`acquired_at`、`acquired_source`。  
- 加值字段：`last_used_at` 用于推荐常用卡、`loadout_label`（可放在 JSON）用于多套牌组方案。

### 5.2 角色、法术、装备是否要拆成多张表？
- **结论**：不需要。统一 `cards` 表，通过 `card_type` 区分，再使用 `stat_modifiers` / `effect_payload` 承载差异化配置，能确保：
  - 商城、掉落、任务奖励逻辑共用同一套代码；
  - 营地展示、筛选与排序统一处理；
  - 后续新增"传说装备"或"阵营法术"时只需新增枚举和配置。
- 如需额外的装备位校验或法术动画，可在服务层或 JSON 配置中处理。

### 5.3 道具表如何支持商城？
- `items` 作为通用道具描述表；
- `shop_offers` 负责上架逻辑，可指向 `cards` 或 `items`；
- `inventory` 只存玩家实有数量；
- 若后续需要礼包或随机箱，可扩展 `offer_type=bundle` 并在 `effect_payload` 里列出掉落池。

### 5.4 法术不需要冷却、装备无耐久如何建模？
- 在 `cards` 表中省略冷却字段，只维护 `mana_cost`；
- 装备的持续效果放入 `stat_modifiers` 或 `effect_payload`，装备槽限制通过 `slot_type` 控制；
- 若想记录装备被拆解，可以在 `player_actions` 中记录相关事件，无需额外字段。

---

## 6. 优化总结与后续待办

### 6.1 优化内容总结
1. **删除重复字段**：移除 `characters` 表中与 `base_stats` 重复的数值字段。
2. **补充技能/卡牌字段**：完善 `skills`、`card_characters`、`user_cards` 等表的关键字段（等级、阵营、星级、loadout）。
3. **完善外键约束**：为所有跨表引用添加明确的外键声明，便于 ORM 维护。
4. **增强功能支持**：支持多牌组方案、卡牌角色星级养成、装备对角色卡的绑定逻辑。
5. **移除营地设施系统**：彻底删除 `camp_facilities` / `camp_upgrades` / `user_camp_facilities` / `camp_tasks`，营地以商城 + 事件为核心。
6. **技能系统重构**：改为基于玩家等级解锁机制，建立技能树与解锁流程。

### 6.2 后续待办
1. 根据优化后的设计更新后端实体与 Mapper；
2. 调整前端 Pinia store，按新表结构拉通营地数据；
3. 为 `runs` 增加营地维度统计；
4. 编写营地聚合 API（返回"营地仪表盘"数据块，减少接口调用次数）。
5. 创建数据库迁移脚本，确保平滑升级。

---

---

## 7. 版本历史

### v1.1（2025-01-XX）
- ✅ 重构营地界面数据需求
- ✅ 统一卡牌模型（角色卡、法术卡、装备卡）
- ✅ 新增商城与营地设施表设计
- ✅ 完善技能系统设计（职业专属技能树）
- ✅ 优化数据库设计（模板/实例分离）
- ✅ 迁移到自增主键（BIGINT）

### v1.0（2023-10-27）
- 初版发布
- 围绕 L.I.G.H.T. 架构规划整体方向
- 基础功能模块设计

---

## 8. 附录

### 8.1 术语表

| 术语 | 说明 |
|------|------|
| **肉鸽（Roguelike）** | 一种游戏类型，特点是随机生成、永久死亡、回合制战斗 |
| **模板数据** | 静态策划数据，所有玩家共用（如角色模板、卡牌模板） |
| **实例数据** | 玩家持有状态或记录（如玩家角色、玩家卡牌） |
| **压力系统** | 角色在战斗中累积压力，压力过高会触发debuff |
| **行动点** | 每回合可用的行动次数，用于上阵角色或使用卡牌 |
| **星级** | 角色卡的强化等级，通过消耗同名卡牌提升 |

### 8.2 相关文档

- [README.md](./README.md) - 项目总体说明
- [开发分工方案.md](./开发分工方案.md) - 团队开发分工指南
- [API接口文档.md](./API接口文档.md) - RESTful API接口规范
- [backend/README.md](./backend/README.md) - 后端开发文档

### 8.3 联系方式

- **项目仓库**：GitHub / GitLab
- **问题反馈**：通过Issue提交
- **开发团队**：2人团队（1后端 + 1前端）

---

**文档维护**：本文档会随着项目开发持续更新，请关注版本历史了解最新变更。