# å•†åŸç³»ç»Ÿæ•°æ®åº“è®¾è®¡åˆ†æ

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**é—®é¢˜**ï¼šä¸ºä»€ä¹ˆå•†åŸå†…å®¹æ˜¯ä» `shop_offers` è¡¨ä¸­æŠ½å–ï¼Œè€Œä¸æ˜¯ç›´æ¥ä» `cards` å’Œ `card_characters` è¡¨ä¸­æŠ½å–ï¼Ÿå¹¶ä¸” `shop_offers` è¡¨ä¸­æ˜¾ç¤ºçš„å†…å®¹æœ‰é™ï¼Œä¼¼ä¹ä¸èƒ½æ˜¾ç¤ºå¡ç‰Œè§’è‰²å’Œæ³•æœ¯è£…å¤‡è¡¨ä¸­æ‰€æœ‰å†…å®¹ã€‚

## ğŸ¯ è®¾è®¡åŸç†åˆ†æ

### 1. ä¸ºä»€ä¹ˆä½¿ç”¨ `shop_offers` è¡¨ï¼Ÿ

#### 1.1 æ¨¡æ¿/å®ä¾‹åˆ†ç¦»è®¾è®¡æ¨¡å¼

è¿™æ˜¯é¡¹ç›®é‡‡ç”¨çš„**"æ¨¡æ¿/å®ä¾‹åˆ†ç¦»"**è®¾è®¡åŸåˆ™çš„ä½“ç°ï¼š

- **`cards` è¡¨**ï¼šå¡ç‰Œæ¨¡æ¿åº“ï¼ˆæ‰€æœ‰å¡ç‰Œçš„å®šä¹‰ï¼‰
- **`card_characters` è¡¨**ï¼šè§’è‰²å¡æ¨¡æ¿åº“ï¼ˆæ‰€æœ‰è§’è‰²çš„å®šä¹‰ï¼‰
- **`items` è¡¨**ï¼šé“å…·æ¨¡æ¿åº“ï¼ˆæ‰€æœ‰é“å…·çš„å®šä¹‰ï¼‰
- **`shop_offers` è¡¨**ï¼šå•†åŸä¸Šæ¶é…ç½®ï¼ˆæ§åˆ¶å“ªäº›å•†å“åœ¨å•†åŸä¸­æ˜¾ç¤ºï¼‰

#### 1.2 è®¾è®¡ä¼˜åŠ¿

**â‘  æ§åˆ¶ä¸Šæ¶å•†å“**
- ä¸æ˜¯æ‰€æœ‰å¡ç‰Œ/è§’è‰²éƒ½åº”è¯¥åœ¨å•†åŸä¸­æ˜¾ç¤º
- ä¾‹å¦‚ï¼šæŸäº›å¡ç‰Œå¯èƒ½æ˜¯ä»»åŠ¡å¥–åŠ±ã€æ´»åŠ¨é™å®šï¼Œä¸åº”è¯¥åœ¨å•†åŸå‡ºå”®
- `shop_offers` è¡¨å¯ä»¥ç²¾ç¡®æ§åˆ¶å“ªäº›å•†å“ä¸Šæ¶

**â‘¡ ç‹¬ç«‹çš„ä»·æ ¼ç®¡ç†**
- `cards` å’Œ `card_characters` è¡¨æœ‰ `shop_price` å­—æ®µï¼ˆåŸºç¡€ä»·æ ¼ï¼‰
- `shop_offers` è¡¨æœ‰ `price` å­—æ®µï¼ˆå®é™…å”®ä»·ï¼‰
- å…è®¸å•†åŸä»·æ ¼ä¸åŸºç¡€ä»·æ ¼ä¸åŒï¼ˆä¿ƒé”€ã€æŠ˜æ‰£ç­‰ï¼‰

**â‘¢ å•†åŸç‰¹æœ‰å±æ€§**
- `display_order`ï¼šæ§åˆ¶å•†å“åœ¨å•†åŸä¸­çš„æ˜¾ç¤ºé¡ºåº
- `refresh_rule`ï¼šæ§åˆ¶å•†å“åˆ·æ–°è§„åˆ™ï¼ˆæ¯æ—¥åˆ·æ–°ã€æ¯å‘¨åˆ·æ–°ã€é™è´­æ¬¡æ•°ç­‰ï¼‰
- è¿™äº›å±æ€§ä¸å±äºå¡ç‰Œ/è§’è‰²æœ¬èº«ï¼Œè€Œæ˜¯å•†åŸè¿è¥å±æ€§

**â‘£ çµæ´»çš„åˆ·æ–°æœºåˆ¶**
- å•†åŸå¯ä»¥éšæœºåˆ·æ–°å•†å“ï¼ˆæ¯æ¬¡æ˜¾ç¤ºä¸åŒçš„å•†å“ï¼‰
- åˆ·æ–°æ—¶ä»æ‰€æœ‰æœ‰ `shop_price` çš„å•†å“ä¸­éšæœºé€‰æ‹©
- ä½†åªæœ‰åˆ·æ–°åçš„å•†å“æ‰ä¼šå‡ºç°åœ¨ `shop_offers` è¡¨ä¸­

### 2. æ•°æ®å…³è”æµç¨‹

#### 2.1 æŸ¥è¯¢æµç¨‹

```
å‰ç«¯è¯·æ±‚å•†åŸå•†å“
    â†“
ShopService.getShopOffers()
    â†“
ä» shop_offers è¡¨æŸ¥è¯¢ï¼ˆæŒ‰ display_order æ’åºï¼‰
    â†“
ShopService.toShopOfferDetailDTO()
    â†“
æ ¹æ® offer_type å’Œ target_id å…³è”æŸ¥è¯¢ï¼š
    - offer_type = "item" â†’ æŸ¥è¯¢ items è¡¨
    - offer_type = "card" â†’ æŸ¥è¯¢ cards è¡¨
    - offer_type = "card_character" â†’ æŸ¥è¯¢ card_characters è¡¨
    â†“
è¿”å› ShopOfferDetailDTOï¼ˆåŒ…å«å®Œæ•´ä¿¡æ¯ï¼‰
```

#### 2.2 ä»£ç å®ç°

```java
// ShopService.java - toShopOfferDetailDTO æ–¹æ³•
private ShopOfferDetailDTO toShopOfferDetailDTO(ShopOffer offer) {
    ShopOfferDetailDTO dto = new ShopOfferDetailDTO();
    BeanUtils.copyProperties(offer, dto);  // å¤åˆ¶ shop_offers è¡¨çš„åŸºæœ¬ä¿¡æ¯

    // æ ¹æ®å•†å“ç±»å‹åŠ è½½è¯¦ç»†ä¿¡æ¯
    if ("item".equals(offer.getOfferType())) {
        Item item = itemMapper.selectById(offer.getTargetId());
        if (item != null) {
            ItemDTO itemDTO = new ItemDTO();
            BeanUtils.copyProperties(item, itemDTO);
            dto.setItem(itemDTO);  // å¡«å……é“å…·è¯¦ç»†ä¿¡æ¯
        }
    } else if ("card".equals(offer.getOfferType())) {
        Card card = cardMapper.selectById(offer.getTargetId());
        if (card != null) {
            CardDTO cardDTO = new CardDTO();
            BeanUtils.copyProperties(card, cardDTO);
            dto.setCard(cardDTO);  // å¡«å……å¡ç‰Œè¯¦ç»†ä¿¡æ¯
        }
    } else if ("card_character".equals(offer.getOfferType())) {
        CardCharacter cardCharacter = cardCharacterMapper.selectById(offer.getTargetId());
        if (cardCharacter != null) {
            CardCharacterDTO cardCharacterDTO = new CardCharacterDTO();
            BeanUtils.copyProperties(cardCharacter, cardCharacterDTO);
            dto.setCardCharacter(cardCharacterDTO);  // å¡«å……è§’è‰²è¯¦ç»†ä¿¡æ¯
        }
    }

    return dto;
}
```

### 3. ä¸ºä»€ä¹ˆ `shop_offers` è¡¨å†…å®¹æœ‰é™ï¼Ÿ

#### 3.1 è¡¨ç»“æ„è¯´æ˜

`shop_offers` è¡¨åªå­˜å‚¨**å•†åŸé…ç½®ä¿¡æ¯**ï¼Œä¸å­˜å‚¨å•†å“è¯¦ç»†ä¿¡æ¯ï¼š

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `id` | å•†åŸå•†å“ID | 1 |
| `offer_type` | å•†å“ç±»å‹ | "card_character" |
| `target_id` | æŒ‡å‘ç›®æ ‡è¡¨çš„ID | 5ï¼ˆcard_characters.idï¼‰ |
| `price` | å”®ä»· | 300 |
| `display_order` | æ˜¾ç¤ºé¡ºåº | 1 |
| `refresh_rule` | åˆ·æ–°è§„åˆ™ï¼ˆJSONï¼‰ | `{"refresh_type": "daily"}` |

#### 3.2 è¯¦ç»†ä¿¡æ¯æ¥æº

å•†å“çš„è¯¦ç»†ä¿¡æ¯ï¼ˆåç§°ã€æè¿°ã€å±æ€§ç­‰ï¼‰å­˜å‚¨åœ¨å¯¹åº”çš„æ¨¡æ¿è¡¨ä¸­ï¼š

- **è§’è‰²å¡**ï¼š`card_characters` è¡¨ï¼ˆname, description, base_hp, base_attack, rarity ç­‰ï¼‰
- **æ³•æœ¯/è£…å¤‡å¡**ï¼š`cards` è¡¨ï¼ˆname, description, card_type, rarity, effect_payload ç­‰ï¼‰
- **é“å…·**ï¼š`items` è¡¨ï¼ˆname, description, item_type, rarity, effect_payload ç­‰ï¼‰

#### 3.3 æ•°æ®å…³è”

é€šè¿‡ `target_id` å­—æ®µå…³è”åˆ°å¯¹åº”çš„æ¨¡æ¿è¡¨ï¼š

```sql
-- shop_offers è¡¨ä¸­çš„ä¸€æ¡è®°å½•
id: 1
offer_type: "card_character"
target_id: 5
price: 300

-- å¯¹åº”çš„ card_characters è¡¨ä¸­çš„è®°å½•
id: 5
name: "æš—å½±åˆºå®¢"
description: "æ“…é•¿æš—æ€çš„åˆºå®¢..."
base_hp: 80
base_attack: 25
rarity: "rare"
shop_price: 300
```

### 4. å¦‚ä½•æ˜¾ç¤ºæ‰€æœ‰å•†å“ï¼Ÿ

#### 4.1 å½“å‰è®¾è®¡

**`shop_offers` è¡¨åªå­˜å‚¨å½“å‰ä¸Šæ¶çš„å•†å“**ï¼Œä¸æ˜¯æ‰€æœ‰å•†å“ã€‚

#### 4.2 åˆ·æ–°æœºåˆ¶

å½“ç©å®¶ç‚¹å‡»"åˆ·æ–°å•†åº—"æ—¶ï¼š

```java
// ShopService.refreshShop() æ–¹æ³•
public List<ShopOfferDetailDTO> refreshShop(String shopType) {
    // 1. åˆ é™¤è¯¥å•†åº—ç±»å‹çš„æ‰€æœ‰ç°æœ‰å•†å“
    shopOfferMapper.delete(deleteWrapper);
    
    // 2. ä»æ¨¡æ¿è¡¨ä¸­è·å–æ‰€æœ‰å¯ç”¨çš„å•†å“ï¼ˆåªé€‰æ‹©æœ‰shopPriceä¸”shopPrice > 0çš„ï¼‰
    if ("card_character".equals(shopType)) {
        QueryWrapper<CardCharacter> characterWrapper = new QueryWrapper<>();
        characterWrapper.isNotNull("shop_price")
                .gt("shop_price", 0);
        List<CardCharacter> characters = cardCharacterMapper.selectList(characterWrapper);
        // è·å–æ‰€æœ‰æœ‰ä»·æ ¼çš„è§’è‰²çš„ID
    }
    
    // 3. éšæœºé€‰æ‹©8ä¸ªï¼ˆå¦‚æœå¯ç”¨å•†å“å°‘äº8ä¸ªï¼Œåˆ™å…¨éƒ¨é€‰æ‹©ï¼‰
    Collections.shuffle(availableIds, new Random());
    int count = Math.min(8, availableIds.size());
    
    // 4. åˆ›å»ºæ–°çš„å•†åº—å•†å“è®°å½•
    for (Long targetId : selectedIds) {
        ShopOffer offer = new ShopOffer();
        offer.setOfferType(shopType);
        offer.setTargetId(targetId);
        // ä» card_characters è¡¨çš„ shop_price å­—æ®µè·å–ä»·æ ¼
        CardCharacter character = cardCharacterMapper.selectById(targetId);
        offer.setPrice(character.getShopPrice().longValue());
        shopOfferMapper.insert(offer);
    }
    
    return getShopOffersByType(shopType);
}
```

#### 4.3 æ˜¾ç¤ºæ‰€æœ‰å•†å“çš„æ–¹æ¡ˆ

å¦‚æœä½ æƒ³è®©å•†åŸæ˜¾ç¤ºæ‰€æœ‰å•†å“ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹æ¡ˆï¼š

**æ–¹æ¡ˆ1ï¼šä¿®æ”¹æŸ¥è¯¢é€»è¾‘ï¼ˆæ¨èï¼‰**
- ä¿®æ”¹ `getShopOffersByType()` æ–¹æ³•
- ä¸æŸ¥è¯¢ `shop_offers` è¡¨ï¼Œç›´æ¥æŸ¥è¯¢ `card_characters` è¡¨
- è¿”å›æ‰€æœ‰æœ‰ `shop_price` çš„å•†å“

**æ–¹æ¡ˆ2ï¼šåˆå§‹åŒ–æ‰€æœ‰å•†å“**
- åœ¨æ•°æ®åº“åˆå§‹åŒ–æ—¶ï¼Œä¸ºæ‰€æœ‰æœ‰ `shop_price` çš„å•†å“åˆ›å»º `shop_offers` è®°å½•
- åˆ·æ–°æ—¶ä¸å†åˆ é™¤ï¼Œè€Œæ˜¯æ›´æ–° `display_order`

**æ–¹æ¡ˆ3ï¼šæ··åˆæŸ¥è¯¢**
- æŸ¥è¯¢ `shop_offers` è¡¨è·å–å½“å‰ä¸Šæ¶å•†å“
- åŒæ—¶æŸ¥è¯¢æ¨¡æ¿è¡¨è·å–æ‰€æœ‰å¯ç”¨å•†å“
- å‰ç«¯æ˜¾ç¤ºæ—¶åŒºåˆ†"å½“å‰ä¸Šæ¶"å’Œ"æ‰€æœ‰å¯ç”¨"

## ğŸ“Š æ•°æ®åº“å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   cards         â”‚  â† å¡ç‰Œæ¨¡æ¿åº“ï¼ˆæ‰€æœ‰æ³•æœ¯/è£…å¤‡ï¼‰
â”‚   (æ¨¡æ¿è¡¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ target_id
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  shop_offers    â”‚  â† å•†åŸä¸Šæ¶é…ç½®ï¼ˆå½“å‰ä¸Šæ¶çš„å•†å“ï¼‰
â”‚  (é…ç½®è¡¨)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ target_id
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ card_characters â”‚  â† è§’è‰²å¡æ¨¡æ¿åº“ï¼ˆæ‰€æœ‰è§’è‰²ï¼‰
â”‚   (æ¨¡æ¿è¡¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” å…³é”®ä»£ç ä½ç½®

1. **æŸ¥è¯¢å•†åŸå•†å“**ï¼š`ShopService.getShopOffers()` - ç¬¬72è¡Œ
2. **å…³è”è¯¦ç»†ä¿¡æ¯**ï¼š`ShopService.toShopOfferDetailDTO()` - ç¬¬384è¡Œ
3. **åˆ·æ–°å•†åº—**ï¼š`ShopService.refreshShop()` - ç¬¬118è¡Œ
4. **è´­ä¹°å•†å“**ï¼š`ShopService.purchaseItem()` - ç¬¬211è¡Œ

## ğŸ’¡ è®¾è®¡ä¼˜åŠ¿æ€»ç»“

1. âœ… **çµæ´»æ€§**ï¼šå¯ä»¥æ§åˆ¶å“ªäº›å•†å“ä¸Šæ¶ï¼Œå“ªäº›ä¸ä¸Šæ¶
2. âœ… **ä»·æ ¼ç®¡ç†**ï¼šå•†åŸä»·æ ¼å¯ä»¥ä¸åŸºç¡€ä»·æ ¼ä¸åŒ
3. âœ… **è¿è¥åŠŸèƒ½**ï¼šæ”¯æŒåˆ·æ–°ã€é™è´­ã€æ’åºç­‰å•†åŸè¿è¥åŠŸèƒ½
4. âœ… **æ•°æ®åˆ†ç¦»**ï¼šå•†åŸé…ç½®ä¸å•†å“å®šä¹‰åˆ†ç¦»ï¼Œä¾¿äºç»´æŠ¤
5. âœ… **æ‰©å±•æ€§**ï¼šå¯ä»¥è½»æ¾æ·»åŠ ç¤¼åŒ…ã€é™æ—¶å•†å“ç­‰æ–°ç±»å‹

## ğŸ¯ å»ºè®®

å¦‚æœä½ æƒ³è®©å•†åŸæ˜¾ç¤ºæ‰€æœ‰å•†å“ï¼Œå»ºè®®ï¼š

1. **ä¿®æ”¹ `getShopOffersByType()` æ–¹æ³•**ï¼Œç›´æ¥ä»æ¨¡æ¿è¡¨æŸ¥è¯¢
2. **æˆ–è€…**ï¼šåœ¨æ•°æ®åº“åˆå§‹åŒ–æ—¶ï¼Œä¸ºæ‰€æœ‰æœ‰ `shop_price` çš„å•†å“åˆ›å»º `shop_offers` è®°å½•
3. **æˆ–è€…**ï¼šæ·»åŠ ä¸€ä¸ªæ–°çš„æ¥å£ `getAllAvailableItems()`ï¼Œè¿”å›æ‰€æœ‰å¯ç”¨å•†å“ï¼ˆä¸é™äºå½“å‰ä¸Šæ¶ï¼‰

è¿™æ ·å¯ä»¥ä¿æŒå½“å‰è®¾è®¡çš„çµæ´»æ€§ï¼ŒåŒæ—¶æ»¡è¶³æ˜¾ç¤ºæ‰€æœ‰å•†å“çš„éœ€æ±‚ã€‚

