# 商城系统重构说明

## 📋 重构概述

**重构目标**：将商城系统从使用 `shop_offers` 表改为直接从模板表查询，简化数据流程，提高查询效率。

**重构时间**：2025-01-XX

## 🔄 主要变更

### 1. 查询逻辑变更

#### 之前（使用 shop_offers 表）
```
前端请求 → ShopService.getShopOffersByType() 
→ 查询 shop_offers 表 
→ 根据 target_id 关联查询模板表
→ 返回商品列表
```

#### 现在（直接从模板表查询）
```
前端请求 → ShopService.getShopOffersByType() 
→ 直接查询对应的模板表（card_characters / cards / items）
→ 返回商品列表
```

### 2. 支持的商店类型

| 商店类型 | 查询表 | 筛选条件 |
|---------|--------|---------|
| `card_character` | `card_characters` | `shop_price > 0` 且 `card_type = 'player'` |
| `spell` | `cards` | `card_type = 'spell'` 且 `shop_price` JSON 有有效价格 |
| `equipment` | `cards` | `card_type = 'equipment'` 且 `shop_price` JSON 有有效价格 |
| `item` | `items` | `shop_price > 0` |

### 3. 购买逻辑变更

#### 之前
```json
{
  "shopOfferId": 123,  // shop_offers 表的 ID
  "quantity": 1
}
```

#### 现在（新版本）
```json
{
  "offerType": "card_character",  // 商品类型
  "targetId": 5,                   // 模板表的 ID
  "quantity": 1
}
```

**兼容性**：仍然支持旧版本的 `shopOfferId` 参数，会自动从 `shop_offers` 表查询。

## 📝 代码变更详情

### 1. ShopService.getShopOffersByType()

**位置**：`backend/src/main/java/com/dungeon/service/ShopService.java`

**变更**：
- 移除了对 `shop_offers` 表的查询
- 根据 `shopType` 直接查询对应的模板表
- 自动过滤有 `shop_price` 的商品
- 按稀有度排序

**新增方法**：
- `cardCharacterToShopOfferDTO()` - 角色卡转DTO
- `cardToShopOfferDTO()` - 卡牌转DTO
- `itemToShopOfferDTO()` - 道具转DTO
- `parseCardShopPrice()` - 解析 Card 表的 JSON 价格字段

### 2. ShopService.purchaseItem()

**变更**：
- 支持新版本：直接使用 `offerType` 和 `targetId`
- 兼容旧版本：仍然支持 `shopOfferId`
- 新增 `getPriceFromTemplate()` 方法，从模板表获取价格

### 3. PurchaseRequest DTO

**位置**：`backend/src/main/java/com/dungeon/dto/PurchaseRequest.java`

**新增字段**：
- `offerType` - 商品类型
- `targetId` - 目标ID（模板表ID）

**保留字段**：
- `shopOfferId` - 兼容旧版本

### 4. CampController

**变更**：
- 更新了 `getShopOffersByType()` 接口，支持新的商店类型（`spell`, `equipment`）
- 更新了 `refreshShop()` 接口，支持新的商店类型
- 更新了 `purchaseItem()` 接口，支持新的购买参数

### 5. refreshShop() 方法

**变更**：
- 不再删除和创建 `shop_offers` 记录
- 只是重新查询并随机打乱顺序
- 简化了逻辑，提高了性能

## 🎯 优势

1. **简化数据流程**：不再需要维护 `shop_offers` 表
2. **提高查询效率**：直接查询模板表，减少一次关联查询
3. **显示所有商品**：自动显示所有有 `shop_price` 的商品，不再受限于 `shop_offers` 表的记录
4. **价格一致性**：价格直接从模板表的 `shop_price` 字段获取，保证一致性
5. **易于维护**：减少了数据同步的复杂性

## ⚠️ 注意事项

### 1. shop_offers 表

**现状**：`shop_offers` 表现在不再被使用（除了兼容旧版本的购买接口）。

**建议**：
- 可以保留表结构，用于兼容旧版本
- 或者完全移除，但需要确保所有前端都已更新

### 2. Card 表的 shopPrice 字段

**格式**：JSON 格式 `{"currency_type": "gold", "amount": 300}`

**处理**：使用 `parseCardShopPrice()` 方法解析，只提取 `amount` 字段。

### 3. 前端适配

**需要更新**：
- 购买接口的请求参数（使用新版本的 `offerType` 和 `targetId`）
- 商店类型参数（支持 `spell` 和 `equipment`）

**兼容性**：如果前端仍使用旧版本的 `shopOfferId`，后端会自动兼容。

## 📊 数据库影响

### 不再使用的表
- `shop_offers` - 商城上架配置表（可选，保留用于兼容）

### 使用的表
- `card_characters` - 角色卡模板表
- `cards` - 卡牌模板表（法术/装备）
- `items` - 道具模板表

## 🔍 API 接口变更

### GET /camp/shop-offers/{shopType}

**支持的 shopType**：
- `card_character` - 角色商店
- `spell` - 法术商店
- `equipment` - 装备商店
- `item` - 道具商店

**返回**：所有有 `shop_price` 的商品列表（不再限制为8个）

### POST /camp/purchase

**新版本请求体**：
```json
{
  "offerType": "card_character",
  "targetId": 5,
  "quantity": 1
}
```

**旧版本请求体**（仍然支持）：
```json
{
  "shopOfferId": 123,
  "quantity": 1
}
```

## ✅ 测试建议

1. **查询测试**：
   - 测试各个商店类型是否能正确查询到商品
   - 验证只返回有 `shop_price` 的商品
   - 验证排序是否正确

2. **购买测试**：
   - 测试新版本的购买接口（使用 `offerType` 和 `targetId`）
   - 测试旧版本的购买接口（使用 `shopOfferId`）
   - 验证价格是否正确

3. **刷新测试**：
   - 测试刷新功能是否正常工作
   - 验证商品顺序是否随机打乱

## 📚 相关文件

- `backend/src/main/java/com/dungeon/service/ShopService.java` - 核心服务类
- `backend/src/main/java/com/dungeon/controller/CampController.java` - 控制器
- `backend/src/main/java/com/dungeon/dto/PurchaseRequest.java` - 购买请求DTO
- `backend/src/main/java/com/dungeon/dto/ShopOfferDetailDTO.java` - 商品详情DTO

## 🎉 总结

通过这次重构，商城系统变得更加简洁和高效：
- ✅ 不再依赖 `shop_offers` 表
- ✅ 直接显示所有可用商品
- ✅ 价格直接从模板表获取，保证一致性
- ✅ 支持新的商店类型（法术、装备）
- ✅ 保持向后兼容性

