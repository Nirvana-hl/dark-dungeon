# æ²»ç–—æ•ˆæœç³»ç»Ÿå¯è¡Œæ€§åˆ†ææŠ¥å‘Š

> åˆ†ææ—¥æœŸï¼š2025-01-XX  
> åˆ†æç›®æ ‡ï¼šè¯„ä¼°å¡ç‰Œè§’è‰²ã€è£…å¤‡ã€æ³•æœ¯å¡ç‰Œçš„æ²»ç–—ç­‰æ•ˆæœå®ç°å¯è¡Œæ€§

---

## ğŸ“Š æ€»ä½“ç»“è®º

**âœ… å®Œå…¨å¯è¡Œ** - ä½ çš„æ•°æ®åº“å’Œé¡¹ç›®æ¶æ„å·²ç»å®Œå…¨æ”¯æŒå®ç°å¡ç‰Œè§’è‰²ã€è£…å¤‡ã€æ³•æœ¯å¡ç‰Œçš„æ²»ç–—ç­‰æ•ˆæœã€‚åç«¯ä»£ç å·²ç»å®ç°äº†æ ¸å¿ƒåŠŸèƒ½ï¼Œåªéœ€è¦å®Œå–„ä¸€äº›ç»†èŠ‚ã€‚

---

## 1. æ•°æ®åº“ç»“æ„åˆ†æ

### 1.1 æ ¸å¿ƒæ•°æ®è¡¨

#### âœ… `cards` è¡¨ï¼ˆæ³•æœ¯/è£…å¤‡å¡ç‰Œæ¨¡æ¿ï¼‰
```sql
CREATE TABLE `cards` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `code` varchar(32) NOT NULL,
  `name` varchar(80) NOT NULL,
  `card_type` varchar(20) NOT NULL,  -- 'spell' æˆ– 'equipment'
  `effect_payload` json NOT NULL,    -- æ•ˆæœé…ç½®ï¼ˆJSONæ ¼å¼ï¼‰
  `stat_modifiers` json NOT NULL,   -- å±æ€§åŠ æˆï¼ˆJSONæ ¼å¼ï¼‰
  ...
)
```

**æ”¯æŒçš„æ²»ç–—æ•ˆæœæ ¼å¼**ï¼š
- å•ä½“æ²»ç–—ï¼š`{"type": "heal_single", "heal_amount": 12}`
- æ–°æ ¼å¼æ²»ç–—ï¼š`{"heal": 25, "target": "ally"}`
- ç¾¤ä½“æ²»ç–—ï¼š`{"heal": 30, "target": "all_allies"}`
- æŠ¤ç›¾æ•ˆæœï¼š`{"armor": 15, "target": "ally", "duration": 2}`

**æ•°æ®åº“ç¤ºä¾‹æ•°æ®**ï¼š
```sql
-- åœ£å…‰æœ¯ï¼ˆå•ä½“æ²»ç–—ï¼‰
INSERT INTO cards VALUES (1, 'holy_light', 'åœ£å…‰æœ¯', 'spell', 'rare', 'none', 1, 
  '{}', 
  '{"type": "heal_single", "heal_amount": 12}', 
  ...);

-- æ²»ç–—æœ¯ï¼ˆæ–°æ ¼å¼ï¼‰
INSERT INTO cards VALUES (33, 'heal', 'æ²»ç–—æœ¯', 'spell', 'common', 'none', 2, 
  '{}', 
  '{"heal": 25, "target": "ally"}', 
  ...);

-- ç¾¤ä½“æ²»ç–—
INSERT INTO cards VALUES (36, 'mass_heal', 'ç¾¤ä½“æ²»ç–—', 'spell', 'rare', 'none', 3, 
  '{}', 
  '{"heal": 30, "target": "all_allies"}', 
  ...);
```

#### âœ… `card_characters` è¡¨ï¼ˆè§’è‰²å¡ç‰Œæ¨¡æ¿ï¼‰
```sql
CREATE TABLE `card_characters` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `code` varchar(32) NOT NULL,
  `name` varchar(80) NOT NULL,
  `base_hp` int NOT NULL,
  `base_attack` int NOT NULL,
  ...
)
```

#### âœ… `card_character_traits` è¡¨ï¼ˆè§’è‰²ç‰¹æ€§ï¼‰
```sql
CREATE TABLE `card_character_traits` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `card_character_id` bigint NOT NULL,
  `name` varchar(80) NOT NULL,
  `type` varchar(20) NOT NULL,      -- 'positive' æˆ– 'negative'
  `effect_payload` json NOT NULL,    -- åŸºç¡€æ•ˆæœé…ç½®
  `scaling_payload` json NOT NULL,   -- æ˜Ÿçº§ç¼©æ”¾é…ç½®
  ...
)
```

**æ”¯æŒçš„æ²»ç–—ç‰¹æ€§æ ¼å¼**ï¼š
```sql
-- æ˜Ÿè¾‰ç¥ç¦ï¼ˆæ¯å›åˆæ²»ç–—ï¼‰
INSERT INTO card_character_traits VALUES (1, 1, 'æ˜Ÿè¾‰ç¥ç¦', 'positive', 
  '{"heal_allies": 2}',  -- åŸºç¡€æ•ˆæœï¼šæ¯å›åˆæ²»ç–—2ç‚¹
  '{"2": {"heal_allies": 3}, "3": {"heal_allies": 4}, "4": {"heal_allies": 5}}',  -- æ˜Ÿçº§ç¼©æ”¾
  'æå‡å…¨é˜Ÿæ²»ç–—é‡');
```

#### âœ… `user_cards` è¡¨ï¼ˆç”¨æˆ·å¡ç‰Œå®ä¾‹ï¼‰
```sql
CREATE TABLE `user_cards` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint NOT NULL,
  `card_id` bigint NOT NULL,         -- å…³è” cards è¡¨
  `quantity` int NOT NULL DEFAULT 1,
  `loadout_id` bigint NULL,          -- å¡ç»„IDï¼ˆç”¨äºæˆ˜æ–—ï¼‰
  ...
)
```

#### âœ… `user_card_characters` è¡¨ï¼ˆç”¨æˆ·è§’è‰²å¡å®ä¾‹ï¼‰
```sql
CREATE TABLE `user_card_characters` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint NOT NULL,
  `card_character_id` bigint NOT NULL,  -- å…³è” card_characters è¡¨
  `current_star_level` tinyint NOT NULL DEFAULT 1,  -- æ˜Ÿçº§ï¼ˆç”¨äºç‰¹æ€§ç¼©æ”¾ï¼‰
  `is_deployed` tinyint(1) NOT NULL DEFAULT 0,     -- æ˜¯å¦ä¸Šé˜µ
  ...
)
```

### 1.2 æ•°æ®å…³ç³»é“¾

```
ç”¨æˆ·å¡ç‰Œå®ä¾‹ (user_cards)
  â””â”€ card_id â†’ å¡ç‰Œæ¨¡æ¿ (cards)
      â””â”€ effect_payload â†’ æ²»ç–—æ•ˆæœé…ç½®ï¼ˆJSONï¼‰

ç”¨æˆ·è§’è‰²å¡å®ä¾‹ (user_card_characters)
  â””â”€ card_character_id â†’ è§’è‰²æ¨¡æ¿ (card_characters)
      â””â”€ è§’è‰²ç‰¹æ€§ (card_character_traits)
          â””â”€ effect_payload â†’ ç‰¹æ€§æ²»ç–—æ•ˆæœï¼ˆJSONï¼‰
          â””â”€ scaling_payload â†’ æ˜Ÿçº§ç¼©æ”¾é…ç½®ï¼ˆJSONï¼‰
```

---

## 2. åç«¯ä»£ç å®ç°åˆ†æ

### 2.1 âœ… æ ¸å¿ƒæœåŠ¡ï¼š`CardEffectService`

**ä½ç½®**ï¼š`backend/src/main/java/com/dungeon/service/CardEffectService.java`

#### å·²å®ç°çš„åŠŸèƒ½ï¼š

1. **æ²»ç–—æ•ˆæœæ‰§è¡Œ** (`executeHealEffect`)
   - âœ… æ”¯æŒå¤šç§æ ¼å¼ï¼š`heal`, `heal_amount`, `heal_single`
   - âœ… æ”¯æŒå•ä½“æ²»ç–—ï¼š`target: "ally"` æˆ– `target: "hero"`
   - âœ… æ”¯æŒç¾¤ä½“æ²»ç–—ï¼š`target: "all_allies"` æˆ– `aoe: true`
   - âœ… è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å€¼ä¸Šé™ï¼ˆä¸ä¼šè¶…è¿‡æœ€å¤§HPï¼‰
   - âœ… è®°å½•è¯¦ç»†çš„æˆ˜æ–—æ—¥å¿—

2. **è§’è‰²ç‰¹æ€§æ²»ç–—æ•ˆæœ** (`executeTraitEffect`)
   - âœ… æ”¯æŒ `heal_allies` æ•ˆæœ
   - âœ… æ”¯æŒæ˜Ÿçº§ç¼©æ”¾ï¼ˆé€šè¿‡ `calculateTraitEffectWithScaling`ï¼‰
   - âœ… æ¯å›åˆè‡ªåŠ¨è§¦å‘

3. **å…¶ä»–æ•ˆæœæ”¯æŒ**
   - âœ… ä¼¤å®³æ•ˆæœï¼ˆ`damage`, `damage_single`ï¼‰
   - âœ… æŠ¤ç›¾æ•ˆæœï¼ˆ`armor`, `shield`ï¼‰
   - âœ… Buffæ•ˆæœï¼ˆ`attack_bonus`, `defense_bonus`ï¼‰
   - âœ… ç‰¹æ®Šæ•ˆæœï¼ˆ`lifesteal`, `burn`, `stun`, `freeze`ï¼‰

#### ä»£ç ç¤ºä¾‹ï¼š

```java
// æ‰§è¡Œå¡ç‰Œæ²»ç–—æ•ˆæœ
public void executeCardEffect(String effectPayload, String cardName, 
                              BattleContext context, String target) {
    JSONObject effect = JSON.parseObject(effectPayload);
    if (effect.containsKey("heal") || effect.containsKey("heal_amount")) {
        executeHealEffect(effect, cardName, context, target);
    }
}

// æ‰§è¡Œè§’è‰²ç‰¹æ€§æ²»ç–—æ•ˆæœ
public void executeTraitEffect(String effectPayload, String traitName, 
                               BattleContext context, int starLevel) {
    JSONObject effect = JSON.parseObject(effectPayload);
    if (effect.containsKey("heal_allies")) {
        int healAmount = effect.getIntValue("heal_allies");
        context.setHeroHp(context.getHeroHp() + healAmount);
        context.addLog("ç‰¹æ€§ï¼š" + traitName + "ï¼Œè‹±é›„æ¢å¤ " + healAmount + " ç‚¹ç”Ÿå‘½");
    }
}
```

### 2.2 âœ… æˆ˜æ–—ç³»ç»Ÿé›†æˆï¼š`DungeonService`

**ä½ç½®**ï¼š`backend/src/main/java/com/dungeon/service/DungeonService.java`

#### å·²å®ç°çš„åŠŸèƒ½ï¼š

1. **å¡ç‰ŒåŠ è½½**
   - âœ… ä» `user_cards` è¡¨åŠ è½½ç”¨æˆ·å¡ç»„ï¼ˆ`loadout_id = 1`ï¼‰
   - âœ… ä» `cards` è¡¨è·å–å¡ç‰Œæ¨¡æ¿ï¼ˆåŒ…å« `effect_payload`ï¼‰

2. **è§’è‰²ç‰¹æ€§åŠ è½½**
   - âœ… ä» `user_card_characters` è¡¨åŠ è½½ä¸Šé˜µè§’è‰²ï¼ˆ`is_deployed = true`ï¼‰
   - âœ… ä» `card_character_traits` è¡¨è·å–è§’è‰²ç‰¹æ€§

3. **æˆ˜æ–—æµç¨‹**
   - âœ… æ¯å›åˆå¼€å§‹æ—¶è§¦å‘è§’è‰²ç‰¹æ€§æ•ˆæœ
   - âœ… ç©å®¶å¯ä»¥ä½¿ç”¨å¡ç‰Œï¼ˆéšæœºé€‰æ‹©ï¼‰
   - âœ… å¡ç‰Œæ•ˆæœè‡ªåŠ¨æ‰§è¡Œï¼ˆåŒ…æ‹¬æ²»ç–—ï¼‰

#### ä»£ç ç¤ºä¾‹ï¼š

```java
// åœ¨æˆ˜æ–—ä¸­ä½¿ç”¨å¡ç‰Œ
private void useRandomCard(List<CardDTO> cards, BattleContext context, int availableMana) {
    CardDTO selectedCard = usableCards.get(RANDOM.nextInt(usableCards.size()));
    
    // è‡ªåŠ¨è¯†åˆ«æ²»ç–—æ³•æœ¯çš„ç›®æ ‡
    String target = "enemy";
    if (selectedCard.getCardType().equals("spell")) {
        JSONObject effect = JSON.parseObject(selectedCard.getEffectPayload());
        if (effect.containsKey("heal") || effect.containsKey("heal_amount")) {
            target = "hero"; // æ²»ç–—æ³•æœ¯å¯¹è‹±é›„
        }
    }
    
    // æ‰§è¡Œå¡ç‰Œæ•ˆæœ
    cardEffectService.executeCardEffect(selectedCard.getEffectPayload(), 
                                       selectedCard.getName(), context, target);
}

// æ¯å›åˆå¼€å§‹æ—¶è§¦å‘è§’è‰²ç‰¹æ€§
private void applyCharacterTraitsAtTurnStart(List<CardCharacterTraitDTO> traits, 
                                             BattleContext context, int round) {
    for (CardCharacterTraitDTO trait : traits) {
        JSONObject baseEffect = JSON.parseObject(trait.getEffectPayload());
        JSONObject scaledEffect = cardEffectService.calculateTraitEffectWithScaling(
            baseEffect, trait.getScalingPayload(), starLevel);
        
        if (scaledEffect.containsKey("heal_allies")) {
            int healAmount = scaledEffect.getIntValue("heal_allies");
            context.setHeroHp(context.getHeroHp() + healAmount);
            context.addLog("ç‰¹æ€§ï¼š" + trait.getName() + "ï¼Œè‹±é›„æ¢å¤ " + healAmount + " ç‚¹ç”Ÿå‘½");
        }
    }
}
```

### 2.3 âš ï¸ è£…å¤‡æ•ˆæœå¤„ç†

#### å½“å‰å®ç°ï¼š

1. **å±æ€§åŠ æˆ** (`stat_modifiers`)
   - âœ… è£…å¤‡å¡æœ‰ `stat_modifiers` å­—æ®µï¼ˆJSONæ ¼å¼ï¼‰
   - âœ… å¯ä»¥å­˜å‚¨ `attack`, `hp`, `defense` ç­‰å±æ€§åŠ æˆ
   - âš ï¸ **å½“å‰æœªåœ¨æˆ˜æ–—ä¸­ä½¿ç”¨**ï¼ˆéœ€è¦æ‰‹åŠ¨åº”ç”¨ï¼‰

2. **ç‰¹æ®Šæ•ˆæœ** (`effect_payload`)
   - âœ… è£…å¤‡å¡ä¹Ÿæœ‰ `effect_payload` å­—æ®µ
   - âœ… å¯ä»¥å­˜å‚¨æ²»ç–—ã€æŠ¤ç›¾ç­‰æ•ˆæœ
   - âš ï¸ **å½“å‰æœªåœ¨æˆ˜æ–—ä¸­ä½¿ç”¨**ï¼ˆéœ€è¦æ‰‹åŠ¨åº”ç”¨ï¼‰

#### æ•°æ®åº“ç¤ºä¾‹ï¼š

```sql
-- ç”Ÿå‘½ä¹‹æˆ’ï¼ˆæ¯å›åˆæ¢å¤ç”Ÿå‘½ï¼‰
INSERT INTO cards VALUES (48, 'health_ring', 'ç”Ÿå‘½ä¹‹æˆ’', 'equipment', 'common', 'trinket', 0, 
  '{"hp": 30}',  -- stat_modifiersï¼šå¢åŠ 30ç‚¹HP
  '{"regen": 5}',  -- effect_payloadï¼šæ¯å›åˆæ¢å¤5ç‚¹ç”Ÿå‘½
  ...);
```

---

## 3. æ²»ç–—æ•ˆæœå®ç°æ–¹å¼

### 3.1 æ³•æœ¯å¡ç‰Œæ²»ç–—

#### æ–¹å¼1ï¼šä½¿ç”¨æ³•æœ¯å¡ç‰Œï¼ˆä¸»åŠ¨ä½¿ç”¨ï¼‰

**æ•°æ®é…ç½®**ï¼š
```json
{
  "heal": 25,
  "target": "ally"
}
```

**æ‰§è¡Œæµç¨‹**ï¼š
1. ç©å®¶åœ¨æˆ˜æ–—ä¸­ä½¿ç”¨æ³•æœ¯å¡ç‰Œ
2. ç³»ç»Ÿè¯»å– `cards.effect_payload`
3. è°ƒç”¨ `CardEffectService.executeCardEffect()`
4. æ‰§è¡Œæ²»ç–—æ•ˆæœï¼Œæ¢å¤è‹±é›„ç”Ÿå‘½å€¼
5. è®°å½•æˆ˜æ–—æ—¥å¿—

**ç¤ºä¾‹**ï¼š
- å¡ç‰Œï¼š`æ²»ç–—æœ¯` (`heal`)
- æ•ˆæœï¼šæ¢å¤25ç‚¹ç”Ÿå‘½å€¼
- ç›®æ ‡ï¼šå‹æ–¹ï¼ˆè‹±é›„ï¼‰

#### æ–¹å¼2ï¼šç¾¤ä½“æ²»ç–—

**æ•°æ®é…ç½®**ï¼š
```json
{
  "heal": 30,
  "target": "all_allies",
  "aoe": true
}
```

**æ‰§è¡Œæµç¨‹**ï¼š
- æ²»ç–—æ‰€æœ‰å‹æ–¹å•ä½ï¼ˆå½“å‰å®ç°ä¸­åªæœ‰è‹±é›„ï¼‰

### 3.2 è§’è‰²ç‰¹æ€§æ²»ç–—

#### æ–¹å¼1ï¼šè¢«åŠ¨æ²»ç–—ï¼ˆæ¯å›åˆè§¦å‘ï¼‰

**æ•°æ®é…ç½®**ï¼š
```json
// card_character_traits.effect_payload
{
  "heal_allies": 2
}

// card_character_traits.scaling_payloadï¼ˆæ˜Ÿçº§ç¼©æ”¾ï¼‰
{
  "2": {"heal_allies": 3},
  "3": {"heal_allies": 4},
  "4": {"heal_allies": 5}
}
```

**æ‰§è¡Œæµç¨‹**ï¼š
1. æ¯å›åˆå¼€å§‹æ—¶è‡ªåŠ¨è§¦å‘
2. ç³»ç»Ÿè¯»å–ä¸Šé˜µè§’è‰²çš„ç‰¹æ€§
3. æ ¹æ®è§’è‰²æ˜Ÿçº§è®¡ç®—å®é™…æ²»ç–—æ•ˆæœ
4. æ‰§è¡Œæ²»ç–—æ•ˆæœ
5. è®°å½•æˆ˜æ–—æ—¥å¿—

**ç¤ºä¾‹**ï¼š
- ç‰¹æ€§ï¼š`æ˜Ÿè¾‰ç¥ç¦` (`heal_allies`)
- 1æ˜Ÿæ•ˆæœï¼šæ¯å›åˆæ¢å¤2ç‚¹ç”Ÿå‘½
- 2æ˜Ÿæ•ˆæœï¼šæ¯å›åˆæ¢å¤3ç‚¹ç”Ÿå‘½
- 3æ˜Ÿæ•ˆæœï¼šæ¯å›åˆæ¢å¤4ç‚¹ç”Ÿå‘½

### 3.3 è£…å¤‡å¡ç‰Œæ²»ç–—

#### âš ï¸ å½“å‰çŠ¶æ€ï¼šæœªå®Œå…¨å®ç°

**æ•°æ®é…ç½®**ï¼š
```json
// cards.effect_payloadï¼ˆè£…å¤‡ç‰¹æ®Šæ•ˆæœï¼‰
{
  "regen": 5  // æ¯å›åˆæ¢å¤5ç‚¹ç”Ÿå‘½
}
```

**éœ€è¦å®ç°**ï¼š
1. åœ¨æˆ˜æ–—å¼€å§‹æ—¶åŠ è½½å·²è£…å¤‡çš„è£…å¤‡å¡
2. æ¯å›åˆå¼€å§‹æ—¶è§¦å‘è£…å¤‡çš„æŒç»­æ•ˆæœï¼ˆå¦‚ `regen`ï¼‰
3. åº”ç”¨è£…å¤‡çš„å±æ€§åŠ æˆï¼ˆ`stat_modifiers`ï¼‰

---

## 4. å®ç°å®Œæ•´æ€§è¯„ä¼°

### âœ… å·²å®Œå…¨å®ç°

| åŠŸèƒ½ | æ•°æ®åº“æ”¯æŒ | åç«¯å®ç° | æˆ˜æ–—é›†æˆ | çŠ¶æ€ |
|------|-----------|---------|---------|------|
| æ³•æœ¯å¡ç‰Œæ²»ç–— | âœ… | âœ… | âœ… | **å®Œæˆ** |
| è§’è‰²ç‰¹æ€§æ²»ç–— | âœ… | âœ… | âœ… | **å®Œæˆ** |
| å•ä½“æ²»ç–— | âœ… | âœ… | âœ… | **å®Œæˆ** |
| ç¾¤ä½“æ²»ç–— | âœ… | âœ… | âœ… | **å®Œæˆ** |
| æ˜Ÿçº§ç¼©æ”¾ | âœ… | âœ… | âœ… | **å®Œæˆ** |
| æˆ˜æ–—æ—¥å¿— | âœ… | âœ… | âœ… | **å®Œæˆ** |

### âš ï¸ éƒ¨åˆ†å®ç°ï¼ˆéœ€è¦å®Œå–„ï¼‰

| åŠŸèƒ½ | æ•°æ®åº“æ”¯æŒ | åç«¯å®ç° | æˆ˜æ–—é›†æˆ | çŠ¶æ€ |
|------|-----------|---------|---------|------|
| è£…å¤‡æŒç»­æ•ˆæœ | âœ… | âš ï¸ | âŒ | **éœ€è¦å®ç°** |
| è£…å¤‡å±æ€§åŠ æˆ | âœ… | âš ï¸ | âŒ | **éœ€è¦å®ç°** |
| è£…å¤‡æ²»ç–—æ•ˆæœ | âœ… | âœ… | âŒ | **éœ€è¦é›†æˆ** |

---

## 5. å…·ä½“å®ç°å»ºè®®

### 5.1 è£…å¤‡æ•ˆæœé›†æˆï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

#### é—®é¢˜ï¼š
- è£…å¤‡å¡çš„ `effect_payload` å’Œ `stat_modifiers` åœ¨æˆ˜æ–—ä¸­æ²¡æœ‰è¢«åº”ç”¨

#### è§£å†³æ–¹æ¡ˆï¼š

**æ­¥éª¤1ï¼šåœ¨æˆ˜æ–—å¼€å§‹æ—¶åŠ è½½è£…å¤‡**

```java
// åœ¨ DungeonService.simulateBattle() ä¸­æ·»åŠ 
private List<CardDTO> loadEquippedCards(Long userId) {
    // ä» user_cards è¡¨æŸ¥è¯¢å·²è£…å¤‡çš„è£…å¤‡å¡
    // equipped_to_user_card_character_id IS NOT NULL
    // è¿”å›è£…å¤‡å¡åˆ—è¡¨ï¼ˆåŒ…å« effect_payload å’Œ stat_modifiersï¼‰
}
```

**æ­¥éª¤2ï¼šåº”ç”¨è£…å¤‡å±æ€§åŠ æˆ**

```java
// åœ¨æˆ˜æ–—å¼€å§‹æ—¶åº”ç”¨ stat_modifiers
private void applyEquipmentStats(List<CardDTO> equippedCards, BattleContext context) {
    for (CardDTO equipment : equippedCards) {
        JSONObject statModifiers = JSON.parseObject(equipment.getStatModifiers());
        if (statModifiers.containsKey("hp")) {
            context.setHeroMaxHp(context.getHeroMaxHp() + statModifiers.getIntValue("hp"));
        }
        if (statModifiers.containsKey("attack")) {
            context.setHeroAttack(context.getHeroAttack() + statModifiers.getIntValue("attack"));
        }
    }
}
```

**æ­¥éª¤3ï¼šæ¯å›åˆè§¦å‘è£…å¤‡æŒç»­æ•ˆæœ**

```java
// åœ¨æ¯å›åˆå¼€å§‹æ—¶è§¦å‘è£…å¤‡æ•ˆæœ
private void applyEquipmentEffectsAtTurnStart(List<CardDTO> equippedCards, BattleContext context) {
    for (CardDTO equipment : equippedCards) {
        if (StringUtils.hasText(equipment.getEffectPayload())) {
            JSONObject effect = JSON.parseObject(equipment.getEffectPayload());
            // å¤„ç†æŒç»­æ•ˆæœï¼ˆå¦‚ regenï¼‰
            if (effect.containsKey("regen")) {
                int regenAmount = effect.getIntValue("regen");
                context.setHeroHp(context.getHeroHp() + regenAmount);
                context.addLog("è£…å¤‡ï¼š" + equipment.getName() + "ï¼Œè‹±é›„æ¢å¤ " + regenAmount + " ç‚¹ç”Ÿå‘½");
            }
        }
    }
}
```

### 5.2 å¤šè§’è‰²æ²»ç–—æ”¯æŒï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰

#### å½“å‰é™åˆ¶ï¼š
- å½“å‰å®ç°åªæ”¯æŒæ²»ç–—"è‹±é›„"ï¼ˆå•ä¸€ç›®æ ‡ï¼‰
- å¦‚æœæœªæ¥æ”¯æŒå¤šä¸ªè§’è‰²ä¸Šé˜µï¼Œéœ€è¦æ‰©å±•

#### è§£å†³æ–¹æ¡ˆï¼š

```java
// æ‰©å±• BattleContext æ”¯æŒå¤šä¸ªè§’è‰²
public static class BattleContext {
    private List<Character> allies;  // å‹æ–¹è§’è‰²åˆ—è¡¨
    private List<Character> enemies;  // æ•Œæ–¹è§’è‰²åˆ—è¡¨
    
    // æ²»ç–—æ‰€æœ‰å‹æ–¹
    public void healAllAllies(int amount) {
        for (Character ally : allies) {
            ally.setHp(ally.getHp() + amount);
        }
    }
}
```

---

## 6. æµ‹è¯•éªŒè¯

### 6.1 æ•°æ®åº“æ•°æ®éªŒè¯

**æŸ¥è¯¢æ²»ç–—æ³•æœ¯å¡ç‰Œ**ï¼š
```sql
SELECT id, name, card_type, effect_payload 
FROM cards 
WHERE effect_payload LIKE '%heal%' 
   OR effect_payload LIKE '%heal_amount%';
```

**æŸ¥è¯¢æ²»ç–—è§’è‰²ç‰¹æ€§**ï¼š
```sql
SELECT t.id, t.name, t.effect_payload, t.scaling_payload, c.name as character_name
FROM card_character_traits t
JOIN card_characters c ON t.card_character_id = c.id
WHERE t.effect_payload LIKE '%heal%';
```

### 6.2 åç«¯æ¥å£æµ‹è¯•

**æµ‹è¯•æ³•æœ¯æ²»ç–—**ï¼š
1. åˆ›å»ºç”¨æˆ·å¡ç»„ï¼ˆåŒ…å«æ²»ç–—æ³•æœ¯ï¼‰
2. è°ƒç”¨æˆ˜æ–—æ¥å£ `POST /dungeons/runs/{runId}/battle`
3. æ£€æŸ¥æˆ˜æ–—æ—¥å¿—ä¸­æ˜¯å¦åŒ…å«æ²»ç–—æ•ˆæœ

**æµ‹è¯•è§’è‰²ç‰¹æ€§æ²»ç–—**ï¼š
1. ä¸Šé˜µå¸¦æœ‰æ²»ç–—ç‰¹æ€§çš„è§’è‰²å¡
2. å¼€å§‹æˆ˜æ–—
3. æ£€æŸ¥æ¯å›åˆæ˜¯å¦è‡ªåŠ¨è§¦å‘æ²»ç–—æ•ˆæœ

---

## 7. æ€»ç»“

### âœ… ä¼˜åŠ¿

1. **æ•°æ®åº“ç»“æ„å®Œå–„**ï¼šæ‰€æœ‰å¿…è¦çš„è¡¨å’Œå­—æ®µéƒ½å·²å­˜åœ¨
2. **åç«¯æ ¸å¿ƒåŠŸèƒ½å·²å®ç°**ï¼š`CardEffectService` å®Œæ•´å®ç°äº†æ²»ç–—æ•ˆæœ
3. **æˆ˜æ–—ç³»ç»Ÿå·²é›†æˆ**ï¼šæ³•æœ¯å’Œè§’è‰²ç‰¹æ€§çš„æ²»ç–—æ•ˆæœå·²åœ¨æˆ˜æ–—ä¸­ä½¿ç”¨
4. **æ”¯æŒå¤šç§æ ¼å¼**ï¼šå…¼å®¹æ—§æ ¼å¼å’Œæ–°æ ¼å¼çš„æ•ˆæœé…ç½®
5. **æ”¯æŒæ˜Ÿçº§ç¼©æ”¾**ï¼šè§’è‰²ç‰¹æ€§å¯ä»¥æ ¹æ®æ˜Ÿçº§æå‡æ•ˆæœ

### âš ï¸ éœ€è¦å®Œå–„

1. **è£…å¤‡æ•ˆæœé›†æˆ**ï¼šè£…å¤‡å¡çš„æŒç»­æ•ˆæœå’Œå±æ€§åŠ æˆéœ€è¦åœ¨æˆ˜æ–—ä¸­ä½¿ç”¨
2. **å¤šè§’è‰²æ”¯æŒ**ï¼šå¦‚æœæœªæ¥æ”¯æŒå¤šä¸ªè§’è‰²ï¼Œéœ€è¦æ‰©å±•æ²»ç–—ç›®æ ‡

### ğŸ¯ å»ºè®®

1. **çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰**ï¼š
   - å®Œå–„è£…å¤‡æ•ˆæœåœ¨æˆ˜æ–—ä¸­çš„åº”ç”¨
   - æ·»åŠ è£…å¤‡æ•ˆæœçš„æµ‹è¯•ç”¨ä¾‹

2. **ä¸­æœŸï¼ˆ1ä¸ªæœˆï¼‰**ï¼š
   - å¦‚æœæ”¯æŒå¤šè§’è‰²ï¼Œæ‰©å±•æ²»ç–—ç›®æ ‡ç³»ç»Ÿ
   - ä¼˜åŒ–æ²»ç–—æ•ˆæœçš„è®¡ç®—å’Œæ˜¾ç¤º

3. **é•¿æœŸï¼ˆå¯é€‰ï¼‰**ï¼š
   - æ·»åŠ æ²»ç–—æ•ˆæœçš„å¯è§†åŒ–ï¼ˆå‰ç«¯åŠ¨ç”»ï¼‰
   - æ”¯æŒæ²»ç–—æ•ˆæœçš„æ¡ä»¶è§¦å‘ï¼ˆå¦‚"ç”Ÿå‘½å€¼ä½äº50%æ—¶è§¦å‘"ï¼‰

---

## 8. ç›¸å…³æ–‡ä»¶

- **åç«¯æ•ˆæœç³»ç»Ÿå®ç°è¯´æ˜**ï¼š`åç«¯æ•ˆæœç³»ç»Ÿå®ç°è¯´æ˜.md`
- **æ ¸å¿ƒæœåŠ¡ç±»**ï¼š`backend/src/main/java/com/dungeon/service/CardEffectService.java`
- **æˆ˜æ–—æœåŠ¡ç±»**ï¼š`backend/src/main/java/com/dungeon/service/DungeonService.java`
- **æ•°æ®åº“è„šæœ¬**ï¼š`dark_dungeon.sql`

---

**åˆ†æå®Œæˆæ—¶é—´**ï¼š2025-01-XX  
**åˆ†æè€…**ï¼šAIåŠ©æ‰‹

