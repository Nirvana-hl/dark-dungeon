`

### 关键数据表结构 (核心与扩展)

除了基础的用户（`users`）、游戏账户（`accounts`）等表，我们新增以下核心表：

1.  **characters**: 角色基本信息、职业、等级、属性、当前状态。
2.  **inventory**: 角色背包物品、装备、道具、数量。
3.  **skills**: 角色技能信息、等级、冷却、效果。
4.  **dungeons**: 地牢关卡信息、难度、主题、已解锁状态。
5.  **runs**: 每次地牢探索的记录、开始时间、结束时间、通关结果。
6.  **enemies**: 怪物图鉴信息、属性、技能、掉落物。
7.  **items**: 物品图鉴信息、类型、属性、描述。
8.  **events**: 随机事件信息、触发条件、效果、剧情片段。
9.  **player_actions**: 记录玩家在游戏中的所有操作（移动、攻击、技能释放等）。
10. **achievements**: 成就信息、达成条件、奖励。
11. **game_metrics**: 游戏全局聚合数据、关键指标快照。
12. **ai_agent_state**: 存储Agent的记忆、上下文、版本信息（配合Belief DSL）。

**数据层关键实践**:
*   **RAG基础设施**: 利用 pgvector 作为嵌入式向量数据库，存储所有怪物图鉴、物品描述、剧情碎片、任务指南、角色对话等，形成可供AI检索的知识库。
*   **内生逻辑引擎**: 使用Supabase Database Triggers和Edge Functions实现“信念观察者”:
    *   当玩家角色状态异常（如濒死、压力过高）时，触发玩家级AI进行关注。
    *   当某个地牢区域通过率过低时，触发地牢大师AI进行难度调整。
    *   当某个敌人AI表现异常（如卡死、行为逻辑错误）时，触发地牢大师AI发出预警。
*   **实时引擎**: Supabase Realtime确保前端能够实时接收到游戏状态更新、AI建议、通知等。

---

## 用户界面设计理念 (I: Intelligent Frontend)

### 设计原则
1.  **沉浸式体验**: 暗黑风格UI、音效、震动反馈，营造紧张刺激的地牢氛围。
2.  **简洁高效**: 精简操作流程，核心战斗与探索界面直观易懂，减少信息噪音。
3.  **AI辅助洞察**: 界面突出AI总结的策略建议、地牢情报，而非原始数据堆砌。
4.  **触控优化**: 针对小程序平台，优化按钮大小、滑动操作，提供流畅的触控体验。
5.  **统一美术风格**: 与游戏世界观保持一致的视觉风格与交互逻辑。

### 核心页面设计

### 1. 角色选择与营地 (Character Selection & Camp)
*   **布局**: 角色卡片列表 + 营地背景 + AI助手聊天窗口。
*   **功能**:
    *   **角色管理**: 选择、创建、删除角色，查看角色详细属性。
    *   **营地互动**: 升级角色、装备强化、技能学习、药水制作。
    *   **AI助手**: 常驻聊天窗口，提供角色构建建议、地牢情报、策略指导。
    *   **任务板**: 查看可接受任务，了解奖励与挑战。
*   **特色**: AI根据玩家当前角色状态和下次地牢挑战，主动提供备战建议。

### 2. 地牢探索界面 (Dungeon Exploration UI)
*   **布局**: 俯视角地牢地图 + 角色状态栏 + 技能快捷栏 + 事件/战斗信息弹窗。
*   **功能**:
    *   **地图导航**: 查看已探索区域、未探索路径、特殊房间（宝箱、祭坛）。
    *   **战斗系统**: 角色移动、选择目标、释放技能、使用物品。
    *   **事件触发**: 遭遇随机事件，进行选择或触发战斗。
    *   **角色状态**: 实时显示生命值、压力值、BUFF/DEBUFF。
*   **特色**: AI实时分析战场局势，在危急时刻提供战术建议或预警。

### 3. 战斗结算与通关报告 (Combat & Run Summary)
*   **布局**: 结算面板 + 奖励展示 + AI分析报告。
*   **功能**:
    *   **奖励详情**: 战利品、经验值、金币等获取概览。
    *   **数据统计**: 本次探索击败怪物数、战斗时长、造成的伤害/承受伤害。
    *   **AI分析**: AI根据本次游玩数据，提供策略复盘、失误分析、角色成长建议。
    *   **分享功能**: 一键分享通关截图或高光时刻到社交平台。
*   **特色**: AI自动识别并高亮显示玩家在本次探索中的关键决策点和潜在优化空间。

---

## 性能优化策略 (跨域护栏: 可观测性与成本控制)

除了已实现的批量查询、并发数据获取、缓存策略和实时订阅优化，我们将进一步加强：

### 1. 数据库优化 (H)
*   **索引优化**: 为所有查询频繁的字段（如玩家ID、角色ID、时间戳）创建索引。
*   **分区表**: 针对 `player_actions` 等高写入表考虑按时间或玩家ID进行分区。
*   **pgvector 优化**: 针对RAG知识库中的文本描述进行向量搜索，利用HNSW等索引技术加速检索。

### 2. AI层面优化 (T & L)
*   **成本感知路由 (Cost-Aware Routing)**: 针对AI问答，简单问题（如物品描述查询）优先使用更廉价的模型；复杂问题（如战术分析、角色构建建议）路由到更强大的模型。
*   **Prompt工程优化**: 精炼Prompt，减少Token消耗，提升生成效率。
*   **缓存机制**: 对于重复性高或已预计算的AI响应（如常见的地牢布局、敌人组合）进行缓存。
*   **双轨路由**: 简单AI交互走“快轨”（缓存/轻量模型），复杂AI编排走“质轨”（完整RAG/多工具）。
*   **TTFT (Time To First Token)**: 重点优化AI回答的首字节时间，提升用户体验，利用Vercel AI SDK或类似流式传输能力。

### 3. 可观测性 (Observability)
*   **全链路Trace (LLM Trace)**: 使用云服务商提供的工具或自研工具，完整记录每次AI交互的输入、检索过程、LLM调用、输出，方便问题复现和性能分析。
*   **核心指标监控**:
    *   **质量**: AI建议采纳率、地牢生成平衡性、敌人AI逻辑合理性。
    *   **延迟**: AI响应P50/P95延迟、TTFT。
    *   **成本**: 单位AI调用成本、各AI智能体消耗成本。
    *   **稳定性**: API错误率、AI智能体工作流失败率。
*   **自定义告警**: 基于L.I.G.H.T.的“信念观察者”概念，当核心指标超出阈值时，自动触发告警（如玩家大量卡关、AI模型成本超支）。

### 4. 成本控制 (Cost Management)
*   **预算警报与熔断**: 地牢大师AI的LLM调用预算设置，超支自动发出警报或触发熔断（降级到更廉价模型或拒绝服务）。
*   **双轨路由**: L.I.G.H.T.架构的核心策略，根据问题复杂度、用户角色、重要性动态选择AI模型。
*   **玩家配额管理**: 可配置的AI资源（如AI生成新地牢次数、AI问答次数）配额，防止滥用。

---

## 安全与权限设计 (跨域护栏: 安全与合规)

在现有安全与权限设计的基础上，我们将特别关注游戏场景的隐私和数据安全。

### 1. 数据安全与隐私
*   **RLS (行级安全)**: 严格在数据库层面实现行级安全，确保:
    *   玩家只能访问自己的游戏数据和与自己相关的公开数据。
    *   运营团队可访问聚合数据，访问敏感个体数据需特定授权或脱敏。
*   **数据脱敏**: 对用于地牢大师AI分析的玩家个体敏感数据进行脱敏处理。
*   **AI使用审计日志**: 详细记录所有AI交互的输入、输出，并标记是否涉及敏感信息，用于安全审计。

### 2. AI安全 (Prompt注入防护 & 输出内容过滤)
*   **Prompt注入防护**: 在L.I.G.H.T.架构的Lean Backend或Edge Functions层实施Prompt注入检测与过滤，防止恶意用户通过Prompt诱导AI泄露游戏内容或执行越权操作。
*   **输出内容过滤**: 对AI的生成内容进行敏感词过滤、合规性检查，防止AI生成不当内容（如涉及政治、黄暴恐、歧视性等）。
*   **Human-in-the-loop (人审环节)**:
    *   对于AI生成的关键游戏内容（如剧情事件、特殊物品描述）的修改，建议策划审核。
    *   对于AI提出的高风险预警（如作弊警告），强制人工复核。
    *   对于AI生成的重要通知或公告，强制人工审核。
*   **模型与工具权限**: 严格控制AI智能体可调用的外部工具和可访问的数据权限，遵循最小权限原则。

### 3. 认证与授权
*   **统一认证**: 与微信/QQ等小程序平台现有认证系统对接，实现玩家身份的统一认证。
*   **JWT令牌**: 安全的身份验证和会话管理。
*   **角色与权限**:
    *   **用户**: 普通玩家。
    *   **管理**: 运营、策划、开发。
    *   **权限粒度**: 游戏内功能 - 数据访问。
    *   确保不同角色只能访问其授权范围内的数据和功能。

---

## 项目进度与里程碑

结合已完成的功能，我们将“暗黑地牢肉鸽小程序游戏”的开发分为以下阶段:

### 阶段一: 核心肉鸽玩法 MVP (约3个月)
1.  **用户与身份整合**: 与小程序平台身份系统对接，统一认证。
2.  **核心数据库搭建**: 角色、物品、技能、怪物、地牢数据导入Supabase。
3.  **RAG知识库建设**: 怪物图鉴、物品描述、剧情碎片等摄取、清洗、切片、嵌入(pgvector)。
4.  **地牢探索与战斗 (MVP)**:
    *   **前端UI**: 基础地牢地图、角色状态、战斗界面。
    *   **AI智能体**: 基础的关卡生成AI（固定房间类型、简单路径）、敌人行为AI（基础攻击模式）、玩家AI（提供基础指引）。
    *   **数据流**: 打通玩家AI与Supabase游戏记录、知识库的交互。
5.  **运营后台**: 策划端可查看玩家游玩数据和AI互动记录。
6.  **安全与可观测性**: 基础RLS、Prompt注入防护、AI调用Trace、成本监控。

### 阶段二: AI深度赋能与内容扩展 (约4个月)
1.  **AI地牢生成深化**: 关卡生成AI动态调整房间布局、主题、陷阱分布，增加随机性。
2.  **敌人行为AI增强**: 引入更复杂的敌人AI策略、技能组合。
3.  **事件生成AI**: 增加多样化的随机事件，影响玩家角色状态或提供独特奖励。
4.  **地牢大师AI (数据仪表盘)**: 聚合数据展示游戏整体运营概览。
5.  **知识库沉淀机制**: AI自动从玩家行为数据中提炼新的怪物弱点、物品搭配建议等，建议补充到知识库。
6.  **轻度社交集成 (初步)**: 玩家可分享通关记录，查看好友排行榜。

### 阶段三: 全面智能化与运营融合 (约5个月)
1.  **三级AI智能体全面协同**: 地牢大师AI对关卡生成AI、敌人行为AI、事件生成AI进行宏观指导，各AI智能体深度协作。
2.  **高级内容生成**: AI生成更复杂的剧情分支、特殊BOSS机制、定制化挑战。
3.  **运营决策支持**: 地牢大师AI提供更深度的分析报告（如版本更新策略、付费点优化）。
4.  **深度社交与社区**: 玩家可创建队伍、分享攻略、进行异步PVP挑战。
5.  **性能与美术优化**: 确保系统在各种设备上的良好体验，并持续迭代美术资源。
6.  **持续运营**: 基于玩家反馈和数据分析，持续迭代AI模型、游戏内容和用户体验。

---

## 成功指标与评估

### 技术指标
*   **场景加载时间**: 目标 < 800ms (P90)
*   **AI响应时间 (TTFT)**: 目标 < 1s (P90)
*   **地牢生成速度**: 目标 < 2s (P90)
*   **系统可用性**: 目标 99.9%
*   **并发用户数**: 目标支持5000+并发用户日常使用

### 业务指标
*   **用户活跃度**: 日/周/月活跃用户数、平均游戏时长、AI助手使用频率。
*   **用户留存率**: 7日留存、30日留存。
*   **付费转化率**: 游戏内购转化率、ARPU。
*   **内容消耗度**: 新地牢、新敌人、新事件的玩家体验次数和满意度。
*   **平台采纳率**: 用户对游戏和AI功能的满意度。
*   **AI成本效益**: 单位玩家AI服务成本，与带来的营收/用户粘性提升对比。

### 用户体验指标
*   **玩家满意度**: 对地牢随机性、挑战性、AI策略建议的满意度评分。
*   **操作流畅度**: 游戏卡顿率、操作响应速度。
*   **新手引导**: 新玩家上手时间、核心功能的使用障碍。
*   **错误率**: 游戏Bug率、AI反馈错误率。

---

## 未来发展方向

### 短期目标 (3-6个月)
*   完善三级AI智能体的核心行为（根据Belief DSL进行迭代）。
*   深化与小程序平台的数据集成与AI能力互通。
*   建立全面的性能与成本监控仪表盘。
*   开放API接口，支持未来与外部游戏社区、数据分析平台集成。

### 中期目标 (6-12个月)
*   **AI能力拓展**: 引入多模态AI能力（如语音指令、图像识别辅助内容创作）。
*   **自适应难度曲线**: AI根据玩家实时表现，动态调整游戏难度、敌人强度、掉落率。
*   **AI队友/NPC**: 引入更多角色AI，如AI队友、任务NPC，提供更丰富的互动。
*   **扩展玩法模式**: AI生成PVP、合作模式等新玩法。

### 长期愿景 (1-3年)
*   **AI原生游戏范式**: 平台成为游戏世界观的核心大脑，实现全流程的AI驱动，包括剧情、角色、内容创作。
*   **内容所有权**: 研究AI生成内容的版权与归属问题，确保游戏知识资产安全。
*   **跨平台互通**: 探索与PC、主机等平台进行数据共享与AI模型合作。
*   **游戏元宇宙**: 结合XR技术，构建沉浸式AI游戏环境。

---

**文档版本**: v1.0 | **最后更新**: 2023-10-27 | **编写者**: AI助手 (基于L.I.G.H.T.架构)