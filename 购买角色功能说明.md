# è´­ä¹°è§’è‰²åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·²å®ç°è´­ä¹°è§’è‰²åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥åœ¨å•†åŸä¸­è´­ä¹°å¡ç‰Œè§’è‰²ï¼ˆ`card_characters`ï¼‰ï¼Œè´­ä¹°åè§’è‰²ä¼šè¢«æ·»åŠ åˆ°ç”¨æˆ·çš„è§’è‰²è¡¨ï¼ˆ`user_card_characters`ï¼‰ä¸­ã€‚

## ğŸ—‚ï¸ æ•°æ®æ¨¡å‹

### ç›¸å…³è¡¨ç»“æ„

1. **`card_characters`** - å¡ç‰Œè§’è‰²æ¨¡æ¿è¡¨
   - å­˜å‚¨æ‰€æœ‰å¯è´­ä¹°çš„è§’è‰²æ¨¡æ¿
   - åŒ…å«è§’è‰²çš„åŸºç¡€å±æ€§ã€æ˜Ÿçº§ã€ä»·æ ¼ç­‰ä¿¡æ¯

2. **`user_card_characters`** - ç”¨æˆ·å¡ç‰Œè§’è‰²å®ä¾‹è¡¨
   - å­˜å‚¨ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²å®ä¾‹
   - æ¯ä¸ªè´­ä¹°çš„è§’è‰²éƒ½æ˜¯ç‹¬ç«‹çš„å®ä¾‹
   - åŒ…å«å½“å‰è¡€é‡ã€æŠ¤ç”²ã€ä¸Šé˜µçŠ¶æ€ç­‰

3. **`shop_offers`** - å•†åŸå•†å“è¡¨
   - `offer_type` = `card_character` è¡¨ç¤ºè§’è‰²å•†å“
   - `target_id` æŒ‡å‘ `card_characters.id`

## ğŸ”„ è´­ä¹°æµç¨‹

### 1. å•†åŸå•†å“é…ç½®

åœ¨ `shop_offers` è¡¨ä¸­æ·»åŠ è§’è‰²å•†å“ï¼š
```sql
INSERT INTO shop_offers (offer_type, target_id, price, display_order) 
VALUES ('card_character', 1, 500, 1);
-- offer_type: 'card_character' è¡¨ç¤ºè§’è‰²å•†å“
-- target_id: æŒ‡å‘ card_characters è¡¨çš„ id
-- price: å•†å“ä»·æ ¼
```

### 2. è´­ä¹°æ¥å£

```
POST /api/shop/purchase
Authorization: Bearer {token}
Content-Type: application/json

{
  "shopOfferId": 1,
  "quantity": 1
}
```

### 3. è´­ä¹°é€»è¾‘

1. **éªŒè¯å•†å“**ï¼šæ£€æŸ¥å•†å“æ˜¯å¦å­˜åœ¨ä¸”ç±»å‹ä¸º `card_character`
2. **æ£€æŸ¥ä½™é¢**ï¼šéªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰è¶³å¤Ÿçš„é‡‘å¸
3. **æ‰£æ¬¾**ï¼šä»ç”¨æˆ·é’±åŒ…ä¸­æ‰£é™¤ç›¸åº”é‡‘é¢
4. **å‘æ”¾è§’è‰²**ï¼šä¸ºæ¯ä¸ªè´­ä¹°çš„è§’è‰²åˆ›å»ºç‹¬ç«‹çš„å®ä¾‹è®°å½•åˆ° `user_card_characters` è¡¨

### 4. è§’è‰²å®ä¾‹åˆå§‹åŒ–

è´­ä¹°çš„è§’è‰²å®ä¾‹ä¼šè‡ªåŠ¨åˆå§‹åŒ–ï¼š
- `current_hp` = è§’è‰²æ¨¡æ¿çš„ `base_hp`
- `current_armor` = 0
- `is_deployed` = falseï¼ˆæœªä¸Šé˜µï¼‰
- `deployed_round` = 0
- `current_star_level` = è§’è‰²æ¨¡æ¿çš„ `base_star_level`ï¼ˆé»˜è®¤ä¸º1ï¼‰

## ğŸ“ ä»£ç å®ç°

### ä¿®æ”¹çš„æ–‡ä»¶

1. **`ShopOfferDetailDTO.java`**
   - æ·»åŠ äº† `cardCharacter` å­—æ®µ
   - æ›´æ–°äº†æ³¨é‡Šè¯´æ˜

2. **`ShopService.java`**
   - æ·»åŠ äº† `CardCharacterMapper` å’Œ `UserCardCharacterMapper` ä¾èµ–
   - æ–°å¢ `addCardCharacterToUser()` æ–¹æ³•
   - åœ¨ `purchaseItem()` ä¸­æ·»åŠ äº†å¯¹ `card_character` ç±»å‹çš„æ”¯æŒ
   - åœ¨ `toShopOfferDetailDTO()` ä¸­æ·»åŠ äº†è§’è‰²ä¿¡æ¯çš„åŠ è½½

### æ ¸å¿ƒæ–¹æ³•

```java
/**
 * æ·»åŠ è§’è‰²åˆ°ç”¨æˆ·ï¼ˆå¡ç‰Œè§’è‰²ï¼‰
 * è´­ä¹°è§’è‰²åï¼Œæ¯ä¸ªè§’è‰²éƒ½æ˜¯ç‹¬ç«‹çš„å®ä¾‹ï¼Œæ”¾å…¥ user_card_characters è¡¨
 */
private void addCardCharacterToUser(Long userId, Long cardCharacterId, Integer quantity) {
    // æŸ¥è¯¢è§’è‰²æ¨¡æ¿
    CardCharacter template = cardCharacterMapper.selectById(cardCharacterId);
    if (template == null) {
        throw new RuntimeException("è§’è‰²æ¨¡æ¿ä¸å­˜åœ¨");
    }

    // æ¯ä¸ªè§’è‰²éƒ½æ˜¯ç‹¬ç«‹å®ä¾‹ï¼Œéœ€è¦åˆ›å»ºå¤šä¸ªå®ä¾‹
    for (int i = 0; i < quantity; i++) {
        UserCardCharacter userCardCharacter = new UserCardCharacter();
        userCardCharacter.setUserId(userId);
        userCardCharacter.setCardCharacterId(cardCharacterId);
        // åˆå§‹åŒ–å±æ€§
        userCardCharacter.setCurrentHp(template.getBaseHp());
        userCardCharacter.setCurrentArmor(0);
        userCardCharacter.setIsDeployed(false);
        userCardCharacter.setDeployedRound(0);
        userCardCharacter.setCurrentStarLevel(template.getBaseStarLevel() != null ? template.getBaseStarLevel() : 1);
        userCardCharacterMapper.insert(userCardCharacter);
    }
}
```

## ğŸ¯ è®¾è®¡è¯´æ˜

### ä¸ºä»€ä¹ˆæ¯ä¸ªè§’è‰²éƒ½æ˜¯ç‹¬ç«‹å®ä¾‹ï¼Ÿ

1. **æˆ˜æ–—ç³»ç»Ÿéœ€æ±‚**ï¼šæ¯ä¸ªè§’è‰²åœ¨æˆ˜æ–—ä¸­éƒ½æœ‰ç‹¬ç«‹çš„è¡€é‡ã€æŠ¤ç”²ã€ä¸Šé˜µçŠ¶æ€
2. **æ˜Ÿçº§ç³»ç»Ÿ**ï¼šæ¯ä¸ªè§’è‰²å®ä¾‹å¯ä»¥ç‹¬ç«‹å‡æ˜Ÿ
3. **ç­–ç•¥æ€§**ï¼šç©å®¶å¯ä»¥æ‹¥æœ‰å¤šä¸ªåŒåè§’è‰²ï¼Œç”¨äºä¸åŒçš„æˆ˜æ–—ç­–ç•¥

### ä¸ç©å®¶èŒä¸šçš„åŒºåˆ«

- **`user_player_characters`**ï¼ˆç©å®¶èŒä¸šè¡¨ï¼‰ï¼š
  - å­˜å‚¨ç©å®¶çš„ä¸»è§’èŒä¸š
  - æ¯ä¸ªç”¨æˆ·é€šå¸¸åªæœ‰ä¸€ä¸ª
  - ç”¨äºæŠ€èƒ½æ ‘ã€å‹åŠ›ç³»ç»Ÿç­‰

- **`user_card_characters`**ï¼ˆç”¨æˆ·è§’è‰²è¡¨ï¼‰ï¼š
  - å­˜å‚¨ç©å®¶è´­ä¹°çš„å¡ç‰Œè§’è‰²
  - æ¯ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ª
  - ç”¨äºæˆ˜æ–—ä¸­çš„è§’è‰²ä¸Šé˜µ

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### 1. æŸ¥è¯¢å•†åŸå•†å“ï¼ˆåŒ…å«è§’è‰²ä¿¡æ¯ï¼‰

```
GET /api/shop/offers
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": [
    {
      "id": 1,
      "offerType": "card_character",
      "targetId": 1,
      "price": 500,
      "displayOrder": 1,
      "cardCharacter": {
        "id": 1,
        "name": "æˆ˜å£«",
        "classType": "warrior",
        "rarity": "common",
        "baseHp": 100,
        "baseAttack": 20,
        "shopPrice": 500
      }
    }
  ]
}
```

### 2. è´­ä¹°è§’è‰²

```
POST /api/shop/purchase
{
  "shopOfferId": 1,
  "quantity": 2
}
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 200,
  "message": "æˆåŠŸè´­ä¹° 2 ä¸ªè§’è‰²",
  "data": null
}
```

è´­ä¹°åï¼Œä¼šåœ¨ `user_card_characters` è¡¨ä¸­åˆ›å»º2æ¡è®°å½•ï¼Œæ¯ä¸ªè§’è‰²éƒ½æ˜¯ç‹¬ç«‹çš„å®ä¾‹ã€‚

## âœ… å®ŒæˆçŠ¶æ€

- âœ… æ”¯æŒè´­ä¹°è§’è‰²åŠŸèƒ½
- âœ… è§’è‰²è‡ªåŠ¨æ·»åŠ åˆ° `user_card_characters` è¡¨
- âœ… è§’è‰²å®ä¾‹è‡ªåŠ¨åˆå§‹åŒ–
- âœ… å•†åŸå•†å“åˆ—è¡¨åŒ…å«è§’è‰²ä¿¡æ¯
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†å’Œå‚æ•°éªŒè¯

æ‰€æœ‰ä»£ç å·²é€šè¿‡ç¼–è¯‘æ£€æŸ¥ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼

