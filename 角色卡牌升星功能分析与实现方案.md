# è§’è‰²å¡ç‰Œå‡æ˜ŸåŠŸèƒ½åˆ†æä¸å®ç°æ–¹æ¡ˆ

## ğŸ“‹ éœ€æ±‚åˆ†æ

ç”¨æˆ·å¸Œæœ›å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **å‡æ˜Ÿæ¡ä»¶**ï¼šå½“è§’è‰²å¡ç‰Œæ•°é‡è¾¾åˆ°3åï¼Œå¯ä»¥ç‚¹å‡»å‡æ˜Ÿ
2. **å‡æ˜Ÿæ•ˆæœ**ï¼šå‡æ˜Ÿåï¼Œç©å®¶å±æ€§å€¼å’Œç‰¹æ€§éƒ½å¢åŠ 
3. **æ•°æ®éš”ç¦»**ï¼šäºŒæ˜Ÿçš„è§’è‰²å’Œä¸€æ˜Ÿçš„è§’è‰²åº”è¯¥æ˜¯ä¸åŒçš„è®°å½•ï¼ˆä¸åŒçš„å®ä¾‹ï¼‰
4. **è´­ä¹°é€»è¾‘**ï¼šå•†åº—è´­ä¹°1æ˜Ÿçš„è§’è‰²æ—¶ï¼Œä¸åº”è¯¥æ·»åŠ åˆ°äºŒæ˜Ÿçš„è§’è‰²æ•°é‡ä¸Š

## ğŸ” å½“å‰å®ç°åˆ†æ

### é—®é¢˜1ï¼šè´­ä¹°é€»è¾‘ä¸æ­£ç¡®

**å½“å‰å®ç°**ï¼ˆ`ShopService.addCardCharacterToUser()`ï¼‰ï¼š
```java
// æŸ¥è¯¢æ˜¯å¦å·²æœ‰è¯¥è§’è‰²ï¼ˆåªæ ¹æ® card_character_idï¼Œæ²¡æœ‰åŒºåˆ†æ˜Ÿçº§ï¼‰
QueryWrapper<UserCardCharacter> wrapper = new QueryWrapper<>();
wrapper.eq("user_id", userId)
       .eq("card_character_id", cardCharacterId);
UserCardCharacter existing = userCardCharacterMapper.selectOne(wrapper);

if (existing != null) {
    // å¦‚æœå·²æœ‰è¯¥è§’è‰²ï¼Œå¢åŠ æ•°é‡ï¼ˆæ— è®ºè¯¥è®°å½•æ˜¯å‡ æ˜Ÿï¼‰
    existing.setQuantity(existing.getQuantity() + quantity);
}
```

**é—®é¢˜**ï¼šè´­ä¹°1æ˜Ÿè§’è‰²æ—¶ï¼Œå¦‚æœç”¨æˆ·å·²æœ‰è¯¥è§’è‰²çš„2æ˜Ÿè®°å½•ï¼Œä¼šç›´æ¥åŠ åˆ°2æ˜Ÿè®°å½•çš„æ•°é‡ä¸Šï¼Œè¿™æ˜¯ä¸å¯¹çš„ã€‚

### é—®é¢˜2ï¼šç¼ºå°‘å‡æ˜ŸåŠŸèƒ½

å½“å‰ä»£ç ä¸­æ²¡æœ‰å‡æ˜ŸåŠŸèƒ½çš„å®ç°ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆè®¾è®¡

1. **è´­ä¹°é€»è¾‘ä¿®æ”¹**ï¼š
   - è´­ä¹°è§’è‰²æ—¶ï¼Œåªæ·»åŠ åˆ°1æ˜Ÿè§’è‰²çš„æ•°é‡ä¸Š
   - æŸ¥è¯¢æ¡ä»¶ï¼š`user_id` + `card_character_id` + `current_star_level = 1`

2. **å‡æ˜ŸåŠŸèƒ½å®ç°**ï¼š
   - æ£€æŸ¥1æ˜Ÿè§’è‰²æ•°é‡æ˜¯å¦ >= 3
   - æ¶ˆè€—3ä¸ª1æ˜Ÿè§’è‰²ï¼ˆå‡å°‘æ•°é‡æˆ–åˆ é™¤è®°å½•ï¼‰
   - åˆ›å»ºæ–°çš„2æ˜Ÿè§’è‰²è®°å½•ï¼ˆä¸åŒçš„å®ä¾‹ï¼‰
   - æ ¹æ® `star_upgrade_payload` è®¡ç®—å±æ€§å¢å¹…
   - åº”ç”¨ç‰¹æ€§å¢å¹…

3. **æ•°æ®æ¨¡å‹**ï¼š
   - æ¯ä¸ªæ˜Ÿçº§æ˜¯ç‹¬ç«‹çš„è®°å½•
   - æ¯ä¸ªè®°å½•æœ‰è‡ªå·±çš„ `quantity`ï¼ˆè¯¥æ˜Ÿçº§çš„æ•°é‡ï¼‰
   - æ¯ä¸ªè®°å½•æœ‰è‡ªå·±çš„ `current_star_level`

### æ•°æ®åº“ç»“æ„

å½“å‰ `user_card_characters` è¡¨ç»“æ„å·²ç»æ”¯æŒï¼š
- `current_star_level`ï¼šå½“å‰æ˜Ÿçº§
- `quantity`ï¼šæ‹¥æœ‰æ•°é‡

**å…³é”®ç‚¹**ï¼šéœ€è¦ç¡®ä¿æŸ¥è¯¢æ—¶åŒæ—¶ä½¿ç”¨ `card_character_id` å’Œ `current_star_level` ä½œä¸ºå”¯ä¸€æ€§æ¡ä»¶ã€‚

## ğŸ¯ å®ç°æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹è´­ä¹°é€»è¾‘

ä¿®æ”¹ `ShopService.addCardCharacterToUser()`ï¼Œè´­ä¹°æ—¶åªæ·»åŠ åˆ°1æ˜Ÿè§’è‰²ï¼š

```java
private void addCardCharacterToUser(Long userId, Long cardCharacterId, Integer quantity) {
    // æŸ¥è¯¢æ˜¯å¦å·²æœ‰è¯¥è§’è‰²çš„1æ˜Ÿè®°å½•
    QueryWrapper<UserCardCharacter> wrapper = new QueryWrapper<>();
    wrapper.eq("user_id", userId)
           .eq("card_character_id", cardCharacterId)
           .eq("current_star_level", 1);  // åªæŸ¥è¯¢1æ˜Ÿè§’è‰²
    UserCardCharacter existing = userCardCharacterMapper.selectOne(wrapper);

    if (existing != null) {
        // å¦‚æœå·²æœ‰1æ˜Ÿè§’è‰²ï¼Œå¢åŠ æ•°é‡
        existing.setQuantity(existing.getQuantity() + quantity);
        userCardCharacterMapper.updateById(existing);
    } else {
        // å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºæ–°çš„1æ˜Ÿè§’è‰²è®°å½•
        // ...
    }
}
```

### ç¬¬äºŒæ­¥ï¼šå®ç°å‡æ˜ŸåŠŸèƒ½

åœ¨ `UserCardCharacterService` ä¸­æ·»åŠ å‡æ˜Ÿæ–¹æ³•ï¼š

```java
/**
 * å‡æ˜ŸåŠŸèƒ½
 * æ¶ˆè€—3ä¸ªå½“å‰æ˜Ÿçº§çš„è§’è‰²ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æ›´é«˜æ˜Ÿçº§çš„è§’è‰²è®°å½•
 */
@Transactional
public UserCardCharacterDTO upgradeStarLevel(Long userId, Long userCardCharacterId) {
    // 1. æŸ¥è¯¢å½“å‰è§’è‰²è®°å½•
    UserCardCharacter current = userCardCharacterMapper.selectById(userCardCharacterId);
    if (current == null || !current.getUserId().equals(userId)) {
        throw new RuntimeException("è§’è‰²ä¸å­˜åœ¨æˆ–ä¸å±äºå½“å‰ç”¨æˆ·");
    }
    
    // 2. æ£€æŸ¥æ•°é‡æ˜¯å¦è¶³å¤Ÿï¼ˆéœ€è¦3ä¸ªï¼‰
    if (current.getQuantity() < 3) {
        throw new RuntimeException("è§’è‰²æ•°é‡ä¸è¶³ï¼Œéœ€è¦3ä¸ªæ‰èƒ½å‡æ˜Ÿ");
    }
    
    // 3. æ£€æŸ¥æ˜¯å¦å·²è¾¾åˆ°æœ€å¤§æ˜Ÿçº§
    CardCharacter template = cardCharacterMapper.selectById(current.getCardCharacterId());
    if (current.getCurrentStarLevel() >= template.getMaxStarLevel()) {
        throw new RuntimeException("å·²è¾¾åˆ°æœ€å¤§æ˜Ÿçº§");
    }
    
    // 4. æ¶ˆè€—3ä¸ªå½“å‰æ˜Ÿçº§çš„è§’è‰²
    current.setQuantity(current.getQuantity() - 3);
    if (current.getQuantity() <= 0) {
        // å¦‚æœæ•°é‡ä¸º0ï¼Œåˆ é™¤è®°å½•
        userCardCharacterMapper.deleteById(userCardCharacterId);
    } else {
        userCardCharacterMapper.updateById(current);
    }
    
    // 5. åˆ›å»ºæ–°çš„æ›´é«˜æ˜Ÿçº§è§’è‰²è®°å½•
    int newStarLevel = current.getCurrentStarLevel() + 1;
    
    // æŸ¥è¯¢æ˜¯å¦å·²æœ‰è¯¥æ˜Ÿçº§çš„è®°å½•
    QueryWrapper<UserCardCharacter> wrapper = new QueryWrapper<>();
    wrapper.eq("user_id", userId)
           .eq("card_character_id", current.getCardCharacterId())
           .eq("current_star_level", newStarLevel);
    UserCardCharacter existingHigher = userCardCharacterMapper.selectOne(wrapper);
    
    if (existingHigher != null) {
        // å¦‚æœå·²æœ‰è¯¥æ˜Ÿçº§è®°å½•ï¼Œå¢åŠ æ•°é‡
        existingHigher.setQuantity(existingHigher.getQuantity() + 1);
        userCardCharacterMapper.updateById(existingHigher);
        return toDTO(existingHigher);
    } else {
        // åˆ›å»ºæ–°çš„æ›´é«˜æ˜Ÿçº§è®°å½•
        UserCardCharacter newCharacter = new UserCardCharacter();
        newCharacter.setUserId(userId);
        newCharacter.setCardCharacterId(current.getCardCharacterId());
        newCharacter.setCurrentStarLevel(newStarLevel);
        newCharacter.setQuantity(1);
        
        // æ ¹æ® star_upgrade_payload è®¡ç®—å±æ€§å¢å¹…
        applyStarUpgrade(newCharacter, template, newStarLevel);
        
        userCardCharacterMapper.insert(newCharacter);
        return toDTO(newCharacter);
    }
}

/**
 * åº”ç”¨æ˜Ÿçº§æå‡å¸¦æ¥çš„å±æ€§å¢å¹…
 */
private void applyStarUpgrade(UserCardCharacter character, CardCharacter template, int starLevel) {
    // è§£æ star_upgrade_payload
    JSONObject upgradePayload = JSON.parseObject(template.getStarUpgradePayload());
    
    // è®¡ç®—åŸºç¡€å±æ€§å¢å¹…
    JSONObject stats = upgradePayload.getJSONObject("stats");
    if (stats != null) {
        int hpBonus = stats.getIntValue("hp", 0) * (starLevel - 1);
        int attackBonus = stats.getIntValue("attack", 0) * (starLevel - 1);
        
        character.setCurrentHp(template.getBaseHp() + hpBonus);
        // æ³¨æ„ï¼šæ”»å‡»åŠ›å¯èƒ½éœ€è¦å­˜å‚¨åœ¨å…¶ä»–å­—æ®µï¼Œæˆ–è€…é€šè¿‡è®¡ç®—å¾—å‡º
    }
    
    // ç‰¹æ€§å¢å¹…åœ¨æˆ˜æ–—æ—¶æ ¹æ®æ˜Ÿçº§åŠ¨æ€è®¡ç®—ï¼Œä¸éœ€è¦å­˜å‚¨
}
```

### ç¬¬ä¸‰æ­¥ï¼šæ·»åŠ Controlleræ¥å£

åœ¨ `UserCardCharacterController` ä¸­æ·»åŠ å‡æ˜Ÿæ¥å£ï¼š

```java
/**
 * å‡æ˜ŸåŠŸèƒ½
 * POST /user-card-characters/{id}/upgrade-star
 */
@PostMapping("/{id}/upgrade-star")
public Result<UserCardCharacterDTO> upgradeStarLevel(
        @PathVariable Long id,
        HttpServletRequest request) {
    try {
        Long userId = getUserIdFromRequest(request);
        UserCardCharacterDTO result = userCardCharacterService.upgradeStarLevel(userId, id);
        return Result.success("å‡æ˜ŸæˆåŠŸ", result);
    } catch (Exception e) {
        return Result.error("å‡æ˜Ÿå¤±è´¥: " + e.getMessage());
    }
}
```

## ğŸ“Š æ•°æ®æµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šè´­ä¹°å’Œå‡æ˜Ÿæµç¨‹

1. **åˆå§‹çŠ¶æ€**ï¼šç”¨æˆ·æ²¡æœ‰"æš—å½±åˆºå®¢"è§’è‰²

2. **è´­ä¹°1ä¸ª"æš—å½±åˆºå®¢"**ï¼š
   - åˆ›å»ºè®°å½•ï¼š`card_character_id=4, current_star_level=1, quantity=1`

3. **å†è´­ä¹°2ä¸ª"æš—å½±åˆºå®¢"**ï¼š
   - æ›´æ–°è®°å½•ï¼š`card_character_id=4, current_star_level=1, quantity=3`

4. **ç‚¹å‡»å‡æ˜Ÿ**ï¼š
   - æ¶ˆè€—3ä¸ª1æ˜Ÿè§’è‰²ï¼š`quantity=0`ï¼ˆåˆ é™¤è®°å½•ï¼‰
   - åˆ›å»ºæ–°è®°å½•ï¼š`card_character_id=4, current_star_level=2, quantity=1`
   - åº”ç”¨å±æ€§å¢å¹…ï¼šæ ¹æ® `star_upgrade_payload` è®¡ç®—

5. **å†è´­ä¹°1ä¸ª"æš—å½±åˆºå®¢"**ï¼š
   - åˆ›å»ºæ–°è®°å½•ï¼š`card_character_id=4, current_star_level=1, quantity=1`
   - æ³¨æ„ï¼šä¸ä¼šæ·»åŠ åˆ°2æ˜Ÿè®°å½•çš„æ•°é‡ä¸Š

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æŸ¥è¯¢æ¡ä»¶**ï¼šæ‰€æœ‰æ¶‰åŠè§’è‰²æŸ¥è¯¢çš„åœ°æ–¹ï¼Œéƒ½éœ€è¦åŒæ—¶ä½¿ç”¨ `card_character_id` å’Œ `current_star_level`

2. **å±æ€§è®¡ç®—**ï¼šå‡æ˜Ÿåçš„å±æ€§éœ€è¦æ ¹æ® `star_upgrade_payload` åŠ¨æ€è®¡ç®—ï¼Œè€Œä¸æ˜¯ç›´æ¥å­˜å‚¨

3. **ç‰¹æ€§å¢å¹…**ï¼šç‰¹æ€§å¢å¹…åœ¨æˆ˜æ–—æ—¶æ ¹æ®æ˜Ÿçº§åŠ¨æ€è®¡ç®—ï¼Œä¸éœ€è¦åœ¨æ•°æ®åº“ä¸­å­˜å‚¨

4. **äº‹åŠ¡å¤„ç†**ï¼šå‡æ˜Ÿæ“ä½œéœ€è¦äº‹åŠ¡ä¿è¯ï¼Œç¡®ä¿æ¶ˆè€—å’Œåˆ›å»ºæ“ä½œçš„åŸå­æ€§

## âœ… å®ç°å®Œæˆï¼ˆ2025-12-04ï¼‰

### å·²å®Œæˆçš„ä¿®æ”¹

1. **ä¿®æ”¹è´­ä¹°é€»è¾‘**ï¼š
   - âœ… ä¿®æ”¹äº† `ShopService.addCardCharacterToUser()` æ–¹æ³•
   - âœ… è´­ä¹°è§’è‰²æ—¶ï¼Œåªæ·»åŠ åˆ°1æ˜Ÿè§’è‰²çš„æ•°é‡ä¸Šï¼ˆæŸ¥è¯¢æ¡ä»¶åŒ…å« `current_star_level = 1`ï¼‰
   - âœ… ç¡®ä¿è´­ä¹°çš„è§’è‰²ä¸ä¼šæ·»åŠ åˆ°æ›´é«˜æ˜Ÿçº§çš„è§’è‰²æ•°é‡ä¸Š

2. **å®ç°å‡æ˜ŸåŠŸèƒ½**ï¼š
   - âœ… åœ¨ `UserCardCharacterService` ä¸­æ·»åŠ äº† `upgradeStarLevel()` æ–¹æ³•
   - âœ… å®ç°äº†æ¶ˆè€—3ä¸ªå½“å‰æ˜Ÿçº§è§’è‰²ï¼Œåˆ›å»ºæ–°çš„æ›´é«˜æ˜Ÿçº§è®°å½•çš„é€»è¾‘
   - âœ… å®ç°äº†æ ¹æ® `star_upgrade_payload` è®¡ç®—å±æ€§å¢å¹…çš„é€»è¾‘
   - âœ… æ·»åŠ äº†äº‹åŠ¡æ”¯æŒï¼Œç¡®ä¿æ“ä½œçš„åŸå­æ€§

3. **æ·»åŠ Controlleræ¥å£**ï¼š
   - âœ… åœ¨ `UserCardCharacterController` ä¸­æ·»åŠ äº† `POST /user-card-characters/{id}/upgrade-star` æ¥å£

### ä½¿ç”¨æ–¹æ³•

1. **è´­ä¹°è§’è‰²**ï¼š
   - è´­ä¹°è§’è‰²æ—¶ï¼Œä¼šè‡ªåŠ¨æ·»åŠ åˆ°1æ˜Ÿè§’è‰²çš„æ•°é‡ä¸Š
   - å¦‚æœå·²æœ‰1æ˜Ÿè§’è‰²è®°å½•ï¼Œå¢åŠ æ•°é‡
   - å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºæ–°çš„1æ˜Ÿè§’è‰²è®°å½•

2. **å‡æ˜Ÿæ“ä½œ**ï¼š
   ```bash
   POST /user-card-characters/{id}/upgrade-star
   ```
   - éœ€è¦æä¾›è¦å‡æ˜Ÿçš„è§’è‰²è®°å½•ID
   - ç³»ç»Ÿä¼šæ£€æŸ¥æ•°é‡æ˜¯å¦ >= 3
   - æ¶ˆè€—3ä¸ªå½“å‰æ˜Ÿçº§çš„è§’è‰²
   - åˆ›å»ºæ–°çš„æ›´é«˜æ˜Ÿçº§è®°å½•ï¼ˆå¦‚æœå·²æœ‰è¯¥æ˜Ÿçº§è®°å½•ï¼Œåˆ™å¢åŠ æ•°é‡ï¼‰

3. **æ•°æ®éš”ç¦»**ï¼š
   - æ¯ä¸ªæ˜Ÿçº§æ˜¯ç‹¬ç«‹çš„è®°å½•
   - 1æ˜Ÿè§’è‰²å’Œ2æ˜Ÿè§’è‰²æ˜¯ä¸åŒçš„è®°å½•
   - è´­ä¹°1æ˜Ÿè§’è‰²ä¸ä¼šå½±å“2æ˜Ÿè§’è‰²çš„æ•°é‡

### ç¤ºä¾‹æµç¨‹

1. **è´­ä¹°3ä¸ª"æš—å½±åˆºå®¢"**ï¼š
   - åˆ›å»ºè®°å½•ï¼š`card_character_id=4, current_star_level=1, quantity=3`

2. **ç‚¹å‡»å‡æ˜Ÿ**ï¼š
   - æ¶ˆè€—3ä¸ª1æ˜Ÿè§’è‰²ï¼šåˆ é™¤æˆ–å‡å°‘æ•°é‡
   - åˆ›å»ºæ–°è®°å½•ï¼š`card_character_id=4, current_star_level=2, quantity=1`
   - åº”ç”¨å±æ€§å¢å¹…ï¼šæ ¹æ® `star_upgrade_payload` è®¡ç®—

3. **å†è´­ä¹°1ä¸ª"æš—å½±åˆºå®¢"**ï¼š
   - åˆ›å»ºæ–°è®°å½•ï¼š`card_character_id=4, current_star_level=1, quantity=1`
   - ä¸ä¼šæ·»åŠ åˆ°2æ˜Ÿè®°å½•çš„æ•°é‡ä¸Š

---

**æœ€åæ›´æ–°**ï¼š2025-12-04  
**ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ

