# æŠ€èƒ½ç³»ç»Ÿè¡¨ç»“æ„ä¼˜åŒ–è¯´æ˜

## ğŸ“‹ ä¿®æ”¹æ¦‚è¿°

å°† `user_player_character_skills` è¡¨ä»å…³è”**è§’è‰²å®ä¾‹ID**æ”¹ä¸ºå…³è”**ç”¨æˆ·ID + èŒä¸šæ¨¡æ¿ID**ï¼Œä½¿æŠ€èƒ½è§£é”æˆä¸ºç”¨æˆ·å¯¹èŒä¸šçš„æ°¸ä¹…æŠ•èµ„ï¼Œå³ä½¿åˆ é™¤é‡å»ºè§’è‰²å®ä¾‹ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚

## ğŸ”„ è¡¨ç»“æ„å˜æ›´

### æ—§è¡¨ç»“æ„
```sql
CREATE TABLE user_player_character_skills (
    id                     BIGINT    NOT NULL AUTO_INCREMENT PRIMARY KEY,
    user_player_character_id BIGINT  NOT NULL,  -- å…³è”åˆ°è§’è‰²å®ä¾‹ID
    skill_id               BIGINT    NOT NULL,
    unlocked_at            TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

### æ–°è¡¨ç»“æ„
```sql
CREATE TABLE user_player_character_skills (
    id                     BIGINT    NOT NULL AUTO_INCREMENT PRIMARY KEY,
    user_id                BIGINT    NOT NULL COMMENT 'ç”¨æˆ·ID',
    player_character_id     BIGINT    NOT NULL COMMENT 'èŒä¸šæ¨¡æ¿ID',
    skill_id               BIGINT    NOT NULL COMMENT 'æŠ€èƒ½æ¨¡æ¿ID',
    unlocked_at            TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_character_skill (user_id, player_character_id, skill_id),
    INDEX idx_user_character (user_id, player_character_id),
    INDEX idx_skill (skill_id),
    CONSTRAINT fk_ups_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_ups_character FOREIGN KEY (player_character_id) REFERENCES player_characters(id) ON DELETE CASCADE,
    CONSTRAINT fk_ups_skill FOREIGN KEY (skill_id) REFERENCES skills(id) ON DELETE CASCADE
);
```

## ğŸ“ ä»£ç ä¿®æ”¹æ¸…å•

### 1. æ•°æ®åº“è„šæœ¬
- âœ… `database/migrate_skill_table.sql` - æ–°å»ºè¿ç§»è„šæœ¬
- âœ… `database/migrate_uuid_to_auto_increment.sql` - æ›´æ–°è¡¨ç»“æ„å®šä¹‰

### 2. å®ä½“ç±»
- âœ… `UserPlayerCharacterSkill.java`
  - åˆ é™¤ï¼š`userPlayerCharacterId` å­—æ®µ
  - æ–°å¢ï¼š`userId` å’Œ `playerCharacterId` å­—æ®µ

### 3. Mapper
- âœ… `UserPlayerCharacterSkillMapper.java`
  - åˆ é™¤ï¼š`selectByUserPlayerCharacterId()` æ–¹æ³•
  - æ–°å¢ï¼š`selectByUserIdAndPlayerCharacterId()` æ–¹æ³•

### 4. Serviceå±‚
- âœ… `SkillService.java`
  - `getSkillTreeByPlayerCharacterCode()`: æ”¹ä¸ºä½¿ç”¨ `user_id + player_character_id` æŸ¥è¯¢
  - `getUserUnlockedSkills()`: æ”¹ä¸ºä½¿ç”¨ `user_id + player_character_id` æŸ¥è¯¢
  - `unlockSkill()`: æ”¹ä¸ºä½¿ç”¨ `user_id + player_character_id` æ’å…¥

### 5. DTO
- âœ… `UnlockSkillRequest.java`
  - åˆ é™¤ï¼š`userPlayerCharacterId` å­—æ®µï¼ˆä¸å†éœ€è¦ï¼‰

### 6. Controller
- âœ… `SkillController.java`
  - æ›´æ–°æ³¨é‡Šè¯´æ˜

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1ï¼šå¤‡ä»½æ•°æ®ï¼ˆå¦‚æœæœ‰ç°æœ‰æ•°æ®ï¼‰
```sql
CREATE TABLE user_player_character_skills_backup AS 
SELECT * FROM user_player_character_skills;
```

### æ­¥éª¤2ï¼šæ‰§è¡Œè¿ç§»è„šæœ¬
```bash
# æ‰§è¡Œè¿ç§»è„šæœ¬
mysql -u username -p database_name < database/migrate_skill_table.sql
```

### æ­¥éª¤3ï¼šè¿ç§»ç°æœ‰æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
å¦‚æœè¡¨ä¸­æœ‰ç°æœ‰æ•°æ®ï¼Œéœ€è¦æ‰§è¡Œæ•°æ®è¿ç§»ï¼š
```sql
INSERT INTO user_player_character_skills (user_id, player_character_id, skill_id, unlocked_at)
SELECT 
    upc.user_id,
    upc.player_character_id,
    upcs_old.skill_id,
    upcs_old.unlocked_at
FROM user_player_character_skills_backup upcs_old
INNER JOIN user_player_characters upc ON upcs_old.user_player_character_id = upc.id;
```

### æ­¥éª¤4ï¼šéªŒè¯
1. æ£€æŸ¥è¡¨ç»“æ„æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥æ•°æ®æ˜¯å¦è¿ç§»æˆåŠŸ
3. æµ‹è¯•æ¥å£åŠŸèƒ½

## âœ… ä¼˜åŒ–æ•ˆæœ

### ä¼˜ç‚¹
1. **æ•°æ®æŒä¹…åŒ–**ï¼šæŠ€èƒ½è§£é”ä¸ä¼šå› ä¸ºåˆ é™¤é‡å»ºè§’è‰²è€Œä¸¢å¤±
2. **ä¸šåŠ¡é€»è¾‘æ›´æ¸…æ™°**ï¼šæŠ€èƒ½è§£é”æ˜¯ç”¨æˆ·å¯¹èŒä¸šçš„æŠ•èµ„ï¼Œè€Œä¸æ˜¯è§’è‰²å®ä¾‹çš„å±æ€§
3. **æŸ¥è¯¢æ›´é«˜æ•ˆ**ï¼šç›´æ¥é€šè¿‡ `user_id + player_character_id` æŸ¥è¯¢ï¼Œæ— éœ€å…³è”è§’è‰²å®ä¾‹è¡¨
4. **æ”¯æŒå¤šèŒä¸š**ï¼šå¦‚æœå°†æ¥æ”¯æŒç”¨æˆ·æ‹¥æœ‰å¤šä¸ªèŒä¸šï¼Œæ¯ä¸ªèŒä¸šçš„æŠ€èƒ½è§£é”æ˜¯ç‹¬ç«‹çš„

### æ³¨æ„äº‹é¡¹
1. å¦‚æœè¡¨ä¸­æœ‰ç°æœ‰æ•°æ®ï¼Œå¿…é¡»æ‰§è¡Œæ•°æ®è¿ç§»
2. ç¡®ä¿å¤–é”®çº¦æŸæ­£ç¡®ï¼ˆusersã€player_charactersã€skills è¡¨å¿…é¡»å­˜åœ¨ï¼‰
3. å”¯ä¸€çº¦æŸ `uk_user_character_skill` é˜²æ­¢é‡å¤è§£é”

## ğŸ” æ¥å£å˜æ›´

### æ— å˜æ›´çš„æ¥å£
- `GET /api/skills/{playerCharacterCode}` - è·å–æŠ€èƒ½æ ‘
- `GET /api/user-skills` - è·å–å·²è§£é”æŠ€èƒ½

### å˜æ›´çš„æ¥å£
- `POST /api/user-skills/unlock`
  - **è¯·æ±‚ä½“å˜æ›´**ï¼šä¸å†éœ€è¦ `userPlayerCharacterId` å­—æ®µ
  - **æ—§è¯·æ±‚**ï¼š`{ "skillId": 10, "userPlayerCharacterId": 3 }`
  - **æ–°è¯·æ±‚**ï¼š`{ "skillId": 10 }`

## ğŸ“Š æ•°æ®å…³ç³»å›¾

### æ—§è®¾è®¡
```
user_player_characters (è§’è‰²å®ä¾‹)
  â””â”€ id = 3
      â””â”€ user_player_character_skills
          â””â”€ user_player_character_id = 3
```

### æ–°è®¾è®¡
```
users (ç”¨æˆ·)
  â””â”€ id = 1
      â””â”€ user_player_character_skills
          â”œâ”€ user_id = 1
          â””â”€ player_character_id = 1 (èŒä¸šæ¨¡æ¿)
```

## ğŸ¯ æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–å°†æŠ€èƒ½è§£é”ä»"è§’è‰²å®ä¾‹çº§åˆ«"æå‡åˆ°"ç”¨æˆ·+èŒä¸šçº§åˆ«"ï¼Œä½¿è®¾è®¡æ›´åŠ å¥å£®å’Œç¬¦åˆä¸šåŠ¡é€»è¾‘ã€‚æ‰€æœ‰ç›¸å…³ä»£ç å·²åŒæ­¥æ›´æ–°ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

